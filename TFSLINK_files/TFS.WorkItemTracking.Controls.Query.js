//----------------------------------------------------------
// Copyright (C) Microsoft Corporation. All rights reserved.
//----------------------------------------------------------
var __extends=this.__extends||function(b,a){for(var c in a)if(a.hasOwnProperty(c))b[c]=a[c];function d(){this.constructor=b}d.prototype=a.prototype;b.prototype=new d};define(["require","exports","Presentation/Scripts/TFS/TFS","Presentation/Scripts/TFS/TFS.Core","Presentation/Scripts/TFS/TFS.OM","WorkItemTracking/Scripts/TFS.WorkItemTracking","Presentation/Scripts/TFS/Generated/TFS.WorkItemTracking.Constants","WorkItemTracking/Scripts/TFS.WorkItemTracking.Controls","Presentation/Scripts/TFS/TFS.Host","Presentation/Scripts/TFS/TFS.UI.Controls","Presentation/Scripts/TFS/TFS.UI.Controls.Navigation","WorkItemTracking/Scripts/TFS.WorkItemTracking.Controls.Accessories","Presentation/Scripts/TFS/TFS.UI.Controls.Common","Presentation/Scripts/TFS/TFS.UI.Controls.Validation","Presentation/Scripts/TFS/Resources/TFS.Resources.Common","Presentation/Scripts/TFS/TFS.UI.Controls.Grids","Presentation/Scripts/TFS/TFS.UI.Controls.Menus","Presentation/Scripts/TFS/TFS.Core.Utils","Presentation/Scripts/TFS/Resources/TFS.Resources.WorkItemTracking","Presentation/Scripts/TFS/Resources/TFS.Resources.WorkItemTracking.Common","Presentation/Scripts/TFS/TFS.Diag","WorkItemTracking/Scripts/TFS.UI.Tags","Presentation/Scripts/TFS/TFS.Search","Presentation/Scripts/TFS/Generated/TFS.Server.WebAccess.Constants","Admin/Scripts/TFS.Admin.SendMail"],function(db,j,h,e,g,c,C,E,k,d,Z,L,i,z,r,eb,x,F,a,q,b,V,W,S,T){j.HOMEPAGE_PINNING_AREA="HomePagePinning";var o=i.CommonMenuItems,D=h.handleError,B=h.getErrorMessage,l=k.TfsContext,H=b.assert,f=e.delegate,p=c.LinkQueryMode,bb=c.WiqlOperators,cb=c.QueryAdapter;(function(a){a.ACTION_WORKITEMQUERY_SAVEAS="TFS.WorkItemTracking.Controls.Query.work-item-query-save-as"})(j.WorkItemQueryAction||(j.WorkItemQueryAction={}));var Y=j.WorkItemQueryAction,m=function(){function a(a){this.options=a||{}}a.prototype.getId=function(){return null};a.prototype.getVersion=function(){return this._version};a.prototype._incrementVersion=function(){this._version=this._version+1};a.prototype.getTitle=function(){return""};a.prototype.beginGetResults=function(){};a.prototype.isDirty=function(){return this._dirty===true};a.prototype.setDirty=function(b,c){if(this.isEditable&&this._dirty!==b){this._dirty=b;if(!c){!this.options.suppressGlobalFire&&$(window).trigger("query-provider-dirty-state-changed",this);this._fireEvent(a.EVENT_CHANGED,this,{change:"dirtyState"})}}};a.prototype.isEditable=function(){return false};a.prototype.invalidateResults=function(){this.resultsValid=false};a.prototype.setColumnWidth=function(){};a.prototype.setColumns=function(){};a.prototype.setSortColumns=function(){};a.prototype.fire=function(b,c,a){return this._fireEvent(b,c,a)};a.prototype._fireEvent=function(c,d,f){var b,a;if(this._events){a=this._events._getEvent(c);if(!a||a.length===0)return undefined;a=e.ArrayUtils.clone(a);for(b=a.length-1;b>=0;b--)if(a[b](d||this,f)===false)return false}};a.prototype.attachEvent=function(a,b){if(!this._events)this._events=new Sys.EventHandlerList;this._events.addHandler(a,b)};a.prototype.detachEvent=function(a,b){this._events&&this._events.removeHandler(a,b)};a.EVENT_REFRESH_REQUIRED="refresh-required";a.EVENT_CHANGED="changed";return a}();j.WorkItemsProvider=m;h.initClassPrototype(m,{options:null,resultsValid:false,queryEditable:false,_dirty:false,_version:0,_events:null});var n=function(f){__extends(d,f);function d(b,a){f.call(this,a);this.queryEditable=true;this.project=a&&a.project||b.project;this.update(b)}d._createInstance=function(a,c){var b;this._specialProviders&&$.each(this._specialProviders,function(d,c){if(c.supports(a)){b=c;return false}});return b?new b(a,c):new d(a,c)};d._deleteCachedProviders=function(a){var b=this;delete this._providerCache[a.id||a.name];$.each(a.children||[],function(c,a){b._deleteCachedProviders(a)})};d._updateCachedProviders=function(a){var b=this;$.each(this.getCachedProviders(),function(e,c){var d;if(c.project===a.project){d=a.findQueryById(c.getId());if(d)c.reset(d);else if(!(c instanceof I))delete b._providerCache[c.getId()]}})};d.beginSaveBatch=function(e,d,j){var b,a,f,g,h=this;function i(d,c){var e=d.slice(0),b=[];function a(){var d=e.shift();if(d)d.beginGetQueryText(function(c){d.queryDefinition.setQuery(c);b.push(d);a()},function(b){d.update(d.queryDefinition,b);a()});else c(b)}a()}function c(){var a=f.shift();if(g)D(g,j,h);else if(a)i(a,function(a){if(a&&a.length)a[0].project.beginSaveQueries($.map(a,function(a){return a.queryDefinition}),function(b,d){$.each(b,function(b,c){a[b].update(c,d[b])});c()},function(b){$.each(a,function(c,a){a.update(a.queryDefinition,b)});c()});else c()});else $.isFunction(d)&&d.call(h)}if(e&&e.length)b=$.map(e,function(a){if(a.isDirty()&&a.queryDefinition)return a});if(b&&b.length){a={};f=[];$.each(b,function(d,b){var c;if(b.queryDefinition.project.id in a)a[b.queryDefinition.project.id].push(b);else{c=[b];f.push(c);a[b.queryDefinition.project.id]=c}});c()}else $.isFunction(d)&&d.call(this)};d.registerSpecialProvider=function(a){this._specialProviders=this._specialProviders||[];this._specialProviders.push(a)};d.get=function(c,i,f,h,g){var a,b=this._providerCache,e=this,d=c.id||c.name;a=b&&b[d];if(!a&&!f){if(!b){this._providerCache=b={};if(!h){$(window).bind("query-item-removed",function(b,a){e._deleteCachedProviders(a)});$(window).bind("query-hierarchy-refreshed",function(b,a){e._updateCachedProviders(a)});k.runningDocumentsTable.add("QueryResultsProvider",this)}}a=this._createInstance(c,i);if(!g)b[d]=a}return a};d.peek=function(a){return this._providerCache?typeof a==="string"?this._providerCache[a]:this._providerCache[a.id||a.name]:null};d.getCachedProviders=function(){var a=[],b=this._providerCache;b&&$.each(b,function(c,b){a.push(b)});return a};d.getDirtyProviders=function(){return $.map(this.getCachedProviders(),function(a){if(a.isDirty())return a})};d.isDirty=function(){var b=false,a=this._providerCache;a&&$.each(a,function(c,a){if(a&&a.isDirty()){b=true;return false}});return b};d.getDirtyDocumentTitles=function(d){var b=[],c=this.getDirtyProviders();$.each(c,function(f,c){if(c.getTitle){b.push(e.StringUtils.format(a.QueryDirtyDocumentTitleFormat,c.getTitle()));if(b.length===d)return false}});return b};d.beginSave=function(b,a){return this.saveDirtyProviders(b,a)};d.saveDirtyProviders=function(b,d){var a=[],e=this._providerCache,c=true;if(e){$.each(this.getDirtyProviders(),function(c,b){(b.getId()||b.queryDefinition&&b.queryDefinition.path().indexOf("/")>0)&&a.push(b)});if(a.length){c=false;this.beginSaveBatch(a,b,d)}}c&&$.isFunction(b)&&b.call(this)};d.prototype.getId=function(){return this.queryDefinition.id};d.prototype.getTitle=function(){return this.queryDefinition.name};d.prototype.isEditable=function(){return this.getId()&&(!this.queryDefinition.specialQuery||c.QueryDefinition.isCustomizableSpecialQuery(this.queryDefinition))};d.prototype.beginGetResults=function(b,f,e){var a=this,d,c;function g(c){if(a.queryResultsModel){delete a.queryResultsModel.payload;delete a.queryResultsModel.pageColumns;a.queryResultsModel.sourceIds=[];a.queryResultsModel.targetIds=[];a.queryResultsModel.isLinkQuery=p.isLinkQuery(a.queryResultsModel.editInfo.mode);a.queryResultsModel.isTreeQuery=p.isTreeQuery(a.queryResultsModel.editInfo.mode);a.queryResultsModel.error=c;a._updateModel(a.queryResultsModel);$.isFunction(b)&&b.call(a,a.queryResultsModel)}else D(c,f||a.options.errorCallback,a)}if(this._hasResults())$.isFunction(b)&&b.call(this,$.extend({queryRan:e},this.queryResultsModel));else{d=this.getColumns();c=this.getSortColumns();this._beginQuery(function(c){a._updateModel(c);$.isFunction(b)&&b.call(a,c)},g,{fields:d&&d.length?d:undefined,sortFields:c&&c.length?c:undefined,runQuery:e,persistenceId:a.queryDefinition&&a.queryDefinition.id})}};d.prototype._beginQuery=function(b,a,c){var d=this;this.beginGetQueryText(function(e){d.project.beginQuery(e,b,a,c)},a)};d.prototype.beginGetQueryText=function(a,c){var b=this;if(this.queryResultsModel)if(this.isDirty())this.project.store.tfsConnection.getService(cb).beginGenerateWiql(this.queryResultsModel.editInfo,$.map(this.queryResultsModel.columns,function(a){return a.name}),this.queryResultsModel.sortColumns,a,c);else $.isFunction(a)&&a.call(this,this.queryResultsModel.wiql);else $.isFunction(a)&&a.call(b,b.originalQuery)};d.prototype.revertEditInfo=function(){if(this.queryResultsModel){this.queryResultsModel.wiql=this.originalQuery;this.queryResultsModel.editInfo=$.extend(true,{},this.originalEditInfo);this.queryResultsModel.columns=(this.originalColumns||[]).slice(0);this.queryResultsModel.sortColumns=(this.originalSortColumns||[]).slice(0);this.invalidateResults();this._incrementVersion();this.setDirty(false);this._fireEvent(d.EVENT_QUERY_RESULTS_MODEL_CHANGED)}};d.prototype.getColumns=function(){return this.queryResultsModel?$.map(this.queryResultsModel.columns||[],function(a){return a.width>=0?a.name+";"+a.width:a.name}):[]};d.prototype.getSortColumns=function(){return this.queryResultsModel?$.map(this.queryResultsModel.sortColumns||[],function(a){return a.name+(a.descending?";desc":";asc")}):[]};d.prototype._updateModel=function(a){if(a){if(!this.originalEditInfo){this.originalQuery=a.wiql;this.originalEditInfo=$.extend(true,{},a.editInfo);this.originalColumns=(a.columns||[]).slice(0);this.originalSortColumns=(a.sortColumns||[]).slice(0)}}else{this.originalEditInfo=null;this.originalColumns=null;this.originalSortColumns=null}this.queryResultsModel=a;this.resultsValid=true;this._incrementVersion();this._fireEvent(d.EVENT_QUERY_RESULTS_MODEL_CHANGED)};d.prototype.update=function(a,b){this.queryDefinition=a;this.originalQuery=a.queryText;if(this.queryResultsModel)if(b){this.queryResultsModel.error=b;this.resultsValid=true;this.setDirty(true);this._fireEvent(m.EVENT_REFRESH_REQUIRED)}else{this.queryResultsModel.wiql=this.originalQuery;this.originalEditInfo=$.extend(true,{},this.queryResultsModel.editInfo);this.originalColumns=(this.queryResultsModel.columns||[]).slice(0);this.originalSortColumns=(this.queryResultsModel.sortColumns||[]).slice(0);this.setDirty(a.isDirty)}else this.setDirty(a.isDirty);this._incrementVersion();this._fireEvent(m.EVENT_CHANGED,this,{change:"queryDefinition"})};d.prototype.reset=function(b,a){this.queryResultsModel=null;this.invalidateResults();this.update(b);!a&&this._fireEvent(m.EVENT_REFRESH_REQUIRED)};d.prototype.setColumns=function(a){var d,c,b,f;if(this.queryResultsModel){a=a||[];d=this.queryResultsModel.columns||[];if(a.length!==d.length)c=true;else for(b=0,f=a.length;b<f;b++)if(e.StringUtils.ignoreCaseComparer(a[b].name,d[b].name)!==0){c=true;break}this.queryResultsModel.columns=a;if(c){this._incrementVersion();this.setDirty(true);this._fireEvent(m.EVENT_CHANGED,this,{change:"columns",oldColumns:d,newColumns:a})}}return c};d.prototype.setSortColumns=function(a){var d,c,b,f;if(this.queryResultsModel){a=a||[];d=this.queryResultsModel.sortColumns||[];if(a.length!==d.length)c=true;else for(b=0,f=a.length;b<f;b++){if(e.StringUtils.ignoreCaseComparer(a[b].name,d[b].name)!==0){c=true;break}if(Boolean(a[b].descending)!==Boolean(d[b].descending)){c=true;break}}this.queryResultsModel.sortColumns=a;if(c){this._incrementVersion();this.setDirty(true);this._fireEvent(m.EVENT_CHANGED,this,{change:"sortColumns",oldColumns:d,newColumns:a})}}return c};d.prototype.setColumnWidth=function(a,b){if(this.queryResultsModel&&this.queryResultsModel.columns){$.each(this.queryResultsModel.columns,function(d,c){if(e.StringUtils.ignoreCaseComparer(a,c.name)===0)c.width=b});!this.options.skipPersistingColumnResize&&this.queryDefinition&&this.queryDefinition.id&&this.project.beginUpdateColumnOptions(this.queryDefinition.id,[a+";"+b],null,this.options.errorCallback)}this._incrementVersion()};d.prototype.beginSave=function(a,c){var e=this;if(!a)a=function(){var a=e.queryResultsModel.error;if(a&&a.message)h.errorHandler.showError(a.message);else b.logTracePoint("QueryResultGrid.saveQuery.complete")};d.beginSaveBatch([this],a,c)};d.prototype._hasResults=function(){return this.resultsValid&&this.queryResultsModel};d._providerCache=null;d._specialProviders=null;d.EVENT_QUERY_RESULTS_MODEL_CHANGED="query-results-model-changed";return d}(m);j.QueryResultsProvider=n;h.initClassPrototype(n,{project:null,originalQuery:null,queryDefinition:null,queryResultsModel:null,originalEditInfo:null,originalColumns:null,originalSortColumns:null});var I=function(b){__extends(a,b);function a(a,c){b.call(this,a,c);this.project=a.project}a.supports=function(a){return c.QueryDefinition.isSearchResults(a)};a.prototype.newSearch=function(a){this.searchText=a;this.searchDone=false;this.invalidateResults();this._incrementVersion()};a.prototype.getTitle=function(){return this.searchText?e.StringUtils.format("{0}: {1}",this.queryDefinition.name,this.searchText):b.prototype.getTitle.call(this)};a.prototype._beginQuery=function(a,c,e){var d=this;if(this.searchText)if(this.searchDone)b.prototype._beginQuery.call(this,a,c,e);else this.project.beginSearch(this.searchText,function(b){d.searchDone=true;$.isFunction(a)&&a.call(d,b)},c);else $.isFunction(a)&&a.call(this,{columns:[],pageColumns:[],sortColumns:[],sourceIds:[],targetIds:[]})};return a}(n);j.SearchResultsProvider=I;h.initClassPrototype(I,{searchText:null,searchDone:false});n.registerSpecialProvider(I);var P=function(b){__extends(a,b);function a(a,c){b.call(this,a,c);this._workItemManager=a.project.store.workItemManager;this._workItemManager.attachWorkItemChanged(e.throttledDelegate(this,250,this._workItemChanged))}a.supports=function(a){return c.QueryDefinition.isUnsavedWorkItems(a)};a.prototype._beginQuery=function(c,a,f){var e=this;function d(b){var d,g,f;if($.isFunction(c))try{d=[];g=[];$.each(e._workItemManager.getManagedWorkItems(),function(b,a){a.isDirty()&&g.push(a)});f={rows:[]};$.each(g,function(b,a){d[d.length]=a.getUniqueId();f.rows[f.rows.length]=[a.getUniqueId()]});b.allowSort=false;b.keepSelection=true;b.payload=f;b.targetIds=d;c.call(this,b)}catch(h){D(h,a,this)}}if(!this.queryResultsModel||this._needModel)b.prototype._beginQuery.call(this,function(a){e._needModel=false;d(a)},a,f);else d(this.queryResultsModel)};a.prototype._updateModel=function(a){if(!a)this._needModel=true;b.prototype._updateModel.call(this,a)};a.prototype.setColumns=function(a){if(b.prototype.setColumns.call(this,a))this._needModel=true};a.prototype.setSortColumns=function(a){if(b.prototype.setSortColumns.call(this,a))this._needModel=true};a.prototype._workItemChanged=function(){this.resultsValid=false;this._incrementVersion();this._fireEvent(m.EVENT_REFRESH_REQUIRED)};return a}(n);h.initClassPrototype(P,{_workItemManager:null,_needModel:true});n.registerSpecialProvider(P);var v=function(){function c(a){this.options=a||{}}c.prototype.isNextAvailable=function(){return this._workItemsProvider!==null&&this._selectedIndex>=0&&this._selectedIndex<this._count-1};c.prototype.isPreviousAvailable=function(){return this._workItemsProvider!==null&&this._selectedIndex>0&&this._selectedIndex<this._count};c.prototype.getStatusText=function(){return this._workItemsProvider===null||this._selectedIndex<0||this._count<0||this._selectedIndex>this._count-1?"":e.StringUtils.format(a.TriageSummary,this._selectedIndex+1,this._count)};c.prototype.navigateNext=function(){this.isNextAvailable()&&this._fireEvent(c.EVENT_NAVIGATE_NEXT)};c.prototype.navigatePrevious=function(){this.isPreviousAvailable()&&this._fireEvent(c.EVENT_NAVIGATE_PREVIOUS)};c.prototype.setProvider=function(a){if(this._workItemsProvider!==a){this._workItemsProvider=a;this.update(-1,-1,-1)}};c.prototype.getProvider=function(){return this._workItemsProvider};c.prototype.update=function(d,e,a){b.assertParamIsInteger(d,"count");b.assertParamIsInteger(e,"index");b.assertParamIsInteger(a,"workItemId");this._count=d;this._selectedIndex=e;this._workItemId=a;this._fireEvent(c.EVENT_NAVIGATE_INDEX_CHANGED)};c.prototype.fire=function(b,c,a){return this._fireEvent(b,c,a)};c.prototype._fireEvent=function(c,d,f){var b,a;if(this._events){a=this._events._getEvent(c);if(!a||a.length===0)return undefined;a=e.ArrayUtils.clone(a);for(b=a.length-1;b>=0;b--)if(a[b](d||this,f)===false)return false}};c.prototype.attachEvent=function(a,b){if(!this._events)this._events=new Sys.EventHandlerList;this._events.addHandler(a,b)};c.prototype.detachEvent=function(a,b){this._events&&this._events.removeHandler(a,b)};c.EVENT_NAVIGATE_INDEX_CHANGED="navigate-index-changed";c.EVENT_NAVIGATE_NEXT="navigate-next";c.EVENT_NAVIGATE_PREVIOUS="navigate-previous";return c}();j.WorkItemsNavigator=v;h.initClassPrototype(v,{options:null,_workItemsProvider:null,_selectedIndex:-1,_count:-1,_workItemId:-1,_events:null});var s=function(i){__extends(d,i);function d(a){i.call(this,a);this._refreshDelegate=f(this,this.refresh);this._workItemChangedDelegate=f(this,this.workItemChanged);this._navigateNextDelegate=f(this,this._onNavigateNext);this._navigatePreviousDelegate=f(this,this._onNavigatePrevious);this._workItemsNeeded=[];this._links=[];this._displayColumns=[];this._sortColumns=[];this._rootCount=0;this._pageColumns=[];this._pageColumnMap={};this._pageData={}}d.calculateExpandStates=function(h,i,c,m,a,k){var f=0,e=0,j=0,g,l,b;while(a<k){c[a]=0;g=h[a];l=i[a];if(g===m){f++;a++;j++}else if(g===e){b=d.calculateExpandStates(h,i,c,e,a,k);c[a-1]=b.total;f+=b.total;a+=b.total}else break;e=l}return{total:f,root:j}};d.prototype.initializeOptions=function(e){var h=this,g=true,b;function c(){return h._onGetMenuItemActionArguments(this)}if(e.showContextMenu===false)g=false;b=[{rank:10,id:"open-work-item",text:a.Open,title:a.OpenToolTip,icon:"icon-open",arguments:c},{rank:15,separator:true},{rank:20,id:"use-as-a-template",text:a.UseWorkItemAsATemplate,title:a.UseWorkItemAsATemplateToolTip,arguments:c},{rank:30,id:"create-copy",text:a.CreateCopyOfWorkItem,title:a.CreateCopyOfWorkItemToolTip,icon:"icon-tfs-work-item-copy",arguments:c},{rank:60,separator:true},{rank:61,id:"copy-selection",text:a.CopySelectedWorkItems,title:a.CopySelectedWorkItemsToolTip,icon:"icon-copy",arguments:c}];if(!e.readOnlyMode){b.push({rank:13,id:"bulk-edit-workitems",text:a.BulkEditSelectedWorkItems,title:a.BulkEditSelectedWorkItemsTooltip,icon:"icon-edit"});if(e.tfsContext.standardAccessMode===true){b.push({rank:35,separator:true});b.push({rank:40,id:"link-to-new",text:a.LinkSelectedItemsToNewWorkItem,title:a.LinkSelectedItemsToNewWorkItemToolTip,icon:"icon-tfs-work-item-new-linked",arguments:c});b.push({rank:50,id:"link-to-existing",text:a.LinkToExistingItem,title:a.LinkToExistingItemToolTip,icon:"icon-tfs-link-add",arguments:c})}}b.push({rank:70,separator:true});b.push({rank:71,id:d.COMMAND_ID_EMAIL_SELECTION,text:a.EmailSelectedWorkItems,title:a.EmailSelectedWorkItemsToolTip,icon:"icon-envelope",arguments:c});i.prototype.initializeOptions.call(this,$.extend({gutter:{contextMenu:g},contextMenu:{executeAction:f(this,this.executeCommand),updateCommandStates:f(this,this._updateCommandStates),arguments:f(this,this._getDefaultActionArguments),items:b}},e))};d.prototype._enhance=function(a){a.empty();i.prototype._enhance.call(this,a)};d.prototype.getProjectName=function(){return this._projectName};d.prototype.isDirty=function(d){var c=this._managedWorkItems,b,a,e=this._store.workItemManager;if(!d)return this._getDirtyWorkItems().length>0;else for(b in c)if(c[b]===true){a=e.getWorkItem(b);if(a)if(a.isDirty())return true}return false};d.prototype.processDataSource=function(a,f){var b,e,c;if(a.sourceIds)b=a.sourceIds;if(a.linkIds)this._links=a.linkIds;else this._links=[];if(a.targetIds)if(this._filterApplied){this._unfilteredWorkItems=a.targetIds;c=this._filterManager.getMatchingWorkItems();this._workItems=this._sortAndRemoveDuplicates(c,a.targetIds)}else this._workItems=a.targetIds;else this._workItems=[];this._options.source=this._workItems;if(b){this._options.expandStates=[];e=d.calculateExpandStates(b,this.getUnfilteredWorkItemIds(),this._options.expandStates,0,0,b.length);if(this._filterApplied){this._unfilteredExpandStates=this._options.expandStates;this._options.expandStates=null}this._rootCount=e.root}else{this._options.expandStates=null;this._rootCount=this.getUnfilteredWorkItemIds().length}if(f){delete a.sourceIds;delete a.linkIds;delete a.targetIds}};d.prototype.initialize=function(){this._store=g.TfsTeamProjectCollection.getConnection(this._options.tfsContext).getService(c.WorkItemStore);this._projectName=this._options.tfsContext.navigation.project;this._store.workItemManager.attachWorkItemChanged(this._workItemChangedDelegate);this.initializeDataModel(this._options);delete this._options.payload;i.prototype.initialize.call(this)};d.prototype._dispose=function(){if(this._workItemsProvider){this._workItemsProvider.detachEvent(m.EVENT_REFRESH_REQUIRED,this._refreshDelegate);this._workItemsProvider=null}if(this._store){this._store.workItemManager.detachWorkItemChanged(this._workItemChangedDelegate);this._store=null}this.setNavigator(null);i.prototype._dispose.call(this)};d.prototype.getWorkItemTypeNameByIndex=function(a){return this.getWorkItemTypeNameById(this._workItems[a])};d.prototype.getWorkItemTypeNameById=function(d){var a,b=this._pageData[d];if(!b)return"";a=this._pageColumnMap[C.CoreFieldRefNames.WorkItemType];return typeof a==="number"?c.Field.convertValueToDisplayString(b[a]):""};d.prototype.initializeDataModel=function(a){var b,d,c,f={},e,j=[],i,h;this.processDataSource(a,false);this._allowSort=a.allowSort!==false;this._displayColumns=[];if(a.columns){i=function(f,b,d,g,c,e,a){return V.TagUtilities.renderTagCellContents(this,b,c,a)};h=function(j,d,f,m,k,i,h){var c=this._drawCell(j,d,f,m,k,i,h),a=g.ColorsProvider.getDefault();if(a.isWorkItemColorsDefined()){var e=this.getWorkItemTypeNameByIndex(d);if(e){var l=a.getPrimaryWorkItemTypeColor(e),b=$("<div/>").addClass("work-item-color").css("background-color",l);b.html("&nbsp;");b.prependTo(c)}}return c};for(b=0,d=a.columns.length;b<d;b++){c=$.extend({},a.columns[b]);c.index=b;if(!this._allowSort)c.canSortBy=false;if(c.name===C.CoreFieldRefNames.Tags){c.canSortBy=false;c.getCellContents=i}if(c.name===C.CoreFieldRefNames.Title)c.getCellContents=h;this._displayColumns[b]=c;f[c.name]=b}}this._options.columns=this._displayColumns;this._pageColumns=[];this._pageColumnMap={};if(a.pageColumns)for(b=0,d=a.pageColumns.length;b<d;b++){this._pageColumns.push(a.pageColumns[b]);this._pageColumnMap[a.pageColumns[b]]=b}this._sortColumns=[];if(a.sortColumns)for(b=0,d=a.sortColumns.length;b<d;b++){e=a.sortColumns[b];this._sortColumns.push(e);e.name in f&&j.push({index:f[e.name],order:e.descending?"desc":"asc"})}this._options.sortOrder=j;this._options.keepSelection=a.keepSelection===true;if(this._filterApplied){this._unfilteredIsLinkQuery=a.isLinkQuery;this._unfilteredIsTreeQuery=a.isTreeQuery;this._isLinkQuery=false;this._isTreeQuery=false}else{this._isLinkQuery=a.isLinkQuery;this._isTreeQuery=a.isTreeQuery}this._emptyQueryResults=a.queryRan===false;this._pageData={};this.buildCache(a.payload);this.initializeDirtyWatch();this._fetching=false;this.cancelDelayedFunction("updateWorkItemCache");this.cancelDelayedFunction("pageWorkItems")};d.prototype.updateDataModel=function(a){this.initializeDataModel(a);this.initializeDataSource();a.error&&this._statusUpdate(a.error)};d.prototype.setNavigator=function(a){if(this._workItemsNavigator!==a){if(this._workItemsNavigator){this._workItemsNavigator.detachEvent(v.EVENT_NAVIGATE_NEXT,this._navigateNextDelegate);this._workItemsNavigator.detachEvent(v.EVENT_NAVIGATE_PREVIOUS,this._navigatePreviousDelegate)}this._workItemsNavigator=a;if(this._workItemsNavigator){this._workItemsNavigator.attachEvent(v.EVENT_NAVIGATE_NEXT,f(this,this._navigateNextDelegate));this._workItemsNavigator.attachEvent(v.EVENT_NAVIGATE_PREVIOUS,this._navigatePreviousDelegate)}}};d.prototype.beginShowResults=function(d,f,e,c){b.assertParamIsObject(d,"workItemsProvider");var a=this,g=true;this._filterApplied&&this._clearCachedFilterValues();if(this._workItemsProvider!==d){this._workItemsProvider&&this._workItemsProvider.detachEvent(m.EVENT_REFRESH_REQUIRED,this._refreshDelegate);this._workItemsProvider=d;this._workItemsProvider.attachEvent(m.EVENT_REFRESH_REQUIRED,this._refreshDelegate)}else if(c&&c.keepSelection)g=!this._workItemsProvider.resultsValid||this._workItemsProviderVersion!==this._workItemsProvider.getVersion();c&&c.statusText&&this.setStatusText(c.statusText);$(this).trigger("queryResultsStarting");d.beginGetResults(function(c){a._workItemsProviderVersion=a._workItemsProvider.getVersion();if(g)a.updateDataModel(c);else{a.layout();a._statusUpdate(c.error)}$.isFunction(f)&&f.call(a,c);$(a).trigger("queryResultsComplete");b.logTracePoint("QueryResultGrid.beginShowResults.complete")},function(b){$.isFunction(e)&&e.call(a,b);$(a).trigger("queryResultsError",b)},c&&c.runQuery)};d.prototype._createContextMenu=function(b,a){L.CommonContextMenuItems.contributeQueryResultGrid(a,{tfsContext:this._options.tfsContext,enableTeamActions:this._options.tfsContext.currentUserHasTeamPermission,container:this._element});return i.prototype._createContextMenu.call(this,b,a)};d.prototype.getActionArguments=function(a){var c=this,b;if(a==="open-work-item"){b=this.getSelectedWorkItemId();return b>0?{id:this.getSelectedWorkItemId(),tfsContext:this._options.tfsContext,triage:true}:{id:this.getSelectedWorkItemId(),workItemTypeName:this._store.workItemManager.getWorkItem(b).workItemType.name}}else if(a==="link-to-new"||a==="link-to-existing")return{baseId:this.getSelectedWorkItemId(),selectedIds:this.getSelectedWorkItemIds(),tfsContext:this._options.tfsContext};else if(a==="create-copy"||a==="use-as-a-template")return{workItemId:this.getSelectedWorkItemId(),tfsContext:this._options.tfsContext};else if(a==="copy-selection")return{grid:this,tfsContext:this._options.tfsContext};else if(a==="column-options")return{tfsContext:this._options.tfsContext,displayColumns:this._columns,sortColumns:this._sortColumns,allowSort:this._allowSort,okCallback:function(a){e.delay(c,0,function(){c.onColumnChange(a.display,a.sort)})}};else if(a===d.COMMAND_ID_EMAIL_SELECTION)return{queryResultsProvider:this._workItemsProvider,selectedWorkItems:this.getSelectedWorkItemIds()}};d.prototype.isQuerySaveable=function(){return this._workItemsProvider&&this._workItemsProvider.isEditable()&&this._workItemsProvider.isDirty()};d.prototype.getCommandStates=function(){var a=this._selectionCount,f=this._filterApplied&&(this._unfilteredIsLinkQuery||this._unfilteredIsTreeQuery),b=this._isLinkQuery||this._isTreeQuery||f,e=this._workItemsProvider&&this._workItemsProvider.queryDefinition&&c.QueryDefinition.isUnsavedWorkItems(this._workItemsProvider.queryDefinition);return[{id:"save-work-items",disabled:!this.isDirty(true)},{id:"save-query",disabled:!this.isQuerySaveable()},{id:"refresh-work-items",disabled:false},{id:"link-to-new",disabled:a===0},{id:"link-to-existing",disabled:a===0},{id:"create-copy",disabled:a!==1},{id:"use-as-a-template",disabled:a!==1},{id:"open-work-item",disabled:a!==1},{id:"bulk-edit-workitems",disabled:a===0},{id:"expand-all-nodes",hidden:!b,disabled:this._count===0||this._filterApplied===true},{id:"collapse-all-nodes",hidden:!b,disabled:this._count===0||this._filterApplied===true},{id:"toggle-filter",toggled:this._tagFilterProvider&&this._tagFilterProvider.isActive()},{id:d.COMMAND_ID_EMAIL_SELECTION,disabled:a===0},{id:d.COMMAND_ID_EMAIL_QUERY_RESULT,hidden:e,disabled:a===0||e}]};d.prototype.executeCommand=function(f){var g,c;f=f.get_commandName();switch(f){case"view-as-report":return false;case"add-to-favorites":return false;case"save-query":this.saveQuery();return false;case"save-work-items":this.saveWorkitems();return false;case"refresh-work-items":this.refresh();return false;case"expand-all-nodes":this.expandAll();return false;case"collapse-all-nodes":this.collapseAll();return false;case d.COMMAND_ID_EMAIL_QUERY_RESULT:b.logTracePoint("SendMail.SendEmailQueryButtonClicked");g=this._workItemsProvider.queryResultsModel;if(this._workItemsProvider.isDirty())alert(e.StringUtils.format(a.ErrorEmailUnsavedQuery,this._workItemsProvider.queryDefinition.path()));else{c=this._workItemsProvider.queryDefinition;var h=c.queryText||this._workItemsProvider.originalQuery;T.Dialogs.sendMail(new L.EmailWorkItemsDialogModel({queryResultsAdapter:{queryId:c.id,queryName:c.name,queryText:h,fields:this._workItemsProvider.getColumns(),sortFields:this._workItemsProvider.getSortColumns(),project:c.project,workItemStore:c.project.store}}))}return false}};d.prototype.getSelectedWorkItemId=function(){var a=this.getSelectedDataIndex();return a>=0?this._workItems[a]:0};d.prototype.getSelectedWorkItemIds=function(){var a,d,c=[],e=this._workItems,b=this.getSelectedDataIndices();for(a=0,d=b.length;a<d;a++)c.push(e[b[a]]);return c};d.prototype.getSelectedWorkItemPageData=function(){for(var b=this.getSelectedWorkItemIds(),a=0,e=b.length,d=[],c,a=0;a<e;a++){c=b[a];d.push(this._pageData[c])}return{pageData:d,pageColumns:this._pageColumns}};d.prototype.setSelectedWorkItemId=function(c,f,d){var a;if(this._workItems.length>0){b.assertParamIsNumber(c,"workItemId");a=$.inArray(c,this._workItems);if(a<0)a=0;this.setSelectedDataIndex(a,f);if(d)e.delay(this,0,function(){this.getSelectedRowIntoView()});else this.getSelectedRowIntoView()}};d.prototype.selectedIndexChanged=function(c,a){var b;i.prototype.selectedIndexChanged.call(this,c,a);b=this._workItems[a];this._fire("selectedWorkItemChanged",[b||0])};d.prototype.selectionChanged=function(){this._workItemsNavigator&&this._workItemsNavigator.update(this._expandedCount,this.getSelectedRowIndex(),this.getSelectedWorkItemId());this._statusUpdate()};d.prototype.getStatusText=function(){var b;if(this._emptyQueryResults)b=a.QueryResultsNewQueryGridStatusText;else if(this._count===0)b=this._workItemsProvider?a.QueryResultsGridStatusNoResultsText:"";else if(this._isLinkQuery)b=e.StringUtils.format(a.QueryResultsGridLinkQueryStatusTextFormat,this._count,this._rootCount,this._count-this._rootCount,this._selectionCount);else b=e.StringUtils.format(a.QueryResultsGridStatusTextFormat,this._count,this._selectionCount);return b};d.prototype.setStatusText=function(a){this._fire("statusUpdate",[a,false])};d.prototype.onOpenRowDetail=function(c){var d=this,b,a;if(c.dataIndex>=0){b=this._workItems[c.dataIndex];a={id:b,triage:true,tfsContext:this._options.tfsContext,options:{close:function(){d.focus(1)}}};if(b>0)x.menuManager.executeCommand(new Sys.CommandEventArgs("open-work-item",a,null));else{a.workItemTypeName=d._store.workItemManager.getWorkItem(b).workItemType.name;x.menuManager.executeCommand(new Sys.CommandEventArgs("new-work-item",a,null))}}return false};d.prototype.refresh=function(){this._refreshResults()};d.prototype.onColumnChange=function(b,a){this._refreshResults(b,a)};d.prototype.onSort=function(c,b){var a=[];$.each(b,function(b,d){a.push({name:d.name,asc:c[b].order==="asc"})});this._refreshResults(this._columns,a)};d.prototype._onColumnResize=function(a){i.prototype._onColumnResize.call(this,a);this._workItemsProvider&&this._workItemsProvider.setColumnWidth(a.name,a.width)};d.prototype._onColumnMove=function(a,b){i.prototype._onColumnMove.call(this,a,b);this._workItemsProvider&&this._workItemsProvider.setColumns(this._columns)};d.prototype.getColumnValue=function(g,h){var a,f,e,d,b;b=this._displayColumns[h];if(b.fieldId===100){f=this._links[g];return f===0?"":this._ensureLinkTypesFetched()?this._store.findLinkTypeEnd(f).name:""}else{a=this._workItems[g];if(b.fieldId===-3)return a>0?a:"("+-a+")";else{e=this._pageData[a];if(!e)return"";d=this._pageColumnMap[b.name];if(typeof d==="number")return c.Field.convertValueToDisplayString(e[d])}}return""};d.prototype.buildCache=function(c){var d,i,f,g,e,a,h=this._store.workItemManager;if(c){if(c.columns){e=$.inArray(C.CoreFieldRefNames.Id,c.columns);b.assert(e!==-1,"id field '"+C.CoreFieldRefNames.Id+"' was not found in payload.columns.")}for(d=0,i=c.rows.length;d<i;d++){f=c.rows[d];g=f[e||0];this._pageData[g]=f;a=h.getWorkItem(g);if(a)if(a.isDirty())this._updatePageRow(a);else h.removeWorkItem(a)}}};d.prototype._changeWorkItemIdInLastVisibleRange=function(a,c){var b=this._workItemsInLastVisibleRange[a];if(b){this._workItemsInLastVisibleRange[c]=b;delete this._workItemsInLastVisibleRange[a]}};d.prototype.cacheRows=function(c,a,d){var b=this;this._lastVisibleRange=a;this._workItemsInLastVisibleRange={};$.each(a,function(d,a){var c=b._workItems[a[1]];b._workItemsInLastVisibleRange[c]={rowIndex:a[0],dataIndex:a[1]}});this.delayExecute("updateWorkItemCache",0,true,function(){this._updateWorkItemCache(c,a,d)})};d.prototype._pageWorkItems=function(d,g){var e=this;if(!this._fetching){var a=[],f={};while(this._workItemsNeeded.length>0&&a.length<c.WorkItemManager.PAGE_SIZE){var b=this._workItemsNeeded.pop();if(b&&!(b in this._pageData)&&!(b in f)){a[a.length]=b;f[b]=true}}this._workItemsNeeded=[];if(a.length>0){this._fetching=true;this._store.beginPageWorkItems(a,this._pageColumns,function(a){if(e._fetching){e._fetching=false;e.buildCache(a);!g&&e.redraw()}$.isFunction(d)&&d()})}else $.isFunction(d)&&d()}};d.prototype.workItemChanged=function(h,a){b.assertParamIsObject(a,"args");b.assert(a.workItem,"workItem should be passed with work item changed arguments");b.assert(a.change,"change type should be passed with work item changed arguments");if(a.change===c.WorkItemChangeType.PreSave||a.change===c.WorkItemChangeType.Saving)return;var e=a.workItem,g=this._updatePageRow(e);if(g||a.change!==c.WorkItemChangeType.Opened){var f=e.getUniqueId(),d=this._workItemsInLastVisibleRange[f];d&&this.updateRow(d.rowIndex,d.dataIndex);this._updateDirtyStatus([f])}};d.prototype.initializeDirtyWatch=function(){this._managedWorkItems={};this._pendingManaged=null;this._pendManagedWorkItemIds($.map(this._store.workItemManager.getManagedWorkItems(),function(a){return a.getUniqueId()}))};d.prototype.getWorkItemIds=function(){return this._workItems.slice(0)};d.prototype.getUnfilteredWorkItemIds=function(){var a=this._filterApplied?this._unfilteredWorkItems:this._workItems;return a.slice(0)};d.prototype.getUnfilteredExpandStates=function(){return this._filterApplied?this._unfilteredExpandStates:this._options.expandStates};d.prototype.setUnfilteredExpandStates=function(a){if(this._filterApplied)this._unfilteredExpandStates=a;else this._options.expandStates=a};d.prototype.saveQuery=function(){this._workItemsProvider.beginSave()};d.prototype.saveWorkitems=function(g){var f=[],d=this;if(!this._saving){f=this._getDirtyWorkItems();if(f.length>0){this._saving=true;$(this).trigger("savingWorkItems");this._store.beginSaveWorkItemsBatch(f,function(){d._saving=false;d.redraw();$(d).trigger("workItemsSaved");b.logTracePoint("QueryResultGrid.saveWorkItems.success")},function(h){var b=[],i;d._saving=false;d.redraw();if(h&&h.name===c.Exceptions.WorkItemBulkSaveException){$.each(h.results,function(){this.error&&b.push(e.StringUtils.format(a.TriageViewWorkItemSaveError,this.workItem.id,B(this.error)))});if(b.length>0)if(f.length===b.length)i=e.StringUtils.format(a.TriageViewWorkItemBulkSaveErrorAll,b.length,b.join("\r\n"));else i=e.StringUtils.format(a.TriageViewWorkItemBulkSaveError,f.length-b.length,b.length,b.join("\r\n"));alert(i)}else D(h,g,d);$(d).trigger("workItemsSaveError")})}}};d.prototype.beginPageSelectedWorkItems=function(d,k,j){var h,g,a,e=this.getSelectedWorkItemIds();function i(){var k;if(this._cancelable&&this._cancelable.canceled){$.isFunction(d)&&d();return}g+=1;if(g<h){k=g*c.WorkItemManager.PAGE_SIZE;a._workItemsNeeded=e.slice(k,k+c.WorkItemManager.PAGE_SIZE);a._pageWorkItems(f(a,i),j)}else if(g>=h&&$.isFunction(d)){b.logTracePoint("TFS.WorkItemTracking.Controls.Query.beginPageSelectedWorkItems.complete");d()}}b.logTracePoint("TFS.WorkItemTracking.Controls.Query.beginPageSelectedWorkItems.start");if(e&&e.length>0){h=Math.ceil(e.length/c.WorkItemManager.PAGE_SIZE);g=0;a=this;a._workItemsNeeded=e.slice(0,c.WorkItemManager.PAGE_SIZE-1);a._pageWorkItems(f(a,i),j)}else{b.logTracePoint("TFS.WorkItemTracking.Controls.Query.beginPageSelectedWorkItems.complete");d()}};d.prototype.getWorkItemIdAtDataIndex=function(a){b.assertParamIsNumber(a,"dataIndex");return this._workItems[a]};d.prototype.bindFilterManager=function(a){var d=this,e;b.assertParamIsType(a,c.FilterManager,"filterManager");b.assert(!this._filterManager,"filterManager has already been set");this._filterManager=a;this._tagFilterProvider=this._filterManager.getFilterProvider(c.TagFilterProvider.PROVIDER_TYPE);this.bindFilterManagerEvents(a);a.attachEvent(c.FilterManager.EVENT_FILTER_ACTIVATED,function(){d._refreshFiltersForGrid()});e=g.TfsTeamProjectCollection.getDefaultConnection().getService(c.WorkItemStore);e.workItemManager.attachWorkItemChanged(function(b,a){a.change===c.WorkItemChangeType.FieldChange&&a.changedFields[80]&&$.inArray(a.workItem.id,d.getUnfilteredWorkItemIds())!==-1&&d._tagFilterProvider.updateWorkItem(a.workItem.id,a.workItem.getTagNames())})};d.prototype.bindFilterManagerEvents=function(a){var d=this;b.assertParamIsType(a,c.FilterManager,"filterManager");a.attachEvent(c.FilterManager.EVENT_FILTER_CHANGED,function(){d.filterWorkItems(a.getMatchingWorkItems())});a.attachEvent(c.FilterManager.EVENT_FILTER_CLEARED,function(){d.restoreUnfilteredState()})};d.prototype.filterWorkItems=function(a){b.assertParamIsArray(a,"ids");var c=this.getSelectedWorkItemId();if(this._filterApplied===false){this._unfilteredWorkItems=this.getWorkItemIds();this._unfilteredExpandStates=this._options.expandStates;this._unfilteredIsLinkQuery=this._isLinkQuery;this._unfilteredIsTreeQuery=this._isTreeQuery}this._options.columns=this._columns;a=this._sortAndRemoveDuplicates(a,this._unfilteredWorkItems);this._options.source=a;this._workItems=a;this._options.expandStates=null;this._isLinkQuery=false;this._isTreeQuery=false;this._filterApplied=true;this.initializeDataSource();this.setSelectedWorkItemId(c,true,true);b.logTracePoint("Grid.filteringComplete")};d.prototype.restoreUnfilteredState=function(a){if(typeof a==="undefined")a=false;var c;if(this._filterApplied===true&&this._unfilteredWorkItems){if(!a)c=this.getSelectedWorkItemId();this._reinstateUnfilteredData();this._clearCachedFilterValues();this._options.columns=this._columns;this.initializeDataSource(a);!a&&this.setSelectedWorkItemId(c,true,true);b.logTracePoint("QueryResultGrid.restoreUnfilteredStateComplete")}};d.prototype.isFiltered=function(){return this._filterApplied};d.prototype._onNavigateNext=function(){var a=this.getSelectedRowIndex();if(a<this._count-1){a++;this.setSelectedRowIndex(a);this.getSelectedRowIntoView()}};d.prototype._onNavigatePrevious=function(){var a=this.getSelectedRowIndex();if(a>0){a--;this.setSelectedRowIndex(a);this.getSelectedRowIntoView()}};d.prototype._onGetMenuItemActionArguments=function(a){return this.getActionArguments(a.getAction())};d.prototype._updateCommandStates=function(a){a.updateCommandStates(this.getCommandStates())};d.prototype._getDefaultActionArguments=function(a){return{tfsContext:k.TfsContext.getDefault(),id:this._workItems[a.rowInfo.dataIndex],selectedWorkItems:this.getSelectedWorkItemIds()}};d.prototype._determineIndentIndex=function(){var a,c,b=this._columns,d=this._displayColumns;this._indentIndex=0;for(a=0,c=b.length;a<c;a++)if(d[b[a].index].name==="System.Title")this._indentIndex=a};d.prototype._statusUpdate=function(a){this._fire("statusUpdate",[a||this.getStatusText(),a?true:false])};d.prototype._refreshResults=function(f,e){var c=this;if(this._workItemsProvider){f&&this._workItemsProvider.setColumns(f);e&&this._workItemsProvider.setSortColumns($.map(e,function(a){return{name:a.name,descending:!a.asc}}));function d(a){$(c).trigger("queryResultsError");c._statusUpdate(a)}b.logTracePoint("QueryResultGrid._refreshResults.pending");this._workItemsProvider.invalidateResults();$(this).trigger("queryResultsStarting");this.setStatusText(a.QueryingStatusText);this._workItemsProvider.beginGetResults(function(e){var f;function a(){c.updateDataModel(e);$(c).trigger("queryResultsComplete");b.logTracePoint("QueryResultGrid._refreshResults.complete")}if(c._tagFilterProvider&&c._tagFilterProvider.isActive())c._refreshFiltersForGrid(e.targetIds,function(){a()},d);else a()},d)}};d.prototype._ensureLinkTypesFetched=function(){var a=this,b=false;if(!this._linkTypesFetched&&!this._fetchingLinkTypes){this._fetchingLinkTypes=true;this._store.beginGetLinkTypes(function(){a._fetchingLinkTypes=false;a._linkTypesFetched=true;b&&a.redraw()},function(b){a._fetchingLinkTypes=false;a._linkTypesFetched=true;D(b,null,a)})}b=true;return this._linkTypesFetched};d.prototype._updatePageRow=function(d){b.assertParamIsObject(d,"workItem");var j,c,a,k,h,g,i,f=false;j=d.getUniqueId();c=this._pageData[j];if(c){h=this._pageColumns;for(a=0,k=h.length;a<k;a++){g=d.getField(h[a]);if(g)if(g.fieldDefinition.id===-3)c[a]=d.getUniqueId();else{i=g.getValue();if(!f&&e.StringUtils.defaultComparer(c[a],i)!==0)f=true;c[a]=i}else{c[a]=null;f=true}}}return f};d.prototype._updateWorkItemCache=function(g,f,h){var i=g.length,e=h.length,a,c,b=[],d,j=this._workItems,k=this._pageData;c=Math.max(i,e);for(a=0;a<c;a++){if(a<i)b[b.length]=g[a][1];if(a<e)b[b.length]=h[e-a-1][1]}c=f.length;for(a=0;a<c;a++)b[b.length]=f[a][1];c=b.length;for(a=0;a<c;a++){d=j[b[a]];!(d in k)&&this._workItemsNeeded.push(d)}this.delayExecute("pageWorkItems",100,true,function(){this._pageWorkItems()})};d.prototype._dirtyStatusChanged=function(a){this._fire("dirty-status-changed",[a])};d.prototype._updateDirtyStatus=function(f){var e,b,a,g,c=[],d;if(!this._managedWorkItems)this._managedWorkItems={};for(a=0,g=f.length;a<g;a++){d=f[a];b=this._managedWorkItems[d];if(b===true)e=true;else b!==false&&c.push(d)}c.length>0&&this._pendManagedWorkItemIds(c);e&&this._dirtyStatusChanged()};d.prototype._pendManagedWorkItemIds=function(b){var a,c;if(b.length>0){if(!this._pendingManaged)this._pendingManaged={};for(a=0,c=b.length;a<c;a++)this._pendingManaged[b[a]]=true;this.delayExecute("pendManagedWorkItemIds",250,false,this._checkInterested)}};d.prototype._checkInterested=function(){var d=this._pendingManaged,f=this._managedWorkItems,e=this.getUnfilteredWorkItemIds(),c=0,a,b,g;for(a in d)if(d.hasOwnProperty(a)){f[a]=false;c++}for(b=0,g=e.length;b<g&&c>0;b++){a=e[b];if(a in d){f[a]=true;c--}}this._pendingManaged=null;this._dirtyStatusChanged()};d.prototype._updateRow=function(b,f,d,e,g){i.prototype._updateRow.call(this,b,f,d,e,g);var a=this._store.workItemManager.getWorkItem(this._workItems[d]),c=b.row;c.hasClass("dirty-workitem-row")&&c.removeClass("dirty-workitem-row");c.hasClass("invalid-workitem-row")&&c.removeClass("invalid-workitem-row");if(a&&a.isDirty()){b.row.addClass("dirty-workitem-row");(!a.isValid()||a.hasError())&&b.row.addClass("invalid-workitem-row")}};d.prototype._getDirtyWorkItems=function(){var f=this.getUnfilteredWorkItemIds(),a,e={},c=[],h=this._store.workItemManager,b,g,d;for(b=0,g=f.length;b<g;b++){a=h.getWorkItem(f[b]);if(a){d=a.getUniqueId();if(a.isDirty()&&!(d in e)){e[d]=true;c[c.length]=a}}}return c};d.prototype._beginEnsureSelectionIsAvailable=function(a,b){this.beginPageSelectedWorkItems(a,b,true)};d.prototype._sortAndRemoveDuplicates=function(d,e){var b=[],a={},c={};$.each(d,function(c,b){a[b]=true});b=$.map(e,function(b){if(a[b]&&!c[b]){c[b]=true;return b}});return b};d.prototype._clearCachedFilterValues=function(){this._unfilteredWorkItems=null;this._unfilteredExpandStates=null;this._unfilteredIsLinkQuery=null;this._unfilteredIsTreeQuery=null;this._filterApplied=false};d.prototype._reinstateUnfilteredData=function(){this._options.source=this._unfilteredWorkItems;this._workItems=this._unfilteredWorkItems;this._options.expandStates=this._unfilteredExpandStates;this._isLinkQuery=this._unfilteredIsLinkQuery;this._isTreeQuery=this._unfilteredIsTreeQuery};d.prototype._refreshFiltersForGrid=function(a,f,j){var i,d=this._tagFilterProvider,k=this._filterManager,l=g.TfsTeamProjectCollection.getDefaultConnection().getService(c.WorkItemStore);a=e.ArrayUtils.unique(a||this.getUnfilteredWorkItemIds());if(d.isActive())if(!a||a.length===0){d.setTags({});$.isFunction(f)&&f()}else{b.logTracePoint("WorkItemStore.beginGetTagWorkitemIds.start");l.beginGetTagWorkitemIds(a,function(e){var c=e;k.setOriginalWorkItems(a);d.setTags(c);k.rebuildMatchingWorkItems();i=l.workItemManager.getDirtyWorkItems();$.each(i,function(c,b){$.inArray(b.id,a)!==-1&&d.updateWorkItem(b.id,b.getTagNames())});$.isFunction(f)&&f();b.logTracePoint("WorkItemStore.beginGetTagWorkitemIds.completed")},function(a){if($.isFunction(j))j(a);else h.errorHandler.show(a)})}};d.prototype.isWorkItemPaged=function(c){b.assertParamIsNumber(c,"workItemId");var a=false;$.each(this._pageData,function(d,b){if(b[0]===c){a=true;return false}});return a};d.prototype.pageWorkItems=function(a,c){b.assertParamIsArray(a,"workItemIds");b.assertParamIsFunction(c,"callback");this._workItemsNeeded=this._workItemsNeeded.concat(a);this._pageWorkItems(c)};d.prototype.getWorkItemPageData=function(a){b.assertParamIsNumber(a,"workItemId");return this._pageData[a].slice(0)};d.prototype.getFilterManager=function(){return this._filterManager};d.prototype.getTagFilterProvider=function(){return this._tagFilterProvider};d._typeName="tfs.wit.queryresultgrid";d.COMMAND_ID_EMAIL_QUERY_RESULT="email-query-result";d.COMMAND_ID_EMAIL_SELECTION="email-selection";return d}(eb.Grid);j.QueryResultGrid=s;h.initClassPrototype(s,{_workItems:null,_workItemsNeeded:null,_links:null,_displayColumns:null,_sortColumns:null,_rootCount:0,_allowSort:true,_pageColumns:null,_pageColumnMap:null,_pageData:null,_store:null,_projectName:null,_fetching:false,_linkTypesFetched:false,_fetchingLinkTypes:false,_saving:false,_lastVisibleRange:null,_workItemsProvider:null,_workItemsProviderVersion:0,_workItemsNavigator:null,_navigateNextDelegate:null,_navigatePreviousDelegate:null,_refreshDelegate:null,_workItemChangedDelegate:null,_filterApplied:false,_filterManager:null,_unfilteredWorkItems:null,_unfilteredExpandStates:null,_unfilteredIsLinkQuery:null,_unfilteredIsTreeQuery:null,_isLinkQuery:false,_isTreeQuery:false,_emptyQueryResults:false,_managedWorkItems:null,_pendingManaged:null});h.classExtend(s,l.ControlExtensions);var u=function(h){__extends(e,h);function e(a){h.call(this,a);var b=this;this._getActionArgsDelegate=function(){return b._onGetMenuItemActionArguments(this)};this._onGridDirtyStatusChangedDelegate=f(this,this.onGridDirtyStatusChanged);this._onCommandStatusChangedDelegate=f(this,this.onCommandStatusChanged);this._onSelectedWorkItemChangedDelegate=f(this,this.onSelectedWorkItemChanged)}e.prototype.initializeOptions=function(a){h.prototype.initializeOptions.call(this,$.extend({coreCssClass:"toolbar query-result-grid-toolbar"},a))};e.prototype.initialize=function(){h.prototype.initialize.call(this);this._menuBar=this._createMenuBar(this._element)};e.prototype.bind=function(b){var a;this.unbind();this._grid=b;a=this._grid.getElement();this._bind(a,"dirty-status-changed",this._onGridDirtyStatusChangedDelegate,true);this._bind(a,"commandStatusChanged",this._onCommandStatusChangedDelegate,true);this._bind(a,"selectedWorkItemChanged",this._onSelectedWorkItemChangedDelegate,true);this._bind(window,"query-provider-dirty-state-changed",this._onGridDirtyStatusChangedDelegate,true);this._updateMenuItems()};e.prototype.unbind=function(){var a;if(this._grid){a=this._grid.getElement();this._unbind(a,"dirty-status-changed",this._onGridDirtyStatusChangedDelegate,true);this._unbind(a,"commandStatusChanged",this._onCommandStatusChangedDelegate,true);this._unbind(a,"selectedWorkItemChanged",this._onSelectedWorkItemChangedDelegate,true);this._grid=null}};e.prototype.bindFilterManager=function(b){var a=this;this._filterManager=b;this._tagFilterProvider=this._filterManager.getFilterProvider(c.TagFilterProvider.PROVIDER_TYPE);this._filterManager.attachEvent(c.FilterManager.EVENT_FILTER_ACTIVATED,f(this,this._updateMenuItemsNow));this._filterManager.attachEvent(c.FilterManager.EVENT_FILTER_DEACTIVATED,f(this,this._updateMenuItemsNow));if(g.FeatureAvailabilityService.isFeatureEnabled(S.FeatureAvailabilityFlags.WebAccessAgileProductBacklogSearch)){this._textFilterProvider=new A({filterManager:this._filterManager});this._filterManager.registerFilterProvider(A.PROVIDER_TYPE,this._textFilterProvider);this._textFilterControl=d.BaseControl.createIn(O,this._menuBar,{adapter:this._textFilterProvider});this._textFilterProvider.attachGrid(this._grid);this._filterManager.attachEvent(c.FilterManager.EVENT_FILTER_ACTIVATED,function(){a._textFilterProvider.handleWorkItemCaching();a._textFilterControl.createIndex()});$(this._grid).bind("queryResultsStarting",f(this._textFilterControl,this._textFilterControl.clearIndex));$(this._grid).bind("setWIProvider",function(){a._textFilterProvider.clearFilters();a._textFilterControl.deactivateSearch(true)})}};e.prototype.onSelectedWorkItemChanged=function(){this._updateMenuItems()};e.prototype.onCommandStatusChanged=function(){this._updateMenuItems()};e.prototype.onGridDirtyStatusChanged=function(){this._updateMenuItems()};e.prototype._getGrid=function(){return this._grid};e.prototype._createMenuBar=function(b){var a;a=d.BaseControl.createIn(x.MenuBar,b,{items:this._createMenubarItems(),executeAction:f(this,this._onMenubarItemClick)});return a};e.prototype._onGetMenuItemActionArguments=function(a){if(this._grid)return this._grid.getActionArguments(a.getAction())};e.prototype._createMenubarItems=function(){var b=[];b.push({id:"save-work-items",text:a.SaveResults,title:a.SaveResultsToolTip,showText:false,icon:"icon-save-all",arguments:this._getActionArgsDelegate});b.push({id:"save-query",text:a.SaveQuery,showText:true,title:a.SaveQuery,noIcon:true});b.push({id:"refresh-work-items",text:a.Refresh,title:a.RefreshTooltip,showText:false,icon:"icon-refresh",arguments:this._getActionArgsDelegate});b.push({id:"open-work-item",text:a.Open,title:a.OpenToolTip,showText:false,icon:"icon-open",arguments:this._getActionArgsDelegate});if(this._options.tfsContext.standardAccessMode===true){b.push({id:"link-to-new",text:a.LinkSelectedItemsToNewWorkItem,title:a.LinkSelectedItemsToNewWorkItem,showText:false,icon:"icon-tfs-work-item-new-linked",arguments:this._getActionArgsDelegate});b.push({id:"link-to-existing",text:a.LinkToExistingItem,title:a.LinkToExistingItemToolTip,showText:false,icon:"icon-tfs-link-add",arguments:this._getActionArgsDelegate})}b.push({id:s.COMMAND_ID_EMAIL_QUERY_RESULT,text:a.EmailQueryResult,title:a.EmailQueryResult,showText:false,icon:"icon-envelope",arguments:this._getActionArgsDelegate});b.push({separator:true});b.push({id:"expand-all-nodes",text:r.ExpandAll,title:r.ExpandAllToolTip,showText:false,icon:"icon-tree-expand-all",arguments:this._getActionArgsDelegate});b.push({id:"collapse-all-nodes",text:r.CollapseAll,title:r.CollapseAllToolTip,showText:false,icon:"icon-tree-collapse-all",arguments:this._getActionArgsDelegate});b.push({separator:true});b.push({id:"column-options",text:a.ColumnOptions,title:a.ColumnOptionsTooltip,noIcon:true,arguments:this._getActionArgsDelegate});!this._options.hideFilter&&b.push({id:"toggle-filter",text:r.Filter,title:r.FilterToolTip,showText:false,icon:"icon-filter",cssClass:"right-align toggle-filter-bar",arguments:this._getActionArgsDelegate});return b};e.prototype._onMenubarItemClick=function(a){if(a.get_commandName()==="toggle-filter"){b.assertIsNotNull(this._tagFilterProvider,"No TagFilterProvider found.  Cannot toggle.");this._tagFilterProvider.toggleFilterActivation()}else if(this._grid)return this._grid.executeCommand(a)};e.prototype._updateMenuItems=function(){this.delayExecute("updateMenuItems",250,false,f(this,this._updateMenuItemsNow))};e.prototype._updateMenuItemsNow=function(){var a=[];if(this._grid)a=this._grid.getCommandStates();this._menuBar.updateCommandStates(a)};e._typeName="tfs.wit.queryResultGridToolbar";return e}(d.BaseControl);j.QueryResultToolbar=u;h.initClassPrototype(u,{_grid:null,_menuBar:null,_filterManager:null,_tagFilterProvider:null,_textFilterProvider:null,_textFilterControl:null,_getActionArgsDelegate:null,_onGridDirtyStatusChangedDelegate:null,_onCommandStatusChangedDelegate:null,_onSelectedWorkItemChangedDelegate:null});h.classExtend(u,l.ControlExtensions);var G=function(b){__extends(a,b);function a(a){b.call(this,a)}a.prototype.initializeOptions=function(c){b.prototype.initializeOptions.call(this,$.extend({coreCssClass:a.coreCssClass},c))};a.prototype.initialize=function(){var b=this,a=true;if(typeof this._options.hiddenOnCreate==="boolean")a=this._options.hiddenOnCreate;this.filterManager=new c.FilterManager;this.tagFilterProvider=new c.TagFilterProvider({deactivatedOnCreate:a,filterManager:this.filterManager});this.filterManager.registerFilterProvider(c.TagFilterProvider.PROVIDER_TYPE,this.tagFilterProvider);this._decorate();this.tagFilterProvider.isActive()&&this.showElement();this.filterManager.attachEvent(c.FilterManager.EVENT_FILTER_ACTIVATED,function(){b.showElement();$(window).resize()});this.filterManager.attachEvent(c.FilterManager.EVENT_FILTER_DEACTIVATED,function(){b.hideElement();$(window).resize()})};a.prototype.showElement=function(){b.prototype.showElement.call(this);this.getElement().siblings(".work-item-list").addClass("with-filter-bar");this.getElement().prev(".toolbar").addClass("no-border-bottom")};a.prototype.hideElement=function(){b.prototype.hideElement.call(this);this.getElement().siblings(".work-item-list").removeClass("with-filter-bar");this.getElement().prev(".toolbar").removeClass("no-border-bottom")};a.prototype._decorate=function(){this.getElement().addClass("filter-bar");this.tagFilter=d.BaseControl.createIn(V.TagFilterControl,this._element,{});this.tagFilter.bindFilterManager(this.filterManager)};a._typeName="tfs.wit.filterbar";a.coreCssClass="filter-bar";return a}(d.BaseControl);j.FilterBar=G;h.initClassPrototype(G,{tagFilter:null,filterManager:null,_hidden:false,_updateFilterSource:null});var A=function(d){__extends(a,d);function a(a){if(typeof a==="undefined")a={};d.call(this);this._resultWorkItems=[];this._workItemIds=[];this._dataSetComplete=true;this._unpagedWorkItems=[];this._searching=false;if(a&&a.filterManager)this._filterManager=a.filterManager}a.prototype.attachGrid=function(a){b.assertParamIsObject(a,"grid");if(!this._grid)this._grid=a};a.prototype.addFilter=function(){this._searching=true};a.prototype.removeFilter=function(){this._searching=false};a.prototype.clearFilters=function(){this._resultWorkItems=[];this._searching=false};a.prototype.getMatchingWorkItems=function(a){return this._searching?e.ArrayUtils.intersectPrimitives(a,this._resultWorkItems):a};a.prototype.handleResults=function(c){b.assertParamIsArray(c,"results");b.logTracePoint("TextFilter.resultsFinished");this._resultWorkItems=c;this._filterManager.rebuildMatchingWorkItems();this._filterManager.addFilter(a.PROVIDER_TYPE,"")};a.prototype.handleClear=function(){this._filterManager.clearFilters(a.PROVIDER_TYPE)};a.prototype.addMoreItems=function(a,e){var f=this;b.assertParamIsFunction(a,"addItemsCallback");b.assertParamIsFunction(e,"searchCallback");var d;d=this._unpagedWorkItems.splice(0,c.WorkItemManager.PAGE_SIZE);this._grid.pageWorkItems(d,function(){a(f.createSearchableObjects());e($(".text-filter-input").val())})};a.prototype.createSearchableObjects=function(){var f=this,e=this._workItemIds.slice(0,1e3),c=[],d=this._grid.getColumns(),a,b=false;$.each(d,function(d,c){if(c.name==="System.Tags")a=c.index;if(c.name==="System.Id")b=true});if(a===0||!b)a++;$.each(e,function(d,b){c.push(f.createSearchableObject(b,a))});this._dataSetComplete=this._unpagedWorkItems.length===0;return c};a.prototype.handleWorkItemCaching=function(){var a=this._filterManager.getFilterProvider(c.TagFilterProvider.PROVIDER_TYPE);this._workItemIds=this._grid.getWorkItemIds();a&&!a.isActive()&&this._filterManager.setOriginalWorkItems(this._grid.getWorkItemIds())};a.prototype.isDataSetComplete=function(){return this._dataSetComplete};a.prototype.getWorkItemIds=function(){return this._workItemIds.slice(0)};a.prototype.updateWorkItemId=function(){};a.prototype.createSearchableObject=function(a,e){b.assertParamIsNumber(a,"workItemId");var c=new W.SearchableObject(a,[]),d;if(!this._grid.isWorkItemPaged(a)){this._unpagedWorkItems.push(a);this._dataSetComplete=false}else{d=this._grid.getWorkItemPageData(a);$.each(d,function(b,a){if(b===e&&a)c.addTerm(a.replace(/\;/g," "));else typeof a==="string"&&c.addTerm(a)})}return c};a.prototype.toggleFilterActivation=function(){};a.prototype.activateFilter=function(){};a.prototype.deactivateFilter=function(){};a.prototype.isFiltering=function(){return this._searching};a.prototype.attachWIEvents=function(a){b.assertParamIsFunction(a,"invalidateIndexCallback");var d=g.TfsTeamProjectCollection.getDefaultConnection().getService(c.WorkItemStore);d.workItemManager.attachWorkItemChanged(function(d,b){b.change===c.WorkItemChangeType.Saving&&a()})};a.PROVIDER_TYPE="text";return a}(W.SearchAdapter);j.TextFilterProvider=A;h.initClassPrototype(A,{_grid:null,_workItemIds:null,_filterManager:null,_dataSetComplete:null,_unpagedWorkItems:null});var O=function(b){__extends(a,b);function a(){b.apply(this,arguments);this._firstRun=true}a.prototype.activateSearch=function(){this._searchAdapter.handleWorkItemCaching();if(this._firstRun){this._searchAdapter.attachWIEvents(f(this,this.clearIndex));this._firstRun=false}b.prototype.activateSearch.call(this)};a._typeName="tfs.wit.controls.textfiltercontrol";return a}(i.TextFilterControl);j.QueryResultsSearchControl=O;var w=function(b){__extends(a,b);function a(a){b.call(this,a);this._updateDelegate=f(this,this._update)}a.prototype.initializeOptions=function(a){b.prototype.initializeOptions.call(this,$.extend({coreCssClass:"query-result-grid-info",showQueryTitle:false},a))};a.prototype.initialize=function(){b.prototype.initialize.call(this)};a.prototype.dispose=function(){this.unbind();b.prototype.dispose.call(this)};a.prototype.bind=function(c){var b,a;this._grid=c;this._grid._bind("statusUpdate",this._updateDelegate);b=$("<table cellpadding='0' />").appendTo(this._element);this._$elementsContainer=$("<tr />").appendTo(b);a=$("<td class='query-title' />").appendTo(this._$elementsContainer);this._statusIndicator=d.BaseControl.createIn(i.StatusIndicator,a,{eventTarget:c,statusStartEvent:"queryResultsStarting savingWorkItems",statusCompleteEvent:"queryResultsComplete workItemsSaved",statusErrorEvent:"queryResultsError workItemsSaveError"});this._$titleElement=$("<span />").appendTo(a);this._$statusElement=$("<span />").appendTo($("<td class='query-status hub-title-right' />").appendTo(this._$elementsContainer));this._update(this._grid,this._grid.getStatusText())};a.prototype.unbind=function(){if(this._grid){this._grid._unbind("statusUpdate",this._updateDelegate);this._grid=null}this._$titleElement.text("");this._$statusElement.text("");this._element.toggleClass("invalid",false)};a.prototype._update=function(f,e,a){var c=e,d=null,b;this._element.toggleClass("invalid",a===true);if(a)c=B(e);b=this._options.showQueryTitle&&!a;if(b&&this._grid&&this._grid._workItemsProvider){d=this._grid._workItemsProvider.getTitle();this._$titleElement.text(d).attr("title",d)}else this._$titleElement.empty();this._$statusElement.text(c).attr("title",c);this._$elementsContainer.toggleClass("no-title",!b)};a._typeName="tfs.wit.queryResultGridInfo";return a}(d.BaseControl);j.QueryResultInfoBar=w;h.initClassPrototype(w,{_grid:null,_$elementsContainer:null,_statusIndicator:null,_$titleElement:null,_$statusElement:null,_updateDelegate:null});var K=function(c){__extends(a,c);function a(a){c.call(this,a)}a.prototype.initializeOptions=function(a){c.prototype.initializeOptions.call(this,$.extend({coreCssClass:"triage-view",infoBar:true},a))};a.prototype.initialize=function(){var a,d=this;c.prototype.initialize.call(this);this._bind($(".work-items-pane-filter"),"changed",function(b,a){d.showWorkItemPane(a.value)},true);this._splitter._bind("changed",f(this,this.onSplitterChanged));this._grid._bind("selectedWorkItemChanged",f(this,this.onSelectedWorkItemChanged));this._gridInfoBar&&this._gridInfoBar.bind(this._grid);if(this._toolbar){this._toolbar.bind(this._grid);this._filterBar&&this._filterBar.filterManager&&this._toolbar.bindFilterManager(this._filterBar.filterManager)}this._filterBar&&this._grid.bindFilterManager(this._filterBar.filterManager);a=this._grid.getSelectedWorkItemId();this.onSelectedWorkItemChanged(null,a);b.logTracePoint("TriageView.ctor.complete")};a.prototype._enhance=function(a){c.prototype._enhance.call(this,a);this._splitter=d.Enhancement.ensureEnhancement(i.Splitter,this._element);H(this._splitter?true:false,"Unable to find Splitter control.");this._grid=d.Enhancement.ensureEnhancement(s,this._element);H(this._grid?true:false,"Unable to find QueryResultsGrid control.");this._workItemsNavigator=new v;this._grid.setNavigator(this._workItemsNavigator);this._toolbar=d.Enhancement.ensureEnhancement(u,this._element);this._gridInfoBar=d.Enhancement.ensureEnhancement(w,this._element);this._filterBar=d.Enhancement.ensureEnhancement(G,this._element);this._workItemForm=d.BaseControl.createIn(E.WorkItemForm,this._splitter.rightPane,{tfsContext:this._options.tfsContext,infoBar:{options:{workItemsNavigator:this._workItemsNavigator}},toolbar:{inline:true,workItemsNavigator:this._workItemsNavigator},close:function(){return false}})};a.prototype.onSelectedWorkItemChanged=function(c,a){this.showWorkItem(a,true);b.logTracePoint("TriageView.selectedWorkItemChanged.complete")};a.prototype.onSplitterChanged=function(){};a.prototype.showElement=function(){c.prototype.showElement.call(this);this._splitter.attachResize(true)};a.prototype.hideElement=function(){this._splitter.detachResize();c.prototype.hideElement.call(this)};a.prototype.detachWorkItemForm=function(){this._workItemForm.unbind()};a.prototype.showWorkItemPane=function(a,b){if(typeof b==="undefined")b=true;if(this._workItemPaneMode!==a){this._workItemPaneMode=a;b&&g.TfsConfigurationServer.getConnection(this._options.tfsContext).getService(g.WebSettingsService).beginWriteSetting("/WorkItemPane",a);if(a==="off"){this._splitter.noSplit();this._workItemForm.hideElement();this._workItemForm.unbind()}else if(a==="right"){this._splitter.horizontal();this._splitter.split();this.showWorkItem(this.currentWorkItemId,true)}else{this._splitter.vertical();this._splitter.split();this.showWorkItem(this.currentWorkItemId,true)}}};a.prototype.showWorkItem=function(a,c){var d=this;function e(a){d._workItemForm.beginShowWorkItem(a,function(){d.currentWorkItemId=a;b.logTracePoint("TriageView.showWorkItem.complete")},function(){},{forceShow:c})}if(this.currentWorkItemId!==a||c){this.currentWorkItemId=a;if(this._workItemPaneMode!=="off")if(a!==0){this._workItemForm.showElement();e(a)}else{this._workItemForm.unbind();this._workItemForm.hideElement()}}};a.prototype.setProvider=function(a,e,f,b){var c=this,d;this._workItemsProvider=a;this._workItemsNavigator&&this._workItemsNavigator.setProvider(a);this._filterBar&&this._filterBar.tagFilterProvider&&this._filterBar.tagFilterProvider.deactivateFilter(true);if(this._filterBar&&this._filterBar.filterManager){d=this._filterBar.filterManager.getFilterProvider(A.PROVIDER_TYPE);d&&$(this._grid).trigger("setWIProvider")}b=$.extend(b,{runQuery:true});this._grid.beginShowResults(a,function(){c.showWorkItem(c._grid.getSelectedWorkItemId());$.isFunction(e)&&e.call(c)},f,b)};a.prototype.getProvider=function(){return this._workItemsProvider};a.prototype.scrollIntoView=function(a){this._grid.getSelectedRowIntoView(a)};a.prototype.saveWorkitems=function(){this._grid.saveWorkitems()};a.prototype.refreshWorkItems=function(){this._grid.refresh()};a.prototype._createElement=function(){this._splitter=d.BaseControl.createIn(i.Splitter,this._element,{cssClass:"content",fixedSide:"right"});this._splitter.rightPane.addClass("hub-no-content-gutter");this._toolbar=d.BaseControl.createIn(u,this._splitter.leftPane,{tfsContext:this._options.tfsContext});this._filterBar=d.BaseControl.createIn(G,this._splitter.leftPane,{tfsContext:this._options.tfsContext});if(this._options.infoBar===true)this._gridInfoBar=d.BaseControl.createIn(w,this._splitter.leftPane,{tfsContext:this._options.tfsContext});else this._gridInfoBar=this._options.infoBar;this._grid=d.BaseControl.createIn(s,this._splitter.leftPane,{cssClass:"work-item-list",tfsContext:this._options.tfsContext});this._workItemForm=d.BaseControl.createIn(E.WorkItemForm,this._splitter.rightPane,{tfsContext:this._options.tfsContext})};a._typeName="tfs.wit.triageView";return a}(d.BaseControl);j.TriageView=K;h.initClassPrototype(K,{_splitter:null,_gridInfoBar:null,_grid:null,_toolbar:null,_filterBar:null,_workItemForm:null,_workItemPaneMode:"bottom",_workItemsProvider:null,_workItemsNavigator:null,currentWorkItemId:0});h.classExtend(K,l.ControlExtensions);var J=function(p){__extends(m,p);function m(a){p.call(this,a);this._workItemChangedDelegate=e.throttledDelegate(this,200,this._onWorkItemChanged)}m.prototype.initializeOptions=function(a){var b=this;a=a||{};this._enableDragDrop(a);p.prototype.initializeOptions.call(this,$.extend({clickToggles:true,clickSelects:false,sortMenuItems:false,contextMenu:{executeAction:f(this,this._onPopupItemClick),arguments:function(a){return{item:a.item,queryPath:a.item.queryPath,isFolder:Boolean(a.item.folder),project:b._project}}}},a))};m.prototype.initialize=function(){var a=this,d=this,e;e=this._options.tfsContext.navigation.project;H(e?true:false,"Need a project to work.");p.prototype.initialize.call(this);this._attachEvents();this._store=g.TfsTeamProjectCollection.getConnection(this._options.tfsContext).getService(c.WorkItemStore);this._store.beginGetProject(e,function(c){a._project=c;c.beginGetQueryHierarchy(function(e){a._queryHierarchy=e;a._store.beginGetRecentWorkItems(function(h){a._recentWorkItems=h;a._recentWorkItemsChangedDelegate=f(a,a._onRecentWorkItemsChanged);a._recentWorkItems.attachChanged(a._recentWorkItemsChangedDelegate);a._workItemManager=c.store.workItemManager;a._workItemManager.attachWorkItemChanged(a._workItemChangedDelegate);function e(){d._myFavorites&&(!d._options.tfsContext.currentTeam||d._teamFavorites)&&(!d._options.tfsContext.currentTeam||d._homepagePins)&&i()}function i(){d.populate();b.logTracePoint("QueryFolderTree.refresh.complete");d._fire("query-hierarchy-refresh-done")}g.FavoriteStore.beginGetFavoriteStore(a._options.tfsContext,8,null,g.FavoriteStore.FAVORITE_STORE_SCOPE_FAVORITE_QUERIES,r.MyFavoritesText,false,function(b){a._myFavorites=b;e()});if(a._options.tfsContext.currentTeam){a._enableTeamActions=a._options.tfsContext.currentUserHasTeamPermission;g.FavoriteStore.beginGetFavoriteStore(a._options.tfsContext,16,a._options.tfsContext.currentTeam.identity.id,g.FavoriteStore.FAVORITE_STORE_SCOPE_FAVORITE_QUERIES,r.TeamFavoritesText,false,function(b){a._teamFavorites=b;e()});g.PinStore.beginGetTeamHomepagePinStore(a._options.tfsContext,g.PinStore.PIN_STORE_SCOPE_QUERIES,"Pinned Queries",function(b){a._homepagePins=b;e()})}})})})};m.prototype._dispose=function(){if(this._workItemManager){this._workItemManager.detachWorkItemChanged(this._workItemChangedDelegate);this._workItemManager=null}if(this._recentWorkItems){this._recentWorkItems.detachChanged(this._recentWorkItemsChangedDelegate);this._recentWorkItems=null}this._project=null;this._store=null;this._queryHierarchy=null;p.prototype._dispose.call(this)};m.prototype.beginRefresh=function(d,g,b){var a=this,e=false,c=false,f=false;this._queryHierarchy.beginRefresh(function(){function h(){e&&(!a._teamFavorites||c)&&(!a._homepagePins||f)&&i()}function i(){d&&a._insertQueries(d);a.populate();a._fire("query-hierarchy-refresh-done");$.isFunction(g)&&g.call(a)}if(a._myFavorites){a._myFavorites.beginRefresh(function(){e=true;h()},b);a._teamFavorites&&a._teamFavorites.beginRefresh(function(){c=true;h()},b);a._homepagePins&&a._homepagePins.beginRefresh(function(){f=true;h()},b)}else i()},b)};m.prototype.populate=function(){var a=this;this.rootNode.clear();this._favItemsMap={};this._teamFavItemsMap={};this._pinItemsMap={};if(this._options.tfsContext.standardAccessMode===true){F.walkTree.call(this._myFavorites,function(b){if(b.type===g.FavoriteItem.FAVITEM_TYPE_WIT_QUERYITEM)a._favItemsMap[b.data]=b});this._teamFavorites&&F.walkTree.call(this._teamFavorites,function(b){if(b.type===g.FavoriteItem.FAVITEM_TYPE_WIT_QUERYITEM)a._teamFavItemsMap[b.data]=b});this._homepagePins&&F.walkTree.call(this._homepagePins,function(b){if(b.type===g.FavoriteItem.FAVITEM_TYPE_WIT_QUERYITEM)a._pinItemsMap[b.data]=b})}this._updateTreeNode(this.rootNode,this._queryHierarchy);this._draw()};m.prototype._updateNode=function(j,e,f){var c,m,k,b=e,a=e;c=p.prototype._updateNode.call(this,j,b,f);if(this._pinItemsMap)for(var i=b.children.length==0?1:b.children.length,g=0;g<i;g++){var d,h=l.getDefault().currentUserHasTeamAdminPermission;a=b.children.length>0?b.children[g]:b;if(this._pinItemsMap[a.queryId]&&!a.folder&&(a.queryItem||a.favoriteItem&&f>0))d=$("<span />").addClass("icon icon-pin").attr("title",r.UnpinFromHomepageTitle).addClass(h?"":"icon-disabled");d&&f>0&&!a.folder&&!e.folder&&d.appendTo(c)}return c};m.prototype.findNodesByQueryId=function(a){return this._findNodesByField(a,"queryId")};m.prototype.findNodesByWorkItemId=function(a){return a===0||!this._recentItemsFolderNode?null:a>0?this._findNodesByField(a,"workItemId",this._recentItemsFolderNode):this._findNodesByField(a,"workItemTempId",this._recentItemsFolderNode)};m.prototype.findNodesByNewQueryId=function(b){var a=[];F.walkTree.call(this.rootNode,function(c){c.queryItem&&!c.queryId&&c.queryItem.newQueryId===b&&a.push(c)});return a};m.prototype.findNodesByQuery=function(b){var a=[];if(b.id)a=this.findNodesByQueryId(b.id);if(a.length===0&&b.newQueryId)a=this.findNodesByNewQueryId(b.newQueryId);return a};m.prototype.updateLinks=function(a){if(this._queryAction!==a){this._queryAction=a;this._updateNodeLink(this.rootNode);this._draw()}};m.prototype.onItemClick=function(a,h,e){var b,c,d,f=l.getDefault().currentUserHasTeamAdminPermission;c=$(e.target);if(c.hasClass("icon-pin")&&f){var i=this._element.scrollTop();this._deleteHomePagePin(a.queryId);this._element.scrollTop(i);var g={QueryId:a.queryId,UnpinLocation:"QueryPageUnpinIcon",TeamId:l.getDefault().currentTeam.identity.id};k.customerIntelligence.publishProperties(j.HOMEPAGE_PINNING_AREA,"UnpinQuery",g);b=false}else if(c.hasClass("quick-delete")){x.menuManager.executeCommand(new Sys.CommandEventArgs("delete-query",{project:this._project,queryPath:a.queryItem&&a.queryItem.path()},null));b=false}else if(c.hasClass("recent-item-remove")){if(this._recentWorkItems){if(a.workItemTempId){d=this._workItemManager.getWorkItem(a.workItemTempId);if(d)if(!k.ActionManager.performAction(E.WorkItemActions.ACTION_WORKITEM_DISCARD_IF_NEW,{workItem:d}))return}this._recentWorkItems.removeRecentById(a.recentWorkItemItemId)}b=false}else{b=p.prototype.onItemClick.call(this,a,h,e);a&&a.folder&&e.preventDefault()}return b};m.prototype.toggleMyFavorite=function(a){var b=this._getNodeFavItem(a);if(b)b.beginDelete();else this._myFavorites.beginCreateNewItem(a.text,g.FavoriteItem.FAVITEM_TYPE_WIT_QUERYITEM,a.queryItem.id)};m.prototype.setSelectedNode=function(a){if(a&&a.config&&a.config.unselectable)return;p.prototype.setSelectedNode.call(this,a)};m.prototype.onShowPopupMenu=function(e,f){var d,b=[];if(e.nodeType==="QueryItem"){d=e.queryItem;if(d instanceof c.QueryFolder){if(d.specialFolder)b.push({id:"new-query",text:a.NewQuery,icon:"icon-tfs-query-new"},{id:"new-query-folder",text:a.NewQueryFolder,icon:"icon-new-folder"});else b.push({id:"new-query",text:a.NewQuery,icon:"icon-tfs-query-new"},{id:"new-query-folder",text:a.NewQueryFolder,icon:"icon-new-folder"},{separator:true},{id:"delete-query",text:a.DeleteQuery,icon:"icon-delete"},{id:"rename-query",text:a.RenameQuery,icon:"icon-rename"});if(!d.personal){b.push({separator:true});b.push(o.security())}}else if(d.specialQuery){b.push({id:"run-query",text:a.RunQuery,title:a.RunQuery,icon:"icon-tfs-query-run"});if(!c.QueryDefinition.isUnsavedWorkItems(d)){b.push({id:"edit-query",text:a.EditQuery,icon:"icon-tfs-query-edit"});this._options.tfsContext.standardAccessMode===true&&b.push({separator:true},{id:"save-query-as",text:a.SaveQueryAs,icon:"icon-save-as"})}}else{b.push({id:"run-query",text:a.RunQuery,title:a.RunQuery,icon:"icon-tfs-query-run"},{id:"edit-query",text:a.EditQuery,icon:"icon-tfs-query-edit"},{separator:true},{id:"delete-query",text:a.DeleteQuery,icon:"icon-delete"});if(d.id)b.push({id:"rename-query",text:a.RenameQuery,icon:"icon-rename"});else d.newQueryId&&this._options.tfsContext.standardAccessMode===true&&b.push({id:"save-query-as",text:a.SaveQueryAs,icon:"icon-save-as"})}if(!d.specialQuery&&!d.specialFolder&&d.id&&!(d instanceof c.QueryFolder)){b.push({separator:true});if(this._getNodeFavItem(e))b.push(o.removeFromMyFavs());else b.push(o.addToMyFavs());if(this._enableTeamActions)if(this._teamFavItemsMap[d.id])b.push(o.removeFromTeamFavs(!l.getDefault().currentUserHasTeamAdminPermission));else!e.queryItem.personal&&b.push(o.addToTeamFavs(!l.getDefault().currentUserHasTeamAdminPermission));if(this._enableTeamActions&&!e.queryItem.personal&&this._homepagePins){b.push({separator:true});if(this._pinItemsMap[d.id])b.push(o.unpinFromHomePage(!this._homepagePins.canEdit()));else b.push(o.pinToHomePage(!this._homepagePins.canEdit()))}if(!d.personal){b.push({separator:true});b.push(o.security())}}}f=$.extend({},f,{items:b});p.prototype.onShowPopupMenu.call(this,e,f)};m.prototype._attachEvents=function(){this._bind(window,"query-item-removed query-item-renamed query-item-created query-item-saved query-item-moved",f(this,this._onQueryHierarchyEvent),true);this._bind(window,"favorite-item-removed favorite-item-renamed favorite-item-created favorite-item-saved",f(this,this._onFavoriteItemEvent),true);this._bind(window,"query-provider-dirty-state-changed",f(this,this._onProviderStateChanged),true)};m.prototype._enableDragDrop=function(a){b.assertParamIsObject(a,"options");var c=this;a.draggable=$.extend({scroll:false,dropBehaviour:false,appendTo:document.body,scrollables:[".query-folder-tree"],distance:20,helper:function(a){return c._draggableHelper(this,a)},start:function(){var a=$(this).data(i.TreeView.NODE_DATA_NAME);if(!a.queryItem.id)return false;c.enableFocusStyling(false)},stop:function(){c.enableFocusStyling(true)}},a.draggable);a.droppable=$.extend({hoverClass:"droppable-hover",tolerance:"pointer",accept:function(a){return c._droppableAccept(this,a)},drop:function(a,b){return c._droppableDrop(this,a,b)},greedy:true},a.droppable)};m.prototype._draggableHelper=function(a,g){b.assertParamIsObject(a,"draggableTreeNodeElement");b.assertParamIsObject(g,"event");var c=$.extend({},$(a).data(i.TreeView.NODE_DATA_NAME)),f=$(a).data(i.TreeView.LEVEL_DATA_NAME),d=$("<li />").addClass("tree-drag-tile"),e;c.expanded=false;c.selected=false;c.droppable=false;e=this._updateNode(d,c,f);d.css("width",a.clientWidth);return d};m.prototype._droppableAccept=function(f,h){b.assertParamIsObject(f,"droppableTreeNodeElement");b.assertParamIsJQueryObject(h,"$draggable");var d=$(f).data(i.TreeView.NODE_DATA_NAME),a=h.data(i.TreeView.NODE_DATA_NAME),e;if(!a)return false;if(d.folder){if(a.queryItem instanceof c.QueryItem){e=n.peek(a.queryItem);if(e&&e.isDirty())return false}return d.favoriteItem instanceof g.FavoriteFolder?a.queryItem.personal&&d.favoriteItem===this._teamFavorites||a.folder?false:true:true}return false};m.prototype._droppableDrop=function(p,v,s){b.assertParamIsObject(p,"droppable");b.assertParamIsObject(v,"event");b.assertParamIsObject(s,"ui");var r=this,t=$(p),d=t.data(i.TreeView.NODE_DATA_NAME),f=s.draggable[0],c=$(f).data(i.TreeView.NODE_DATA_NAME),u=c.parent,q=c.text,j,m,o,n,k=function(d,a){c.text=q;r._moveTreeNode(c,u);var b=a.message?a.message:a,f=e.StringUtils.format(d,q,b);h.errorHandler.showError(f)},l=function(b){c.text=e.StringUtils.format(a.MovingQueryLabel,b);r.updateNode(c)};if(d.favoriteItem instanceof g.FavoriteFolder){if(d.favoriteItem.findByData(c.queryItem.id)!==null)return true;l(c.text);d.favoriteItem.beginCreateNewItem(c.text,g.FavoriteItem.FAVITEM_TYPE_WIT_QUERYITEM,c.queryItem.id,function(){},function(b){k(a.DragFavoriteFailed,b)})}else if(d.folder){m=$(f).data("ui-draggable");if(d===c.parent)return true;if(!c.queryItem.personal&&d.queryItem.personal){n=c.queryItem.path(false).split("/")[0];o=d.queryItem.path(false).split("/")[0];if(!confirm(e.StringUtils.format(a.QueryConfirmDragDropOperation,n,o)))return true}!c.queryItem.personal&&d.personal&&this._deleteHomePagePin(c.queryId);j=this._createNewItemName(c,d);l(j);this._moveTreeNode(c,d);this._expandFromRoot(c);this._bringQueryElementToView(c.queryItem);$(f).data("ui-draggable",m);c.queryItem.beginMove(j,d.queryItem,function(){$(f).removeData("ui-draggable")},function(b){k(a.DragQueryMoveFailed,b)})}return true};m.prototype._deleteHomePagePin=function(a){if(this._pinItemsMap&&this._pinItemsMap[a]){this._pinItemsMap[a].beginDelete(null,null,true);this.updateNode(this.rootNode)}};m.prototype._createNewItemName=function(c,f){b.assertParamIsObject(c,"sourceTreeNode");b.assertParamIsObject(f,"destTreeNode");var d=c.queryItem.name,g=1;while(f.queryItem.findByPath(d)!==null)d=e.StringUtils.format(a.CopyNameTemplate,c.queryItem.name,g++);return d};m.prototype._moveTreeNode=function(a,c){b.assertParamIsObject(a,"sourceTreeNode");b.assertParamIsObject(c,"destTreeNode");var d=a.parent;a.moveTo(c);this.updateNode(c);this.updateNode(d)};m.prototype._insertQueries=function(f){b.assertParamIsObject(f,"queriesToInsert");var e,i,a,d,c,h,j,g;for(e=0,i=f.length;e<i;e++){a=f[e];c=a.path();d=c.lastIndexOf("/");if(d>=0){h=c.substring(0,d);j=c.substring(d+1);g=this._queryHierarchy.findByPath(h);g&&g.add(a)}else this._queryHierarchy.add(a)}};m.prototype._populateTreeNode=function(f,b){var a,e=0;if(b instanceof c.QueryItem&&b.id&&c.QueryDefinition.isUnsavedWorkItems(b))e=this._dirtyWorkItemsCount;a=d.TreeNode.create(b.name);a=this._updateTreeNode(a,b,e);a&&f.add(a);return a};m.prototype._updateTreeNode=function(b,d,r){var i,m,h,p,j=[],f,l;function o(b){var a=[].concat(b);a.sort(function(b,a){if(b instanceof c.QueryFolder){if(!(a instanceof c.QueryFolder))return-1*f.sortModifier}else if(a instanceof c.QueryFolder)return 1*f.sortModifier;return b.sortPrefix===a.sortPrefix?e.StringUtils.localeIgnoreCaseComparer(b.name,a.name):b.sortPrefix-a.sortPrefix});return a}function q(b,d){var a=[];$.each(b,function(e,b){b instanceof c.QueryFolder===d&&a.push(b)});return a}b.text=d.name;b.clear();if(r){b.text=e.StringUtils.format("{0} ({1})",b.text,r);j.push("query-with-count")}if(d instanceof c.QueryItem){b.nodeType="QueryItem";f=d;b.queryPath=f.path();b.queryId=f.id;b.queryItem=d;this._getNodeFavItem(b)&&j.push("starred");p=n.peek(f);p&&p.isDirty()&&j.push("dirty-query");if(f instanceof c.QueryFolder){b.folder=true;b.config.unselectable=true;b.droppable=true;f.specialFolder&&f.personal&&j.push("top-separator");if(f.children){if(f instanceof c.QueryHierarchy&&this._options.tfsContext.standardAccessMode===true){h=[].concat(o(q(f.children,false)));h.push(this._recentWorkItems);h.push(this._myFavorites);this._teamFavorites&&h.push(this._teamFavorites);h=h.concat(o(q(f.children,true)))}else h=o(f.children);for(i=0,m=h.length;i<m;i++)this._populateTreeNode(b,h[i])}}else b.link=k.urlHelper.getFragmentActionLink(this._queryAction,{path:b.queryPath})}else if(d instanceof g.FavoriteItem){l=d;b.nodeType="FavoriteItem";b.favoriteId=d.id;b.favoriteItem=d;if(l instanceof g.FavoriteFolder){b.folder=true;b.expanded=true;b.noContextMenu=true;b.config.unselectable=true;b.droppable=true;if(l.root)if(l.favStore===this._myFavorites){j.push("top-separator");b.emptyFolderNodeText=a.NoMyFavoriteQueries}else b.emptyFolderNodeText=a.NoTeamFavoriteQueries;if(l.children){h=[].concat(l.children);h.sort(function(b,a){if(b instanceof g.FavoriteFolder){if(!(a instanceof g.FavoriteFolder))return-1}else if(a instanceof g.FavoriteFolder)return 1;return e.StringUtils.localeIgnoreCaseComparer(b.name,a.name)});for(i=0,m=h.length;i<m;i++)this._populateTreeNode(b,h[i])}}else{f=this._queryHierarchy.findQueryById(l.data);if(f){this._updateTreeNode(b,f);b.itemId=d.id;b.title=f.path(false,"\\");return b}else return null}}else if(d instanceof c.RecentWorkItem){b.nodeType="RecentWorkItem";b.noContextMenu=true;b.recentWorkItemItemId=d.id||d.tempId||0;b.workItemId=d.id;b.workItemTempId=d.tempId;if(d instanceof c.RecentWorkItems){this._recentItemsFolderNode=b;b.folder=true;b.config.unselectable=true;j.push("top-separator");h=d.children;if(h.length===0)j.push("empty");else for(i=0,m=h.length;i<m;i++)this._populateTreeNode(b,h[i])}else{b.title=d.title;if(d.id>0)b.link=k.urlHelper.getFragmentActionLink("edit",{id:d.id});else b.link=k.urlHelper.getFragmentActionLink("new",{id:-d.tempId,witd:d.workItemTypeName,project:d.projectName})}}if(b.queryItem&&!(b.queryItem.parent instanceof c.QueryHierarchy)&&!b.favoriteItem)b.draggable=true;b.config.css=j.join(" ");return b};m.prototype._findNodesByField=function(d,a,c){var b=[];a=a||"id";F.walkTree.call(c||this.rootNode,function(c){e.StringUtils.localeIgnoreCaseComparer(d,c[a])===0&&b.push(c)});return b};m.prototype._getNodeFavItem=function(b){var a;if(b.queryId)a=this._favItemsMap[b.queryId];return a};m.prototype._onProviderStateChanged=function(c,a){var b=this;a.queryDefinition&&$.each(this.findNodesByQuery(a.queryDefinition),function(d,c){if(c.nodeType==="QueryItem"){b._updateTreeNode(c,a.queryDefinition);b.updateNode(c)}})};m.prototype._onQueryHierarchyEvent=function(d,a){var c=this,b;switch(d.type){case"query-item-removed":$.each(this.findNodesByQuery(a),function(b,a){if(a.nodeType==="QueryItem"){c.removeNode(a);a.parent&&c.updateNode(a.parent)}});b=this._favItemsMap[a.id];b&&b.beginDelete();b=this._teamFavItemsMap&&this._teamFavItemsMap[a.id];b&&b.beginDelete();break;case"query-item-saved":$.each(this.findNodesByQuery(a),function(d,b){c._updateTreeNode(b,a);c.updateNode(b)});break;case"query-item-moved":this._updateChildrenOfQueryParent(a.oldParent,false);this._updateChildrenOfQueryParent(a.queryItem.parent,true);this._bringQueryElementToView(a.queryItem);this._updateFavoritesSection(a.queryItem);!a.oldParent.personal&&a.queryItem.personal&&this._deleteHomePagePin(a.queryItem.id);break;case"query-item-renamed":case"query-item-created":this._updateChildrenOfQueryParent(a.parent,false);this._updateFavoritesSection(a)}};m.prototype._updateChildrenOfQueryParent=function(a,d){b.assertParamIsObject(a,"queryParent");b.assertParamIsBool(d,"expand");var c=this;a&&$.each(this.findNodesByQueryId(a.id),function(e,b){c._updateTreeNode(b,a);c.updateNode(b);d&&c._expandFromRoot(b)})};m.prototype._bringQueryElementToView=function(a){b.assertParamIsObject(a,"query");var c=this;$.each(this.findNodesByQueryId(a.id),function(d,b){var a;a=$(c._getNodeElement(b));$("#container",c._element).scrollTop(a.position().top)})};m.prototype._expandFromRoot=function(a){b.assertParamIsObject(a,"treeNode");a.parent!==null&&this._expandFromRoot(a.parent);this._setNodeExpansion(a,$(this._getNodeElement(a)),true)};m.prototype._updateFavoriteEntry=function(c,a){b.assertParamIsObject(c,"treeNode");b.assertParamIsObject(a,"favoriteItem");if(a.favStore===this._teamFavorites&&c.queryItem.personal)a.beginDelete();else{this._updateTreeNode(c,a);this.updateNode(c)}};m.prototype._updateFavoritesSection=function(d){b.assertParamIsObject(d,"queryItem");var a=this,e,f=function(c){var b,d,f=function(c,b){a._updateFavoriteEntry(b,e)};if(c)for(b=0,d=c.children.length;b<d;b++){e=c.children[b];$.each(a._findNodesByField(e.id,"favoriteId"),f)}},g=function(){a._favItemsMap&&a._teamFavItemsMap&&$.each([a._favItemsMap[d.id],a._teamFavItemsMap[d.id]],function(c,b){b&&$.each(a._findNodesByField(b.id,"favoriteId"),function(d,c){a._updateFavoriteEntry(c,b)})})};if(d instanceof c.QueryFolder){f(this._myFavorites);f(this._teamFavorites)}else g()};m.prototype._updateFavoriteItemNode=function(a){var b=this;a&&$.each(this._findNodesByField(a.id,"favoriteId"),function(d,c){b._updateTreeNode(c,a);b.updateNode(c)})};m.prototype._onFavoriteItemEvent=function(c,a){var b=this;switch(c.type){case"favorite-item-removed":if(a.favStore===this._myFavorites)delete this._favItemsMap[a.data];else if(a.favStore===this._teamFavorites)delete this._teamFavItemsMap[a.data];else if(a.favStore===this._homepagePins)delete this._pinItemsMap[a.data];else console.log("Favorite item is from an unknown store");$.each(this._findNodesByField(a.id,"favoriteId"),function(c,a){b.removeNode(a);a.parent&&b.updateNode(a.parent)});$.each(b._findNodesByField(a.data,"queryId"),function(e,c){var d=b._queryHierarchy.findQueryById(a.data);b._updateTreeNode(c,d);b.updateNode(c)});break;case"favorite-item-renamed":case"favorite-item-created":if(a.favStore===this._myFavorites)this._favItemsMap[a.data]=a;else if(a.favStore===this._teamFavorites)this._teamFavItemsMap[a.data]=a;else if(a.favStore===this._homepagePins)this._pinItemsMap[a.data]=a;else console.log("Favorite item is from an unknown store");a.parent&&$.each(this._findNodesByField(a.parent.id,"favoriteId"),function(d,c){b._updateTreeNode(c,a.parent);b.updateNode(c)});$.each(this._findNodesByField(a.data,"queryId"),function(e,c){var d=b._queryHierarchy.findQueryById(a.data);b._updateTreeNode(c,d);b.updateNode(c)})}};m.prototype._onWorkItemChanged=function(){var d,a,b=this._workItemManager.getDirtyWorkItems().length;if(b!==this._dirtyWorkItemsCount){this._dirtyWorkItemsCount=b;d=this.findNodesByQueryId(c.QueryDefinition.UNSAVED_WORKITEMS_ID);if(d.length>0){a=d[0];this._updateTreeNode(a,a.queryItem,b);this.updateNode(a)}}};m.prototype._onRecentWorkItemsChanged=function(){var a=this;$.each(this._findNodesByField(0,"recentWorkItemItemId",this._recentItemsFolderNode),function(c,b){a._updateTreeNode(b,a._recentWorkItems);a.updateNode(b)})};m.prototype._updateNodeLink=function(a){var d,f,b,e;b=a.queryItem;if(b&&!(b instanceof c.QueryFolder)){e=c.QueryDefinition.isUneditableQuery(b)?"query":this._queryAction;if(c.QueryDefinition.isCustomWiqlQuery(b))a.link=k.urlHelper.getFragmentActionLink(e,{path:a.queryPath,wiql:b.queryText,name:b.name});else a.link=k.urlHelper.getFragmentActionLink(e,{path:a.queryPath})}if(a.children)for(d=0,f=a.children.length;d<f;d++)this._updateNodeLink(a.children[d])};m.prototype._onPopupItemClick=function(c){var f=c.get_commandName(),a=c.get_commandArgument(),b;switch(f){case o.ADD_TO_MY_FAVORITES_ACTION:this._myFavorites.beginCreateNewItem(a.item.text,g.FavoriteItem.FAVITEM_TYPE_WIT_QUERYITEM,a.item.queryItem.id);return false;case o.REMOVE_FROM_MY_FAVORITES_ACTION:b=this._getNodeFavItem(a.item);b&&b.beginDelete();return false;case o.ADD_TO_TEAM_FAVORITES_ACTION:this._teamFavorites.beginCreateNewItem(a.item.text,g.FavoriteItem.FAVITEM_TYPE_WIT_QUERYITEM,a.item.queryItem.id);return false;case o.REMOVE_FROM_TEAM_FAVORITES_ACTION:b=this._teamFavItemsMap[a.item.queryItem.id];b&&b.beginDelete();return false;case o.PIN_TO_HOMEPAGE_ACTION:this._homepagePins.beginCreateNewItem(a.item.text,g.FavoriteItem.FAVITEM_TYPE_WIT_QUERYITEM,a.item.queryItem.id);var e={QueryId:a.item.queryItem.id,PinLocation:"QueryPageMenuItem",TeamId:l.getDefault().currentTeam.identity.id};k.customerIntelligence.publishProperties(j.HOMEPAGE_PINNING_AREA,"PinQuery",e);return false;case o.UNPIN_FROM_HOMEPAGE_ACTION:b=this._pinItemsMap[a.item.queryItem.id];b&&b.beginDelete();var d={QueryId:a.item.queryItem.id,UnpinLocation:"QueryPageMenuItem",TeamId:l.getDefault().currentTeam.identity.id};k.customerIntelligence.publishProperties(j.HOMEPAGE_PINNING_AREA,"UnpinQuery",d);return false}};m._typeName="tfs.wit.queryfoldertree";return m}(i.TreeView);j.QueryFolderTree=J;h.initClassPrototype(J,{_store:null,_project:null,_recentWorkItems:null,_workItemManager:null,_queryHierarchy:null,_myFavorites:null,_favItemsMap:null,_teamFavItemsMap:null,_teamFavorites:null,_enableTeamActions:false,_queryAction:"query",_dirtyWorkItemsCount:0,_workItemChangedDelegate:null,_recentWorkItemsChangedDelegate:null,_recentItemsFolderNode:null});h.classExtend(J,l.ControlExtensions);var N=function(h){__extends(g,h);function g(a){var b=this;h.call(this,a);this._refreshDelegate=f(this,this._refresh);this._refreshMenuBarDelegate=function(){return b._refreshMenuBar()}}g.prototype.initializeOptions=function(a){h.prototype.initializeOptions.call(this,$.extend({coreCssClass:"query-editor",infoBar:true},a))};g.prototype._dispose=function(){if(this._queryProvider){this._queryProvider.detachEvent(m.EVENT_REFRESH_REQUIRED,this._refreshDelegate);this._queryProvider.detachEvent(n.EVENT_QUERY_RESULTS_MODEL_CHANGED,this._refreshDelegate);this._queryProvider=null}h.prototype._dispose.call(this)};g.prototype.setProvider=function(a,d,b,e){if(this._queryProvider){this._queryProvider.detachEvent(m.EVENT_REFRESH_REQUIRED,this._refreshDelegate);this._queryProvider.detachEvent(n.EVENT_QUERY_RESULTS_MODEL_CHANGED,this._refreshDelegate)}this._queryProvider=a;this._queryProvider.attachEvent(m.EVENT_REFRESH_REQUIRED,this._refreshDelegate);this._queryProvider.attachEvent(n.EVENT_QUERY_RESULTS_MODEL_CHANGED,this._refreshDelegate);this._bind(window,"query-provider-dirty-state-changed",this._refreshMenuBarDelegate,true);this._queryAdapter=a.project.store.tfsConnection.getService(c.QueryAdapter);this._menubar.updateMenuItemStates();this._refresh(d,b,e)};g.prototype.getProvider=function(){return this._queryProvider};g.prototype.scrollIntoView=function(a){this._grid.getSelectedRowIntoView(a)};g.prototype.saveQuery=function(){this._queryProvider.beginSave()};g.prototype.runQuery=function(){var a=this;this.showBusyOverlay();this._queryProvider.invalidateResults();this.setProvider(this._queryProvider,function(){b.logTracePoint("QueryEditor.runQuery.complete");a.hideBusyOverlay()})};g.prototype.revert=function(){this._queryProvider.revertEditInfo();this.setProvider(this._queryProvider,function(){b.logTracePoint("QueryEditor.revert.complete")})};g.prototype._createElement=function(){var m,g,l,f,k,j,c,e=this;c=d.getId();h.prototype._createElement.call(this);this._toolbarHost=this._createToolbarHost();this._menubar=this._createMenuBar(this._toolbarHost);m=this._createQueryTypeHost();this._splitter=this._createSplitter();this._filters=$("<div />").addClass("filters").appendTo(this._splitter.leftPane);g=this._createFieldSetHeader(a.QueryEditorSourceFilterGroupingText,"source");this._sourceFilter=d.BaseControl.createIn(y,g,{cssClass:"source-filter",tfsContext:this._options.tfsContext});this._filters.append(g);this._linkFiltersHost=$("<div />").addClass("link").hide();g=this._createFieldSetHeader(a.FiltersForLinkedWorkItems,"link");this._linkFilter=d.BaseControl.createIn(y,g,{cssClass:"link-filter",tfsContext:this._options.tfsContext});this._linkFiltersHost.append(g);l=$("<div />").addClass("query-mode").appendTo(this._linkFiltersHost);$("<label />").text(a.QueryEditorQueryModeLabel||"").attr("for",c+"_queryMode").appendTo(l);this._linkFilterModeSelect=$("<select />").addClass("textbox").attr("id",c+"_queryMode").append($("<option />").attr("value",p.LinksMustContain).text(a.QueryEditorQueryModeMustHave||"")).append($("<option />").attr("value",p.LinksMayContain).text(a.QueryEditorQueryModeMayHave||"")).append($("<option />").attr("value",p.LinksDoesNotContain).text(a.QueryEditorQueryModeDoesNotContain||"")).change(function(){e._updateQueryMode()}).appendTo(l);f=$("<div />").addClass("link-types").appendTo(this._linkFiltersHost);$("<label />").text(a.QueryEditorLinkTypeLabel||"").attr("for",c+"_linkTypes").appendTo(f);f.append($("<br />"));this._linkFiltersLinkTypesAny=$("<input/>").attr("type","radio").attr("name","link-types-radio").attr("id",c+"_linkTypesAny").click(function(){e._linkFiltersLinkTypes.enableElement(false);e._linkFilterLinkTypeChanged("")}).appendTo(f);$("<label />").text(a.ReturnLinksOfAnyType).attr("for",c+"_linkTypesAny").appendTo(f);f.append($("<br />"));this._linkFiltersLinkTypesSelected=$("<input/>").attr("type","radio").attr("name","link-types-radio").attr("id",c+"_linkTypesSelected").click(function(){e._linkFiltersLinkTypes.enableElement(true);e._linkFilterLinkTypeChanged(e._linkFiltersLinkTypes.getCheckedValues().join(","))}).appendTo(f);$("<label />").text(a.ReturnSelectedLinkTypes).attr("for",c+"_linkTypesSelected").appendTo(f);this._linkFiltersLinkTypes=d.BaseControl.createIn(i.CheckboxList,f,{id:c+"_linkTypes",cssClass:"link-types",change:function(){e._linkFilterLinkTypeChanged(e._linkFiltersLinkTypes.getCheckedValues().join(","))}});this._filters.append(this._linkFiltersHost);this._treeFiltersHost=$("<div />").addClass("tree").hide();g=this._createFieldSetHeader(a.QueryEditorTargetFilterGroupingText,"tree");this._treeFilter=d.BaseControl.createIn(y,g,{cssClass:"tree-filter",tfsContext:this._options.tfsContext});this._treeFiltersHost.append(g);k=$("<div />").addClass("query-mode").appendTo(this._treeFiltersHost);$("<label />").text(a.QueryEditorQueryModeLabel||"").attr("for",c+"_treeQueryMode").appendTo(k);this._treeFilterModeSelect=$("<select />").addClass("textbox").attr("id",c+"_treeQueryMode").append($("<option />").attr("value",p.LinksRecursive).text(a.QueryEditorQueryMatchTopLevelItems||"")).append($("<option />").attr("value",p.LinksRecursiveReturnMatchingChildren).text(a.QueryEditorQueryMatchLinkedItems||"")).change(function(){e._updateQueryMode()}).appendTo(k);j=$("<div />").addClass("link-types").appendTo(this._treeFiltersHost);$("<label />").text(a.QueryEditorTreeTypeLabel||"").attr("for",c+"_treeType").appendTo(j);this._treeFiltersLinkTypes=$("<select />").addClass("textbox").attr("id",c+"_treeType").change(function(){e._updateTreeLinkType()}).appendTo(j);this._filters.append(this._treeFiltersHost);if(this._options.infoBar===true)this._gridInfoBar=d.BaseControl.createIn(w,this._splitter.rightPane,{cssClass:"work-item-list-info",tfsContext:this._options.tfsContext});else this._gridInfoBar=this._options.infoBar;this._gridToolbar=this._createResultGridToolbar(this._splitter.rightPane);this._grid=this._createQueryResultGrid(this._splitter.rightPane);this._grid.setNavigator(this._options.workItemsNavigator);this._gridInfoBar&&this._gridInfoBar.bind(this._grid);this._gridToolbar.bind(this._grid);b.logTracePoint("QueryEditor._createElement.complete")};g.prototype.showElement=function(){h.prototype.showElement.call(this);this._splitter.attachResize(true)};g.prototype.hideElement=function(){this._splitter.detachResize();h.prototype.hideElement.call(this)};g.prototype._createSplitter=function(){return d.BaseControl.createIn(i.Splitter,this._element,{cssClass:"content",fixedSide:"right",splitWidth:"350px",handleBarWidth:"5px"})};g.prototype._createQueryTypeHost=function(){var c=this,b=$("<div />").addClass("query-type").appendTo(this._element);this._queryTypeItems=this._createQueryTypeItems();this._queryType=d.BaseControl.createIn(Z.PivotFilter,b,{behavior:"radio",text:a.QueryEditorQueryTypeLabel,items:this._queryTypeItems,change:function(){c._updateQueryMode();return false}});return b};g.prototype._createFieldSetHeader=function(b,c){var a=$("<fieldset />").addClass(c);$("<legend />").text(b||"").appendTo(a);return a};g.prototype._createToolbarHost=function(){return $("<div />").addClass("toolbar").appendTo(this._element)};g.prototype._createQueryTypeItems=function(){var b=[];b.push({value:"flat",text:a.QueryEditorQueryTypeSimple,icon:"icon query-type-flat",selected:true,disabled:true});if(this._options.tfsContext.standardAccessMode===true){b.push({value:"link",text:a.QueryEditorQueryTypeLink,icon:"icon query-type-link",disabled:true});b.push({value:"tree",text:a.QueryEditorQueryTypeTree,icon:"icon query-type-tree",disabled:true})}return b};g.prototype._createResultGridToolbar=function(b){var a;a=d.BaseControl.createIn(u,b,{cssClass:"work-item-list-toolbar",tfsContext:this._options.tfsContext,hideFilter:true});return a};g.prototype._createQueryResultGrid=function(a){return d.BaseControl.createIn(s,a,{cssClass:"work-item-list",tfsContext:this._options.tfsContext})};g.prototype._getGrid=function(){return this._grid};g.prototype._getModel=function(){return this._model};g.prototype._refreshMenuBar=function(){this._menubar.updateMenuItemStates()};g.prototype._refresh=function(d,c,b){var a=this;function e(e){a._queryAdapter.beginEnsureFields(function(){a._queryAdapter.beginGetRecursiveLinkTypes(function(){a._queryAdapter.beginGetOneHopLinkTypes(function(){a._updateFilters(e);a._updateQueryTypes();b&&b.statusText&&a._grid.setStatusText(b.statusText);a._grid.beginShowResults(a._queryProvider,function(){$.isFunction(d)&&d.call(a)},c,b)},c)},c)},c)}$(this._grid).trigger("queryResultsStarting");a._queryProvider.beginGetResults(function(b){$(a._grid).trigger("queryResultsComplete");e(b)},function(b){$(a._grid).trigger("queryResultsError",b)},b&&b.runQuery)};g.prototype._updateQueryTypes=function(){var a,b;if(this._queryType&&this._queryTypeItems){for(a=0,b=this._queryTypeItems.length;a<b;a++)this._queryTypeItems[a].disabled=false;this._queryType.updateItems(this._queryTypeItems)}};g.prototype._updateQueryMode=function(){var a=this._model.editInfo.mode;if(!this._queryType)return;switch(this._queryType.getSelectedItem().value){case"link":this._model.editInfo.mode=+this._linkFilterModeSelect.val();break;case"tree":this._model.editInfo.mode=+this._treeFilterModeSelect.val();break;default:this._model.editInfo.mode=p.WorkItems}this._updateUI();this._model.editInfo.mode!==a&&this._queryProvider.setDirty(true)};g.prototype._updateFilters=function(a){var b;this._model=a;b=this._queryProvider.project.store.getFieldDefinition(25);a.editInfo.sourceFilter=a.editInfo.sourceFilter||{};a.editInfo.treeTargetFilter=a.editInfo.treeTargetFilter||{clauses:[{logicalOperator:q.WiqlOperators_And,fieldName:b.name,operator:q.WiqlOperators_EqualTo,value:q.WiqlOperators_Any}]};a.editInfo.linkTargetFilter=a.editInfo.linkTargetFilter||{clauses:[{logicalOperator:q.WiqlOperators_And,fieldName:b.name,operator:q.WiqlOperators_EqualTo,value:q.WiqlOperators_Any}]};this._sourceFilter.setProviderAndFilter(this._queryProvider,this._model.editInfo.sourceFilter);this._treeFilter.setProviderAndFilter(this._queryProvider,this._model.editInfo.treeTargetFilter);this._linkFilter.setProviderAndFilter(this._queryProvider,this._model.editInfo.linkTargetFilter);this._linkFilterModeSelect.val(p.LinksMustContain);this._populateOneHopLinkTypes();if(this._model.editInfo.linkTypes){this._linkFiltersLinkTypesSelected.attr("checked",true);this._linkFiltersLinkTypes.enableElement(true);this._linkFiltersLinkTypes.setCheckedValues($.map(this._model.editInfo.linkTypes.split(","),function(a){return $.trim(a)}))}else{this._linkFiltersLinkTypesAny.attr("checked",true);this._linkFiltersLinkTypes.setCheckedValues([]);this._linkFiltersLinkTypes.enableElement(false)}this._treeFilterModeSelect.val(p.LinksRecursive);this._populateTreeLinkTypes();if(this._model.editInfo.treeLinkTypes)this._treeFiltersLinkTypes.val(this._model.editInfo.treeLinkTypes);else this._model.editInfo.treeLinkTypes=this._treeFiltersLinkTypes.val();if(this._queryType)if(p.isTreeQuery(this._model.editInfo.mode))this._queryType.setSelectedItem("tree");else if(p.isLinkQuery(this._model.editInfo.mode))this._queryType.setSelectedItem("link");else this._queryType.setSelectedItem("flat");this._updateUI()};g.prototype._updateUI=function(){if(p.isTreeQuery(this._model.editInfo.mode)){this._linkFiltersHost.hide();this._treeFilterModeSelect.val(this._model.editInfo.mode);this._treeFiltersHost.show()}else if(p.isLinkQuery(this._model.editInfo.mode)){this._treeFiltersHost.hide();this._linkFilterModeSelect.val(this._model.editInfo.mode);this._linkFiltersHost.show()}else{this._treeFiltersHost.hide();this._linkFiltersHost.hide()}};g.prototype._populateTreeLinkTypes=function(){var a=this;this._queryAdapter.beginGetRecursiveLinkTypes(function(b){a._treeFiltersLinkTypes.empty();$.each(b,function(c,b){a._treeFiltersLinkTypes.append($("<option />").text(e.StringUtils.format("{0}/{1}",b.oppositeEnd.name,b.name)).attr("value",b.name));c===0&&a._treeFiltersLinkTypes.val(b.name)})})};g.prototype._populateOneHopLinkTypes=function(){var a=this;this._queryAdapter.beginGetOneHopLinkTypes(function(c){var b=$.map(c,function(a){return a.name});b.sort(e.StringUtils.localeIgnoreCaseComparer);a._linkFiltersLinkTypes.setItems(b)})};g.prototype._updateTreeLinkType=function(){var a=this._model.editInfo.treeLinkTypes;this._model.editInfo.treeLinkTypes=this._treeFiltersLinkTypes.val();a!==this._model.editInfo.treeLinkTypes&&this._queryProvider.setDirty(true)};g.prototype._linkFilterLinkTypeChanged=function(a){var b=this._model.editInfo.linkTypes;this._model.editInfo.linkTypes=a;b!==a&&this._queryProvider.setDirty(true)};g.prototype._createMenuBar=function(a){return d.BaseControl.createIn(x.MenuBar,a,{items:this._createMenubarItems(),executeAction:f(this,this._onMenubarItemClick),getCommandState:f(this,this._getCommandState)})};g.prototype._createMenubarItems=function(){var c=this,b=[];function d(){return c._onGetMenuItemActionArguments(this)}b.push({id:"save-query",text:a.SaveQuery,showText:false,title:a.SaveQuery,icon:"icon-save"});this._options.tfsContext.standardAccessMode===true&&b.push({id:"save-query-as",text:a.SaveQueryAs,showText:false,title:a.SaveQueryAsTooltip,icon:"icon-save-as",arguments:function(){return{project:c._queryProvider.queryDefinition.project,queryPath:c._queryProvider.queryDefinition.path()}}});b.push({id:"run-query",text:a.RunQuery,showText:false,title:a.RunQuery,icon:"icon-tfs-query-run"});b.push({id:"revert-query-changes",text:a.RevertQueryChanges,showText:false,title:a.RevertQueryChanges,icon:"icon-undo",arguments:d});b.push({separator:true});b.push({id:"column-options",text:a.ColumnOptions,title:a.ColumnOptionsTooltip,noIcon:true,arguments:d});return b};g.prototype._onMenubarItemClick=function(b){var a=b.get_commandName();switch(a){case"save-query":this.saveQuery();return false;case"run-query":this.runQuery();return false;case"revert-query-changes":this.revert();return false}};g.prototype._onGetMenuItemActionArguments=function(b){var a=b.getAction();if(a==="column-options")return this._grid.getActionArguments(a)};g.prototype._getCommandState=function(a){if(a==="save-query")if(!this._queryProvider||!this._queryProvider.isDirty())return 1};g._typeName="tfs.wit.queryEditor";return g}(d.BaseControl);j.QueryEditor=N;h.initClassPrototype(N,{_queryProvider:null,_queryAdapter:null,_toolbarHost:null,_queryType:null,_queryTypeItems:null,_splitter:null,_filters:null,_grid:null,_gridInfoBar:null,_gridToolbar:null,_sourceFilter:null,_linkFilter:null,_treeFilter:null,_linkFiltersHost:null,_treeFiltersHost:null,_linkFiltersLinkTypesAny:null,_linkFiltersLinkTypesSelected:null,_linkFilterModeSelect:null,_treeFilterModeSelect:null,_linkFiltersLinkTypes:null,_treeFiltersLinkTypes:null,_model:null,_menubar:null,_refreshDelegate:null});h.classExtend(N,l.ControlExtensions);var y=function(d){__extends(a,d);function a(a){d.call(this,a)}a.prototype.initializeOptions=function(a){d.prototype.initializeOptions.call(this,$.extend({coreCssClass:"query-filter"},a))};a.prototype.setProviderAndFilter=function(a,b){this._queryProvider=a;this._queryAdapter=a.project.store.tfsConnection.getService(c.QueryAdapter);this.setFilter(b)};a.prototype._getDefaultClause=function(){return{logicalOperator:q.WiqlOperators_And,fieldName:"",operator:q.WiqlOperators_EqualTo,value:"",index:0}};a.prototype._updateAndOrControl=function(a,b){a.setText(b.logicalOperator);a.setSource([q.WiqlOperators_And,q.WiqlOperators_Or])};a.prototype._updateFieldControl=function(a,b){a.setText(b.fieldName);this._queryAdapter.beginGetQueryableFields(function(b){!a._disposed&&a.setSource(b)})};a.prototype._updateOperatorControl=function(c,a,h){var g=this,f=true;function d(b){var d;b=b||[];if(b.length){c.setSource(b);c.setMode(b.length?"drop":"text")}else{c.setSource([]);c.setMode("text")}if(h){if(a.operator)if(!e.ArrayUtils.contains(b,a.operator,e.StringUtils.localeIgnoreCaseComparer)){a.operator="";a.value=""}if(!a.operator&&b.length){d=g._queryAdapter.getField(a.fieldName);if(d&&d.id===1)a.operator=g._queryAdapter.getLocalizedOperator(bb.OperatorContains);else a.operator=b[0]}}c.setText(a.operator||"")}if(a.fieldName){b.logTracePoint("QueryEditor._updateOperatorControl.async-pending");this._queryAdapter.beginGetAvailableOperators(a.fieldName,function(a){f=false;!c._disposed&&d(a);b.logTracePoint("QueryEditor._updateOperatorControl.async-complete")});f&&d([q.WiqlOperators_EqualTo])}else d([q.WiqlOperators_EqualTo])};a.prototype._updateValueControl=function(c,a){var d=this;c.setText(a.value);if(!a.fieldName||!a.operator)c.setEnabled(false);else{b.logTracePoint("QueryEditor._updateValueControl.async-pending");c.setEnabled(true);this._queryAdapter.beginGetAvailableFieldValues(this._queryProvider.project,a.fieldName,a.operator,true,function(f){var e=d._queryAdapter.getFieldType(null,a.fieldName);!c._disposed&&d._updateFieldValues(c,e,f);b.logTracePoint("QueryEditor._updateValueControl.async-complete")})}};a.prototype._validateClause=function(a){var b=a.clause,c=this;if(!b.fieldName||!b.operator){a.fieldNameControl.setInvalid(false);a.operatorControl.setInvalid(false)}else this._queryAdapter.beginEnsureFields(function(){var d=c._queryAdapter.getField(b.fieldName);if(d&&(d.id!==80||g.FeatureAvailabilityService.isFeatureEnabled(S.FeatureAvailabilityFlags.QueryOnTags))){a.fieldNameControl.setInvalid(false);c._queryAdapter.beginGetAvailableOperators(b.fieldName,function(c){if(c&&e.ArrayUtils.contains(c,b.operator,e.StringUtils.localeIgnoreCaseComparer))a.operatorControl.setInvalid(false);else a.operatorControl.setInvalid(true)})}else{a.fieldNameControl.setInvalid(true);a.operatorControl.setInvalid(e.StringUtils.localeIgnoreCaseComparer(b.operator,q.WiqlOperators_EqualTo)!==0)}})};a.prototype._handleFieldNameChanged=function(d,e){var c=this,a=d.clause;b.logTracePoint("QueryEditor._onClauseChange.async-pending");this._queryAdapter.beginEnsureFields(function(){var f=c._queryAdapter.getField(a.fieldName);if(!f||c._queryAdapter.getFieldType(f,e)!==c._queryAdapter.getFieldType(f,a.fieldName)||f&&f.id===1){a.operator="";a.value="";c._updateOperatorControl(d.operatorControl,a,true)}else c._updateOperatorControl(d.operatorControl,a,true);c._updateValueControl(d.valueControl,a);b.logTracePoint("QueryEditor._onClauseChange.async-complete")})};a.prototype._handleOperatorChanged=function(b,c){var a=b.clause;if(this._queryAdapter.isGroupOperator(c)!==this._queryAdapter.isGroupOperator(a.operator)||this._queryAdapter.isFieldComparisonOperator(c)!==this._queryAdapter.isFieldComparisonOperator(a.operator)){a.value="";this._updateValueControl(b.valueControl,a)}};a.prototype._setDirty=function(){this._queryProvider.setDirty(true)};a._typeName="tfs.wit.queryFilter";return a}(E.FieldsFilterBase);j.QueryFilter=y;h.initClassPrototype(y,{_queryProvider:null,_queryAdapter:null});h.classExtend(y,l.ControlExtensions);var X=function(c){__extends(b,c);function b(a){c.call(this,a)}b.prototype.initializeOptions=function(b){c.prototype.initializeOptions.call(this,$.extend({message:a.QueryManageDialog_Validator_FolderSelfReferential},b))};b.prototype.isValid=function(){var a=$.trim(this.getValue());return!a||!e.StringUtils.startsWith(a,this._options.existingPath)};return b}(z.BaseValidator),t=function(g){__extends(f,g);function f(a){g.call(this,a)}f.renameQuery=function(a,b,c){return i.Dialog.show(f,{mode:"rename",queryPath:a,isFolder:b,project:c})};f.newQuery=function(d,e,b,c,a){a=$.extend({mode:"new-query",queryPath:d||"",isFolder:false,project:e,startCreateNewQueryCallback:b,endCreateNewQueryCallback:c},a);return i.Dialog.show(f,a)};f.newFolder=function(a,b,c){return i.Dialog.show(f,{mode:"new-folder",queryPath:a,isFolder:b,project:c})};f.saveAs=function(a,c,b){return i.Dialog.show(f,$.extend({mode:"save-as",queryPath:a,isFolder:false,project:c},b))};f.prototype.initializeOptions=function(a){g.prototype.initializeOptions.call(this,$.extend({cssClass:"query-rename-new-folder-dialog"},a))};f.prototype.initialize=function(){var h=d.getId(),f,k,l,j=this,b;b=this._options.queryPath||"";this._content=$("<div />").addClass("content");if(this._options.mode==="rename"||this._options.mode==="save-as"){if(this._options.mode==="save-as")this.setTitle(a.SaveQueryAsDialogTitle);else this.setTitle(this._options.isFolder?a.RenameQueryFolderTitle:a.RenameQueryTitle);k=this._options.queryPath.lastIndexOf("/");if(k>=0){b=this._options.queryPath.substring(0,k+1);f=this._options.queryPath.substring(k+1)}else{f=this._options.queryPath;b=""}}else if(this._options.mode==="new-folder"){this.setTitle(a.NewQueryFolder);f=a.NewQueryFolder}else{this.setTitle(this._options.queryTitle||a.NewQuery);f=this._options.queryName||a.NewQuery}$("<label />").text(a.NameLabel).attr("for",h+"_txt").appendTo(this._content);this._input=$("<input />").attr("type","text").attr("id",h+"_txt").addClass("input-text").appendTo(this._content).bind("keydown change",function(){j.clearError()}).val(f);d.Enhancement.enhance(z.RequiredValidator,this._input,{message:a.QueryManageDialog_Validator_NameRequired,bindtokeystrokes:true});d.Enhancement.enhance(z.RegexValidator,this._input,{message:a.QueryManageDialog_Validator_NameInvalid,regex:/^[^\/\\]*$/});this._input.Watermark({watermarkText:r.RequiredFieldWatermark});$("<label />").text(a.FolderLabel).attr("for",h+"_folder_txt").appendTo(this._content);l=$("<input />").attr("type","text").attr("id",h+"_folder_txt").appendTo(this._content).val(b.replace(/\/$/,""));l.Watermark({watermarkText:r.RequiredFieldWatermark});this._folderCombo=d.Enhancement.enhance(i.Combo,l,{type:"tree",id:h+"_cmb",sepChar:"/",change:function(){j.clearError()}});d.Enhancement.enhance(z.RequiredValidator,this._folderCombo,{message:a.QueryManageDialog_Validator_FolderRequired});d.Enhancement.enhance(i.ComboControlValidatior,this._folderCombo,{message:a.QueryManageDialog_Validator_FolderInvalid});this._options.mode==="rename"&&this._options.isFolder&&d.Enhancement.enhance(X,this._folderCombo,{existingPath:this._options.queryPath});this._options.project.beginGetQueryHierarchy(function(f){!b&&j._folderCombo.setText(f.myQueries.path());function a(h,f){var b,g;b=d.TreeNode.create(h.name);if(f)f.add(b);else f=b;if(h.children){g=[].concat(h.children);g.sort(function(a,b){return e.StringUtils.localeIgnoreCaseComparer(a.name,b.name)});$.each(g,function(e,d){d instanceof c.QueryFolder&&a(d,b)})}return f}j._folderCombo.setSource(a(f,null).children)});d.BaseControl.createIn(z.ValidationSummary,this._content,{context:this._content});this._element.append(this._content);g.prototype.initialize.call(this);this.updateOkButton(true)};f.prototype.onOpen=function(a){g.prototype.onOpen.call(this,a);this._input.focus(50,function(){this.select()})};f.prototype.showError=function(a){if(!this._errorSection)this._errorSection=d.BaseControl.createIn(i.MessageAreaControl,this._content);this._errorSection.setError(B(a))};f.prototype.clearError=function(){if(this._errorSection){this._errorSection.dispose();this._errorSection=null}};f.prototype.onOkClick=function(){b.logTracePoint("QueryRenameNewFolderDialog.onOkClick.start");var d=this,f=$.trim(this._input.val()),h,i,j,g=this._options.mode,p,m,l;function o(a){b.assertParamIsObject(a,"error");d.showError(a);d.updateOkButton(true)}function q(c,b){if(!c.personal&&b.personal){l=c.path(false).split("/")[0];m=b.path(false).split("/")[0];return confirm(e.StringUtils.format(a.QueryConfirmDragDropOperation,l,m))}return true}p=z.validateGroup("*",null,this._content);if(p){h=this._folderCombo.getText().replace(/\/+$/,"");j=h+"/"+f;i=this._options.queryPath||h;if(g==="rename"&&e.StringUtils.localeComparer(i,j)===0){this.close();return}this.updateOkButton(false);this._options.project.beginGetQueryHierarchy(function(r){var l,m,p;function s(a){m.beginCreateNewQuery(f,a,l.newQueryId,function(a){d.close();if($.isFunction(d._options.saveAsNewQueryCallback))d._options.saveAsNewQueryCallback.call(d,a);else!d._options.suppressNavigate&&k.history.addHistoryPoint("query-edit",{path:a.path(),newQuery:false})},function(a){d.showError(a);d.updateOkButton(true)})}l=r.findByPath(i);m=r.findByPath(h);if(!l){d.showError(e.StringUtils.format(a.ErrorQueryDoesNotExist,i));d.updateOkButton(true)}else if(!m){d.showError(e.StringUtils.format(a.ErrorQueryDoesNotExist,h));d.updateOkButton(true)}else if(g==="rename")if(l.parent===m)l.beginRename(f,function(){d.close()},function(a){o(a)});else if(q(l,m))l.beginMove(f,m,function(){d.close()},function(a){o(a)});else d.updateOkButton(true);else if(g==="new-folder")m.beginCreateNewFolder(f,function(){d.close()},function(a){d.showError(a);d.updateOkButton(true)});else if(g==="save-as"){p=n.peek(l);if(l.id&&e.StringUtils.localeIgnoreCaseComparer(i,j)===0)if(p)p.beginSave(function(){d.close()},function(a){d.showError(a);d.updateOkButton(true)});else d.close();else if(p)p.beginGetQueryText(function(a){s(a)},function(a){d.showError(a);d.updateOkButton(true)});else s(l.queryText)}else if(g==="new-query")m.beginCreateNewQuery(f,d._options.wiql||c.QueryDefinition.defaultNewQueryWiql(),0,function(a){d.close();try{$.isFunction(d._options.startCreateNewQueryCallback)&&d._options.startCreateNewQueryCallback(a);!d._options.suppressNavigate&&k.history.addHistoryPoint("query-edit",{path:a.path()})}finally{$.isFunction(d._options.endCreateNewQueryCallback)&&d._options.endCreateNewQueryCallback(a)}},function(a){d.showError(a);d.updateOkButton(true)});else b.fail("Unexpected mode for QueryRenameNewFolderDialog: "+g)})}};f._typeName="tfs.wit.queryRenameNewFolderDialog";return f}(i.ModalDialog);j.QueryRenameNewFolderDialog=t;h.initClassPrototype(t,{_content:null,_input:null,_folderCombo:null,_errorSection:null});h.classExtend(t,l.ControlExtensions);k.ActionManager.registerActionWorker(Y.ACTION_WORKITEMQUERY_SAVEAS,function(a){t.newQuery(a.queryPath,a.project,a.saved,null,{wiql:a.wiql,queryName:a.queryName,queryTitle:a.queryTitle,suppressNavigate:a.suppressNavigate})},k.ActionManager.MaxOrder);x.menuManager.attachExecuteCommand(function(m,i){var c=i.get_commandArgument(),g,l=this;switch(i.get_commandName()){case"refresh-query-explorer":$(window).trigger("refresh-query-explorer");return false;case"column-options":E.WITDialogs.columnOptions(c);return false;case"run-query":k.history.addHistoryPoint("query",{path:c.queryPath});return false;case"edit-query":k.history.addHistoryPoint("query-edit",{path:c.queryPath});return false;case"delete-query":c.project.beginGetQueryHierarchy(function(h){var d,f,g=false;d=h.findByPath(c.queryPath);if(!d){l.showError(e.StringUtils.format(a.ErrorQueryDoesNotExist,c.queryPath));b.logTracePoint("QueryTreeView.DeleteQuery.error")}else{if(!d.id){f=n.get(d,null,false);g=!f||!f.isDirty()}(g||confirm(e.StringUtils.format(a.ConfirmDeleteQuery,c.queryPath)))&&d.beginDelete(function(){b.logTracePoint("QueryTreeView.DeleteQuery.Complete")},function(a){alert(B(a))})}});return false;case"rename-query":t.renameQuery(c.queryPath,c.isFolder,c.project);return false;case"save-query-as":t.saveAs(c.queryPath,c.project);return false;case"new-query":t.newQuery(c.queryPath,c.project);return false;case"new-query-folder":t.newFolder(c.queryPath,c.isFolder,c.project);return false;case"copy-selection":c.grid._copySelectedItems();return false;case"bulk-edit-workitems":db(["WorkItemTracking/Scripts/TFS.WorkItemTracking.Controls.BulkEdit"],function(a){g={tfsContext:c.tfsContext,okCallback:function(b){var d={container:this._element};a.bulkUpdateWorkItems(c.tfsContext,b.workItemIds,b.changes,d)}};a.BulkEditDialogs.bulkEditWorkItems(c.selectedWorkItems,g)});return false;case s.COMMAND_ID_EMAIL_SELECTION:b.logTracePoint("SendMail.SendEmailContextMenuClicked");var d=c.queryResultsProvider;if(d.isDirty())alert(e.StringUtils.format(a.ErrorEmailUnsavedQuery,d.queryDefinition.path()));else try{var f=d.queryResultsModel,h=[];if(f&&f.columns)h=$.map(f.columns,function(a){return a.name});var j=new L.EmailWorkItemsDialogModel({workItemSelectionOption:{workItems:c.selectedWorkItems,fields:h,store:d.queryDefinition.project}});T.Dialogs.sendMail(j)}catch(o){alert(o.message)}return false}});function R(a,c){var e,g,f=a.children,b;if(c){b=d.TreeNode.create(a.name);b.tag={custom:a.isCustom,folder:Boolean(a.children)};b.cssClass=!b.tag.folder?"finder-query":"";c.add(b);c=b}else c=d.TreeNode.create(a.name);if(f)for(e=0,g=f.length;e<g;e++){a=f[e];R(a,c)}return c}function U(b,a){b.sort(function(c,b){if(c.children){if(!b.children)return-1*(a?1:-1)}else if(b.children)return 1*(a?1:-1);return e.StringUtils.localeIgnoreCaseComparer(c.sortPrefix+c.name,b.sortPrefix+b.name)})}function Q(e,f){var b,g,a,d;for(b=0,g=e.children.length;b<g;b++){a=e.children[b];d={name:a.name};f.children.push(d);if(a instanceof c.QueryFolder){d.children=[];Q(a,d)}}U(f.children,true)}var M=function(h){__extends(b,h);function b(b){h.call(this,b);var a=this._options.tfsContext;H(a!==null&&typeof a!=="undefined","tfs context is expected.");this._tfsContext=a}b.prototype.updateGoButton=function(a){this.$goButton.button("option","disabled",a===false)};b.prototype.setStatusText=function(a,b){if(b===true)this.$statusContainer.empty().addClass("error").text(a).attr("title",a);else this.$statusContainer.empty().removeClass("error").text(a).attr("title",a)};b.prototype.showError=function(a){this.setStatusText(B(a),true);this.$listContainer.hide()};b.prototype.onLoadCompleted=function(a){h.prototype.onLoadCompleted.call(this,a);this._queryResultsProviders={};this._store=g.TfsTeamProjectCollection.getConnection(this._tfsContext).getService(c.WorkItemStore);this._projectName=this._tfsContext.navigation.project||"";this._decorate()};b.prototype.onQueryChanged=function(b){var a=this.$queries.getBehavior().getDataSource().getItem(b,true);this.updateGoButton(a&&!a.tag.folder)};b.prototype.onSelectedWorkItemChanged=function(){this.updateOkButton(this._grid.getSelectedWorkItemIds().length>0)};b.prototype.onClose=function(a){this._queryResultsProviders=null;delete this._queryResultsProviders;h.prototype.onClose.call(this,a)};b.prototype.onDialogResize=function(a){this._grid._onContainerResize(a)};b.prototype.getDialogResult=function(){return this._grid.getSelectedWorkItemIds()};b.prototype._decorate=function(){this.setTitle(this._options.title||a.WorkItemFinderTitle);this.$statusContainer=this._element.find("div.status-container");this.$listContainer=this._element.find("div.list-container");this._grid=d.Enhancement.ensureEnhancement(s,this._element);H(this._grid?true:false,"Unable to find QueryResultsGrid control.");this._grid._bind("selectedWorkItemChanged",f(this,this.onSelectedWorkItemChanged));this.$queries=d.Enhancement.enhance(i.Combo,this._element.find("input.query"),{allowEdit:false,type:"tree",treeLevel:2,sepChar:"/",indexChanged:f(this,this.onQueryChanged)});this.$goButton=this._element.find("button.go").button().click(f(this,this._runQuery));this._populateProjects()};b.prototype._populateProjects=function(){var a=this,c=this._element.find("input.project"),e=f(this,this.showError),b=this._projectName||"";this._store.beginGetProjects(function(f){var e=[];$.map(f,function(a){e.push(a.name)});a._projectNames=e;a.$projects=d.Enhancement.enhance(i.Combo,c,{allowEdit:false,source:e,indexChanged:function(b){a._populateQueries(a._projectNames[b])}});a.$projects.setText(b);b.length&&a._populateQueries(b,true)},e)};b.prototype._populateQueries=function(d,c){var a=this,b=f(this,this.showError);this._store.beginGetProject(d,function(d){a._project=d;d.beginGetQueryHierarchy(function(b){a.$queries.setSource(a._prepareQuerySource(b,c).children);a.$queries.setText(a._defaultQuery);a._runQuery(true)},b)},b)};b.prototype._prepareQuerySource=function(f,i){var e,h,a,b,d=[],g;this._defaultQuery=null;for(e=0,h=f.children.length;e<h;e++){a=f.children[e];if(a instanceof c.QueryFolder){b={name:a.name,children:[]};d.push(b);a.children.length&&Q(a,b)}else if(a instanceof c.QueryDefinition&&c.QueryDefinition.isMyWorkItems(a)){b={name:a.name,sortPrefix:"1"};g=b;d.push(b)}}this._ensureCustomQuery();this._customQuery&&d.push(this._customQuery);this._ensureDefaultQuery(i,g);U(d,false);return R({children:d},null)};b.prototype._ensureCustomQuery=function(){var b=this._options;if(b.query&&b.query.wiql)if(!this._customQuery)this._customQuery={isCustom:true,name:b.query.name||a.WorkItemFinderCustomQuery,queryText:b.query.wiql,sortPrefix:"0"}};b.prototype._ensureDefaultQuery=function(b,c){var a=this._options;this._ensureCustomQuery();if(this._customQuery)this._defaultQuery=this._customQuery.name;else if(a.query&&a.query.path&&b)this._defaultQuery=a.query.path;else this._defaultQuery=c.name};b.prototype._getQueryResultsProvider=function(b){var a,c=this._queryResultsProviders,d=this._project.name+";"+(b.path?b.path(true):b.name);a=c[d];if(!a){a=new n(b,{skipPersistingColumnResize:true,errorCallback:f(this,this.showError)});c[d]=a}return a};b.prototype._runQuery=function(){var f=this,d,c,b;c=this.$queries.getBehavior().getDataSource().getItem(this.$queries.getBehavior().getSelectedIndex(),true);if(c){if(c.tag.custom)b=$.extend({project:this._project},this._customQuery);else b=this._project.queryHierarchy.findByPath(this.$queries.getText());d=this._getQueryResultsProvider(b);this.updateGoButton(false);this.$listContainer.show();this._grid.beginShowResults(d,function(){f.updateGoButton();f.setStatusText(e.StringUtils.format(a.WorkItemFinderResultsMessage,b.name))})}else this.showError(e.StringUtils.format(a.WorkItemFinderQueryNotFound,this.$queries.getText()))};b._typeName="WorkItemFinderDialog";return b}(i.ModalDialog);h.initClassPrototype(M,{$statusContainer:null,$listContainer:null,$goButton:null,$queries:null,$projects:null,_tfsContext:null,_projectName:null,_store:null,_project:null,_projectNames:null,_customQuery:null,_defaultQuery:null,_queryResultsProviders:null,_grid:null});h.classExtend(M,l.ControlExtensions);var ab=function(){function a(){}a.findWorkItem=function(a){return i.Dialog.show(M,$.extend({dialogClass:"find-work-item",url:l.getDefault().getActionUrl("findWorkItem","wit",{area:"api",includeLanguage:true}),urlParams:{showContextMenu:a&&a.showContextMenu===true,allowMultiSelect:a&&a.allowMultiSelect!==false},width:600,minWidth:450,height:450,minHeight:300,attachResize:true},a))};return a}();j.WITQueryDialogs=ab;d.Enhancement.registerEnhancement(s,".query-result-grid");d.Enhancement.registerEnhancement(w,".query-result-grid-info");d.Enhancement.registerEnhancement(u,".query-result-grid-toolbar");d.Enhancement.registerEnhancement(G,".filter-bar");d.Enhancement.registerEnhancement(K,".triage-view");d.Enhancement.registerEnhancement(J,".query-folder-tree");h.tfsModuleLoaded("TFS.WorkItemTracking.Controls.Query",j)});
// SIG // Begin signature block
// SIG // MIIa0QYJKoZIhvcNAQcCoIIawjCCGr4CAQExCzAJBgUr
// SIG // DgMCGgUAMGcGCisGAQQBgjcCAQSgWTBXMDIGCisGAQQB
// SIG // gjcCAR4wJAIBAQQQEODJBs441BGiowAQS9NQkAIBAAIB
// SIG // AAIBAAIBAAIBADAhMAkGBSsOAwIaBQAEFAzouOZJnFoU
// SIG // pjFX8SjKsc2bvfJjoIIVejCCBLswggOjoAMCAQICEzMA
// SIG // AABZ1nPNUY7wIsUAAAAAAFkwDQYJKoZIhvcNAQEFBQAw
// SIG // dzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCldhc2hpbmd0
// SIG // b24xEDAOBgNVBAcTB1JlZG1vbmQxHjAcBgNVBAoTFU1p
// SIG // Y3Jvc29mdCBDb3Jwb3JhdGlvbjEhMB8GA1UEAxMYTWlj
// SIG // cm9zb2Z0IFRpbWUtU3RhbXAgUENBMB4XDTE0MDUyMzE3
// SIG // MTMxNVoXDTE1MDgyMzE3MTMxNVowgasxCzAJBgNVBAYT
// SIG // AlVTMQswCQYDVQQIEwJXQTEQMA4GA1UEBxMHUmVkbW9u
// SIG // ZDEeMBwGA1UEChMVTWljcm9zb2Z0IENvcnBvcmF0aW9u
// SIG // MQ0wCwYDVQQLEwRNT1BSMScwJQYDVQQLEx5uQ2lwaGVy
// SIG // IERTRSBFU046RjUyOC0zNzc3LThBNzYxJTAjBgNVBAMT
// SIG // HE1pY3Jvc29mdCBUaW1lLVN0YW1wIFNlcnZpY2UwggEi
// SIG // MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDGbE7P
// SIG // aFP974De6IvEsfB+B84ePOwMjDWHTOlROry2sJZ3Qvr/
// SIG // PM/h2uKJ+m5CAJlbFt0JZDjiUvvfjvqToz27h49uuIfJ
// SIG // 0GBPz5yCkW2RG3IQs9hDfFlKYF3GsFXQJ9vy9r3yIMYi
// SIG // LJ5riy1s6ngEyUvBcAnnth2vmowGP3hw+nbu0iQUdrKu
// SIG // ICiDHKnwSJI/ooX3g8rFUdCVIAN50le8E7VOuLRsVh9T
// SIG // HhW7zzA//TsBzV9yaPfK85lmM6hdIo8dbsraZdIrHCSs
// SIG // n3ypEIqF4m0uXEr9Sbl7QLFTxt9HubMjTiJHHNPBuUl2
// SIG // QnLOkIYOJPXCPLkJNj+oU1xW/l9hAgMBAAGjggEJMIIB
// SIG // BTAdBgNVHQ4EFgQUWygas811DWM9/Zn1mxUCSBrLpqww
// SIG // HwYDVR0jBBgwFoAUIzT42VJGcArtQPt2+7MrsMM1sw8w
// SIG // VAYDVR0fBE0wSzBJoEegRYZDaHR0cDovL2NybC5taWNy
// SIG // b3NvZnQuY29tL3BraS9jcmwvcHJvZHVjdHMvTWljcm9z
// SIG // b2Z0VGltZVN0YW1wUENBLmNybDBYBggrBgEFBQcBAQRM
// SIG // MEowSAYIKwYBBQUHMAKGPGh0dHA6Ly93d3cubWljcm9z
// SIG // b2Z0LmNvbS9wa2kvY2VydHMvTWljcm9zb2Z0VGltZVN0
// SIG // YW1wUENBLmNydDATBgNVHSUEDDAKBggrBgEFBQcDCDAN
// SIG // BgkqhkiG9w0BAQUFAAOCAQEAevAN9EVsNJYOd/DiwEIF
// SIG // YfeI03r9iNWn9fd/8gj21f3LynR82wmp39YVB5m/0D6H
// SIG // hGJ7wgaOyoto4j3fnlrFjLKpXP5ZYib11/l4tm60CpBl
// SIG // ZulRCPF8yaO3BDdGxeeCPihc709xpOexJVrlQ1QzCH+k
// SIG // sFUt0YJwSBEgDSaBDu8GJXSrhcPDjOIUX+gFVI+6homq
// SIG // lq6UYiX5r2mICgyxUcQJ77iAfFOQebvpj9BI8GLImfFl
// SIG // NDv3zrX7Zpi5olmZXT6VnxS/NbT7mHIkKQzzugR6gjn7
// SIG // Rs3x4LIWvH0g+Jw5FSWhJi3Wi4G9xr2wnVT+RwtfLU4q
// SIG // 9IfqtQ+1t+2SKTCCBOwwggPUoAMCAQICEzMAAADKbNUy
// SIG // EjXE4VUAAQAAAMowDQYJKoZIhvcNAQEFBQAweTELMAkG
// SIG // A1UEBhMCVVMxEzARBgNVBAgTCldhc2hpbmd0b24xEDAO
// SIG // BgNVBAcTB1JlZG1vbmQxHjAcBgNVBAoTFU1pY3Jvc29m
// SIG // dCBDb3Jwb3JhdGlvbjEjMCEGA1UEAxMaTWljcm9zb2Z0
// SIG // IENvZGUgU2lnbmluZyBQQ0EwHhcNMTQwNDIyMTczOTAw
// SIG // WhcNMTUwNzIyMTczOTAwWjCBgzELMAkGA1UEBhMCVVMx
// SIG // EzARBgNVBAgTCldhc2hpbmd0b24xEDAOBgNVBAcTB1Jl
// SIG // ZG1vbmQxHjAcBgNVBAoTFU1pY3Jvc29mdCBDb3Jwb3Jh
// SIG // dGlvbjENMAsGA1UECxMETU9QUjEeMBwGA1UEAxMVTWlj
// SIG // cm9zb2Z0IENvcnBvcmF0aW9uMIIBIjANBgkqhkiG9w0B
// SIG // AQEFAAOCAQ8AMIIBCgKCAQEAlnFd7QZG+oTLnVu3Rsew
// SIG // 4bQROQOtsRVzYJzrp7ZuGjw//2XjNPGmpSFeVplsWOSS
// SIG // oQpcwtPcUi8MZZogYUBTMZxsjyF9uvn+E1BSYJU6W7lY
// SIG // pXRhQamU4K0mTkyhl3BJJ158Z8pPHnGERrwdS7biD8XG
// SIG // J8kH5noKpRcAGUxwRTgtgbRQqsVn0fp5vMXMoXKb9CU0
// SIG // mPhU3xI5OBIvpGulmn7HYtHcz+09NPi53zUwuux5Mqnh
// SIG // qaxVTUx/TFbDEwt28Qf5zEes+4jVUqUeKPo9Lc/PhJiG
// SIG // cWURz4XJCUSG4W/nsfysQESlqYsjP4JJndWWWVATWRhz
// SIG // /0MMrSvUfzBAZwIDAQABo4IBYDCCAVwwEwYDVR0lBAww
// SIG // CgYIKwYBBQUHAwMwHQYDVR0OBBYEFB9e4l1QjVaGvko8
// SIG // zwTop4e1y7+DMFEGA1UdEQRKMEikRjBEMQ0wCwYDVQQL
// SIG // EwRNT1BSMTMwMQYDVQQFEyozMTU5NStiNDIxOGYxMy02
// SIG // ZmNhLTQ5MGYtOWM0Ny0zZmM1NTdkZmM0NDAwHwYDVR0j
// SIG // BBgwFoAUyxHoytK0FlgByTcuMxYWuUyaCh8wVgYDVR0f
// SIG // BE8wTTBLoEmgR4ZFaHR0cDovL2NybC5taWNyb3NvZnQu
// SIG // Y29tL3BraS9jcmwvcHJvZHVjdHMvTWljQ29kU2lnUENB
// SIG // XzA4LTMxLTIwMTAuY3JsMFoGCCsGAQUFBwEBBE4wTDBK
// SIG // BggrBgEFBQcwAoY+aHR0cDovL3d3dy5taWNyb3NvZnQu
// SIG // Y29tL3BraS9jZXJ0cy9NaWNDb2RTaWdQQ0FfMDgtMzEt
// SIG // MjAxMC5jcnQwDQYJKoZIhvcNAQEFBQADggEBAHdc69eR
// SIG // Pc29e4PZhamwQ51zfBfJD+0228e1LBte+1QFOoNxQIEJ
// SIG // ordxJl7WfbZsO8mqX10DGCodJ34H6cVlH7XPDbdUxyg4
// SIG // Wojne8EZtlYyuuLMy5Pbr24PXUT11LDvG9VOwa8O7yCb
// SIG // 8uH+J13oxf9h9hnSKAoind/NcIKeGHLYI8x6LEPu/+rA
// SIG // 4OYdqp6XMwBSbwe404hs3qQGNafCU4ZlEXcJjzVZudiG
// SIG // qAD++DF9LPSMBZ3AwdV3cmzpTVkmg/HCsohXkzUAfFAr
// SIG // vFn8/hwpOILT3lKXRSkYTpZbnbpfG6PxJ1DqB5XobTQN
// SIG // OFfcNyg1lTo4nNTtaoVdDiIRXnswggW8MIIDpKADAgEC
// SIG // AgphMyYaAAAAAAAxMA0GCSqGSIb3DQEBBQUAMF8xEzAR
// SIG // BgoJkiaJk/IsZAEZFgNjb20xGTAXBgoJkiaJk/IsZAEZ
// SIG // FgltaWNyb3NvZnQxLTArBgNVBAMTJE1pY3Jvc29mdCBS
// SIG // b290IENlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0xMDA4
// SIG // MzEyMjE5MzJaFw0yMDA4MzEyMjI5MzJaMHkxCzAJBgNV
// SIG // BAYTAlVTMRMwEQYDVQQIEwpXYXNoaW5ndG9uMRAwDgYD
// SIG // VQQHEwdSZWRtb25kMR4wHAYDVQQKExVNaWNyb3NvZnQg
// SIG // Q29ycG9yYXRpb24xIzAhBgNVBAMTGk1pY3Jvc29mdCBD
// SIG // b2RlIFNpZ25pbmcgUENBMIIBIjANBgkqhkiG9w0BAQEF
// SIG // AAOCAQ8AMIIBCgKCAQEAsnJZXBkwZL8dmmAgIEKZdlNs
// SIG // PhvWb8zL8epr/pcWEODfOnSDGrcvoDLs/97CQk4j1XIA
// SIG // 2zVXConKriBJ9PBorE1LjaW9eUtxm0cH2v0l3511iM+q
// SIG // c0R/14Hb873yNqTJXEXcr6094CholxqnpXJzVvEXlOT9
// SIG // NZRyoNZ2Xx53RYOFOBbQc1sFumdSjaWyaS/aGQv+knQp
// SIG // 4nYvVN0UMFn40o1i/cvJX0YxULknE+RAMM9yKRAoIsc3
// SIG // Tj2gMj2QzaE4BoVcTlaCKCoFMrdL109j59ItYvFFPees
// SIG // CAD2RqGe0VuMJlPoeqpK8kbPNzw4nrR3XKUXno3LEY9W
// SIG // PMGsCV8D0wIDAQABo4IBXjCCAVowDwYDVR0TAQH/BAUw
// SIG // AwEB/zAdBgNVHQ4EFgQUyxHoytK0FlgByTcuMxYWuUya
// SIG // Ch8wCwYDVR0PBAQDAgGGMBIGCSsGAQQBgjcVAQQFAgMB
// SIG // AAEwIwYJKwYBBAGCNxUCBBYEFP3RMU7TJoqV4ZhgO6gx
// SIG // b6Y8vNgtMBkGCSsGAQQBgjcUAgQMHgoAUwB1AGIAQwBB
// SIG // MB8GA1UdIwQYMBaAFA6sgmBAVieX5SUT/CrhClOVWeSk
// SIG // MFAGA1UdHwRJMEcwRaBDoEGGP2h0dHA6Ly9jcmwubWlj
// SIG // cm9zb2Z0LmNvbS9wa2kvY3JsL3Byb2R1Y3RzL21pY3Jv
// SIG // c29mdHJvb3RjZXJ0LmNybDBUBggrBgEFBQcBAQRIMEYw
// SIG // RAYIKwYBBQUHMAKGOGh0dHA6Ly93d3cubWljcm9zb2Z0
// SIG // LmNvbS9wa2kvY2VydHMvTWljcm9zb2Z0Um9vdENlcnQu
// SIG // Y3J0MA0GCSqGSIb3DQEBBQUAA4ICAQBZOT5/Jkav629A
// SIG // sTK1ausOL26oSffrX3XtTDst10OtC/7L6S0xoyPMfFCY
// SIG // gCFdrD0vTLqiqFac43C7uLT4ebVJcvc+6kF/yuEMF2nL
// SIG // pZwgLfoLUMRWzS3jStK8cOeoDaIDpVbguIpLV/KVQpzx
// SIG // 8+/u44YfNDy4VprwUyOFKqSCHJPilAcd8uJO+IyhyugT
// SIG // pZFOyBvSj3KVKnFtmxr4HPBT1mfMIv9cHc2ijL0nsnlj
// SIG // VkSiUc356aNYVt2bAkVEL1/02q7UgjJu/KSVE+Traeep
// SIG // oiy+yCsQDmWOmdv1ovoSJgllOJTxeh9Ku9HhVujQeJYY
// SIG // XMk1Fl/dkx1Jji2+rTREHO4QFRoAXd01WyHOmMcJ7oUO
// SIG // jE9tDhNOPXwpSJxy0fNsysHscKNXkld9lI2gG0gDWvfP
// SIG // o2cKdKU27S0vF8jmcjcS9G+xPGeC+VKyjTMWZR4Oit0Q
// SIG // 3mT0b85G1NMX6XnEBLTT+yzfH4qerAr7EydAreT54al/
// SIG // RrsHYEdlYEBOsELsTu2zdnnYCjQJbRyAMR/iDlTd5aH7
// SIG // 5UcQrWSY/1AWLny/BSF64pVBJ2nDk4+VyY3YmyGuDVyc
// SIG // 8KKuhmiDDGotu3ZrAB2WrfIWe/YWgyS5iM9qqEcxL5rc
// SIG // 43E91wB+YkfRzojJuBj6DnKNwaM9rwJAav9pm5biEKgQ
// SIG // tDdQCNbDPTCCBgcwggPvoAMCAQICCmEWaDQAAAAAABww
// SIG // DQYJKoZIhvcNAQEFBQAwXzETMBEGCgmSJomT8ixkARkW
// SIG // A2NvbTEZMBcGCgmSJomT8ixkARkWCW1pY3Jvc29mdDEt
// SIG // MCsGA1UEAxMkTWljcm9zb2Z0IFJvb3QgQ2VydGlmaWNh
// SIG // dGUgQXV0aG9yaXR5MB4XDTA3MDQwMzEyNTMwOVoXDTIx
// SIG // MDQwMzEzMDMwOVowdzELMAkGA1UEBhMCVVMxEzARBgNV
// SIG // BAgTCldhc2hpbmd0b24xEDAOBgNVBAcTB1JlZG1vbmQx
// SIG // HjAcBgNVBAoTFU1pY3Jvc29mdCBDb3Jwb3JhdGlvbjEh
// SIG // MB8GA1UEAxMYTWljcm9zb2Z0IFRpbWUtU3RhbXAgUENB
// SIG // MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
// SIG // n6Fssd/bSJIqfGsuGeG94uPFmVEjUK3O3RhOJA/u0afR
// SIG // TK10MCAR6wfVVJUVSZQbQpKumFwwJtoAa+h7veyJBw/3
// SIG // DgSY8InMH8szJIed8vRnHCz8e+eIHernTqOhwSNTyo36
// SIG // Rc8J0F6v0LBCBKL5pmyTZ9co3EZTsIbQ5ShGLieshk9V
// SIG // UgzkAyz7apCQMG6H81kwnfp+1pez6CGXfvjSE/MIt1Nt
// SIG // UrRFkJ9IAEpHZhEnKWaol+TTBoFKovmEpxFHFAmCn4Tt
// SIG // VXj+AZodUAiFABAwRu233iNGu8QtVJ+vHnhBMXfMm987
// SIG // g5OhYQK1HQ2x/PebsgHOIktU//kFw8IgCwIDAQABo4IB
// SIG // qzCCAacwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQU
// SIG // IzT42VJGcArtQPt2+7MrsMM1sw8wCwYDVR0PBAQDAgGG
// SIG // MBAGCSsGAQQBgjcVAQQDAgEAMIGYBgNVHSMEgZAwgY2A
// SIG // FA6sgmBAVieX5SUT/CrhClOVWeSkoWOkYTBfMRMwEQYK
// SIG // CZImiZPyLGQBGRYDY29tMRkwFwYKCZImiZPyLGQBGRYJ
// SIG // bWljcm9zb2Z0MS0wKwYDVQQDEyRNaWNyb3NvZnQgUm9v
// SIG // dCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHmCEHmtFqFKoKWt
// SIG // THNY9AcTLmUwUAYDVR0fBEkwRzBFoEOgQYY/aHR0cDov
// SIG // L2NybC5taWNyb3NvZnQuY29tL3BraS9jcmwvcHJvZHVj
// SIG // dHMvbWljcm9zb2Z0cm9vdGNlcnQuY3JsMFQGCCsGAQUF
// SIG // BwEBBEgwRjBEBggrBgEFBQcwAoY4aHR0cDovL3d3dy5t
// SIG // aWNyb3NvZnQuY29tL3BraS9jZXJ0cy9NaWNyb3NvZnRS
// SIG // b290Q2VydC5jcnQwEwYDVR0lBAwwCgYIKwYBBQUHAwgw
// SIG // DQYJKoZIhvcNAQEFBQADggIBABCXisNcA0Q23em0rXfb
// SIG // znlRTQGxLnRxW20ME6vOvnuPuC7UEqKMbWK4VwLLTiAT
// SIG // UJndekDiV7uvWJoc4R0Bhqy7ePKL0Ow7Ae7ivo8KBciN
// SIG // SOLwUxXdT6uS5OeNatWAweaU8gYvhQPpkSokInD79vzk
// SIG // eJkuDfcH4nC8GE6djmsKcpW4oTmcZy3FUQ7qYlw/FpiL
// SIG // ID/iBxoy+cwxSnYxPStyC8jqcD3/hQoT38IKYY7w17gX
// SIG // 606Lf8U1K16jv+u8fQtCe9RTciHuMMq7eGVcWwEXChQO
// SIG // 0toUmPU8uWZYsy0v5/mFhsxRVuidcJRsrDlM1PZ5v6oY
// SIG // emIp76KbKTQGdxpiyT0ebR+C8AvHLLvPQ7Pl+ex9teOk
// SIG // qHQ1uE7FcSMSJnYLPFKMcVpGQxS8s7OwTWfIn0L/gHkh
// SIG // gJ4VMGboQhJeGsieIiHQQ+kr6bv0SMws1NgygEwmKkgk
// SIG // X1rqVu+m3pmdyjpvvYEndAYR7nYhv5uCwSdUtrFqPYmh
// SIG // dmG0bqETpr+qR/ASb/2KMmyy/t9RyIwjyWa9nR2HEmQC
// SIG // PS2vWY+45CHltbDKY7R4VAXUQS5QrJSwpXirs6CWdRrZ
// SIG // kocTdSIvMqgIbqBbjCW/oO+EyiHW6x5PyZruSeD3AWVv
// SIG // iQt9yGnI5m7qp5fOMSn/DsVbXNhNG6HY+i+ePy5VFmvJ
// SIG // E6P9MYIEwzCCBL8CAQEwgZAweTELMAkGA1UEBhMCVVMx
// SIG // EzARBgNVBAgTCldhc2hpbmd0b24xEDAOBgNVBAcTB1Jl
// SIG // ZG1vbmQxHjAcBgNVBAoTFU1pY3Jvc29mdCBDb3Jwb3Jh
// SIG // dGlvbjEjMCEGA1UEAxMaTWljcm9zb2Z0IENvZGUgU2ln
// SIG // bmluZyBQQ0ECEzMAAADKbNUyEjXE4VUAAQAAAMowCQYF
// SIG // Kw4DAhoFAKCB3DAZBgkqhkiG9w0BCQMxDAYKKwYBBAGC
// SIG // NwIBBDAcBgorBgEEAYI3AgELMQ4wDAYKKwYBBAGCNwIB
// SIG // FTAjBgkqhkiG9w0BCQQxFgQUmBBgShK7xI+ARKZAGxXM
// SIG // q8zTzp4wfAYKKwYBBAGCNwIBDDFuMGygUoBQAFQARgBT
// SIG // AC4AVwBvAHIAawBJAHQAZQBtAFQAcgBhAGMAawBpAG4A
// SIG // ZwAuAEMAbwBuAHQAcgBvAGwAcwAuAFEAdQBlAHIAeQBf
// SIG // ADIALgBqAHOhFoAUaHR0cDovL21pY3Jvc29mdC5jb20w
// SIG // DQYJKoZIhvcNAQEBBQAEggEAkiOv2GwDXpSKUMNSb9bu
// SIG // wdh4HE+9Xa4CQNYErX9gt/LmT816t8GYGbRKOrEnT1Tf
// SIG // edG0FOSeGK/j+U0Yvtj/jk92KUrnOQaRShh2LcMKtopT
// SIG // YhK2OEQ83b1px9V6sxR4jnPqRKS+XT1hzg0fr1amYbZO
// SIG // stV+zcQESfk1gQuzDUeA9WWO2RDW2n60w67677sam690
// SIG // R7vGoCz8MX52Nm/a8bpL25cQB6d9EqcOnbeT3cXVE0ns
// SIG // G0ZysgEHB830Ylk5myMlv3q8JfdO3n0rzueTvbXdh59+
// SIG // TBoUzqKQim6M1BEs0CLg2KWiFPtfWYnNBFB/8t1yv5Rt
// SIG // F8WYx5dlBXHRs6GCAigwggIkBgkqhkiG9w0BCQYxggIV
// SIG // MIICEQIBATCBjjB3MQswCQYDVQQGEwJVUzETMBEGA1UE
// SIG // CBMKV2FzaGluZ3RvbjEQMA4GA1UEBxMHUmVkbW9uZDEe
// SIG // MBwGA1UEChMVTWljcm9zb2Z0IENvcnBvcmF0aW9uMSEw
// SIG // HwYDVQQDExhNaWNyb3NvZnQgVGltZS1TdGFtcCBQQ0EC
// SIG // EzMAAABZ1nPNUY7wIsUAAAAAAFkwCQYFKw4DAhoFAKBd
// SIG // MBgGCSqGSIb3DQEJAzELBgkqhkiG9w0BBwEwHAYJKoZI
// SIG // hvcNAQkFMQ8XDTE0MDcyMzA5MTAyMVowIwYJKoZIhvcN
// SIG // AQkEMRYEFLAKwQcXsx0H8RFzqdrnSAcnF916MA0GCSqG
// SIG // SIb3DQEBBQUABIIBABNdoM6fi2ToAyLXlJ9xxoyfgfvy
// SIG // G0fapx8w+aej/+DWc70POPT3bGKvVM2wD5QqahNbazrZ
// SIG // 2cTyAXDqnm1JcRx4qNMsDA7QYUe8+++S6NKeaCjNn9i9
// SIG // ldIMhkZZDAt9BCMCtbTDWwZ9++ukBmz996iOOWLJyuJS
// SIG // zu9Jr3IGsO+Mo911wUMuyfHy+CWOYVBZSXoIOEt2Zvow
// SIG // C+g7YtAlJAqgeWEz2LFzxZ7YUIns7KsGCHqs2fL2/7U/
// SIG // g/sytTxWRwBNC8uyNMWb/mp1C8JfkkSQ69y4pS2h6P07
// SIG // S+iPvZfLQyy0R7yMynVswZCgWCrQ4dI9lgEvWxwpFTEe
// SIG // ImK4YuQ=
// SIG // End signature block
