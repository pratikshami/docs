//----------------------------------------------------------
// Copyright (C) Microsoft Corporation. All rights reserved.
//----------------------------------------------------------
var __extends=this.__extends||function(b,a){for(var c in a)if(a.hasOwnProperty(c))b[c]=a[c];function d(){this.constructor=b}d.prototype=a.prototype;b.prototype=new d};define(["require","exports","Presentation/Scripts/TFS/TFS","Presentation/Scripts/TFS/TFS.Core","Presentation/Scripts/TFS/TFS.OM","WorkItemTracking/Scripts/TFS.WorkItemTracking","Presentation/Scripts/TFS/Generated/TFS.WorkItemTracking.Constants","Presentation/Scripts/TFS/TFS.UI","Presentation/Scripts/TFS/TFS.Host","Presentation/Scripts/TFS/TFS.Host.UI","Presentation/Scripts/TFS/TFS.UI.Controls","Presentation/Scripts/TFS/TFS.UI.Controls.Common","Presentation/Scripts/TFS/Resources/TFS.Resources.Common","Presentation/Scripts/TFS/Generated/TFS.Common.Constants","Presentation/Scripts/TFS/TFS.UI.Controls.Grids","Presentation/Scripts/TFS/TFS.UI.Controls.Menus","Presentation/Scripts/TFS/TFS.Diag","WorkItemTracking/Scripts/TFS.WorkItemTracking.Linking","Presentation/Scripts/TFS/Resources/TFS.Resources.WorkItemTracking","Presentation/Scripts/TFS/Resources/TFS.Resources.Platform","Presentation/Scripts/TFS/TFS.Html","WorkItemTracking/Scripts/TFS.UI.Tags","Presentation/Scripts/TFS/TFS.Core.Utils"],function(dc,d,i,c,l,f,s,v,h,Cb,g,j,Qb,ob,Db,r,e,k,a,hb,bc,Xb,tb){var u=h.ActionManager,Wb=i.handleError,Tb=bc.HtmlNormalizer,w={},Bb=h.TfsContext.getDefault().configuration,b=c.delegate,x=i.getErrorMessage,n=v.domElem,zb;(function(a){a[a.Store=0]="Store";a[a.Project=1]="Project";a[a.Wit=2]="Wit"})(zb||(zb={}));(function(a){a.ACTION_WORKITEM_OPEN="work-item-open";a.ACTION_WORKITEM_NEW="work-item-new";a.ACTION_WORKITEM_NEW_LINKED="work-item-new-linked";a.ACTION_WORKITEM_LINK="work-item-link";a.ACTION_WORKITEM_NEW_COPY="work-item-new-copy";a.ACTION_WORKITEM_NEW_CLONE="work-item-new-clone";a.ACTION_WORKITEM_DISCARD_IF_NEW="work-item-discard-if-new"})(d.WorkItemActions||(d.WorkItemActions={}));var t=d.WorkItemActions;function cb(d){var e=["jpg","jpeg","png","bmp","gif","tif","tiff"],f=[{groupName:"image",commands:[{name:a.InsertImageName,command:j.RichEditor.INSERT_IMAGE_COMMAND,execute:b(d,function(h,g){var f={title:a.InsertImageName,attachmentLabel:a.InsertImageEditLabel,uploadingTitle:a.InsertImageUploadingDialogTitle,showComments:false,uploadOnly:true,successCallback:b(d,function(b,a){g.insertImage(a.Url)}),validator:{validate:function(b){var a=new RegExp("^.*("+e.join("|")+")$");return a.test(b.toLowerCase())},errorString:c.StringUtils.format(a.InsertImageInvalidFileType,e.join(", "))}};B.addAttachment(d._workItem,f)})}]}];return f}var kb=function(b){__extends(a,b);function a(a){b.call(this,a)}a.prototype.initializeOptions=function(a){b.prototype.initializeOptions.call(this,$.extend({coreCssClass:"label-text-control"},a))};a.prototype.initialize=function(){var a,d,c;this._data=this._options.textData;if(this._data.link){this._linkSetting=new Y({link:this._data.link});if($.isArray(this._data.link.params)&&this._data.link.params.length){this._params={};for(a=0,d=this._data.link.params.length;a<d;a++){c=this._data.link.params[a];this._params[c.value]=c}}}b.prototype.initialize.call(this);this._draw()};a.prototype.setUrl=function(b,a){this._a&&this._a.attr("href",this._linkSetting.getUrl(b,a))};a.prototype.needRefresh=function(c){var b=this,a=false;this._params&&$.each(c,function(e,c){if(c){var d=b._params[c.fieldDefinition.name]||b._params[c.fieldDefinition.referenceName];if(d&&!d.original){a=true;return false}}});return a};a.prototype._draw=function(){if(this._data.link){this._a=$("<a />").attr("href","#").attr("target","_blank").appendTo(this._element);if(this._data.label)this._data.label.appendTo(this._a);else this._a.text(this._data.content)}else $("<span />").appendTo(this._element).text(this._data.content)};a._typeName="tfs.labelTextControl";return a}(g.BaseControl);i.initClassPrototype(kb,{_data:null,_linkSetting:null,_params:null,_a:null});var wb=function(){function b(b,c,a){this._options=c;this._workItemType=a;this._labelHost=b;this.initialize()}b.prototype.initialize=function(){var a=this;this._textControls=[];this._options.label&&this._workItemType&&this._createLabel();this._options.labelData&&$.each(this._options.labelData,function(){if(a.$label)this.label=a.$label;a._textControls.push(g.BaseControl.createIn(kb,a._labelHost,{textData:this}))})};b.prototype.bind=function(a){var b=this;this._workItem=a;if(this._options.labelData){this._workItemChangedDelegate=function(d,c){var a=false;if(c.change===f.WorkItemChangeType.Saved)a=true;else c.change===f.WorkItemChangeType.FieldChange&&$.each(b._textControls,function(){if(this.needRefresh(c.changedFields)){a=true;return false}});a&&b.invalidate()};a.attachWorkItemChanged(this._workItemChangedDelegate)}};b.prototype.unbind=function(){var a=this._workItem;if(this._workItemChangedDelegate){a.detachWorkItemChanged(this._workItemChangedDelegate);delete this._workItemChangedDelegate}};b.prototype.invalidate=function(){var b=this,a=this._workItem.project.extras.resourceLocations;this._workItem&&this._textControls&&$.each(this._textControls,function(){this.setUrl(b._workItem,a)})};b.prototype._createLabel=function(){var b=this._options.label,d=b.indexOf("&"),f,e;if(d>=0){f=b.substr(d+1,1);b=c.StringUtils.htmlEncode(b.substr(0,d))+"<u>"+c.StringUtils.htmlEncode(b.substr(d+1,1))+"</u>"+c.StringUtils.htmlEncode(b.substr(d+2))}else b=c.StringUtils.htmlEncode(b);if(this._options.labelData)this.$label=$("<span/>").attr("for",this._options.controlId+"_txt").html(b);else this.$label=$("<label/>").addClass("workitemcontrol-label").attr("for",this._options.controlId+"_txt").html(b);this._options.labelFontSize&&this.$label.addClass("wit-font-size-"+this._options.labelFontSize);if(this._options.fieldName){e=this._workItemType.getFieldDefinition(this._options.fieldName);e&&this.$label.attr("title",c.StringUtils.format(a.WorkItemFieldLabelTitleFormat,e.helpText,e.name))}f&&this.$label.attr("accesskey",f);this._labelHost.append(this.$label)};return b}();i.initClassPrototype(wb,{_labelHost:null,_options:null,_workItemType:null,$label:null,_textControls:null,_workItem:null,_workItemChangedDelegate:null});var q=function(){function b(a,b){e.assertParamIsObject(a,"tabHost");e.assertParamIsObject(b,"options");this._options=b;this._tabHost=a;this._tabId=a.attr("id");this._originalText=this._getHeaderElement().text();this.initialize()}b.getParentCountingTab=function(a){e.assertParamIsJQueryObject(a,"$childControl");var b=a.parents(".workitemcountingtab").data("wit-tab");return b};b.updateChildCount=function(a,d,f){e.assertParamIsJQueryObject(a,"$childControl");var c=b.getParentCountingTab(a);c&&c.updateChildCount(d,f)};b.prototype.initialize=function(){this._childCounts=[]};b.prototype.updateChildCount=function(a,b){this._childCounts[a]=b;this._applyCountToHeader(this._tabulateChildrenCounts())};b.prototype._tabulateChildrenCounts=function(){var c=0,a,b;for(b in this._childCounts)if(this._childCounts.hasOwnProperty(b)){a=this._childCounts[b];if(a!==null&&a>=0)c+=a;else return null}return c};b.prototype._applyCountToHeader=function(d){var b;if(d===null||d===0)b=this._originalText;else b=c.StringUtils.format(a.WorkItemTabHeaderCount,this._originalText,d);this._setHeaderText(b)};b.prototype._setHeaderText=function(a){this._getHeaderElement().text(a)};b.prototype._getHeaderElement=function(){return this._tabHost.parent(".tabs").children(".headers").find("a[href$='#"+this._tabId+"']")};return b}();d.WorkItemCountingTab=q;i.initClassPrototype(q,{_tabHost:null,_options:null,_tabId:null,_originalText:null,_childCounts:null});function Zb(b){var a,d=$("<table/>").addClass("witform-layout").attr("node","layout");a={};a.minimumSize=b.attr("MinimumSize");a.padding=b.attr("Padding");a.margin=b.attr("Margin");a.controlSpacing=b.attr("ControlSpacing");a.labelSpacing=b.attr("LabelSpacing");a.hideReadOnlyEmptyFields=c.StringUtils.ignoreCaseComparer(b.attr("HideReadOnlyEmptyFields"),"true")===0;a.hideControlBorders=c.StringUtils.ignoreCaseComparer(b.attr("HideControlBorders"),"true")===0;d.data("wit-options",a);b.children().each(function(){switch(this.nodeName.toLowerCase()){case"group":d.append(F(this,null));break;case"tabgroup":d.append(D(this,null));break;case"control":d.append(E(this,null))}});return d}d.readLayout=Zb;function Lb(c,b){var e=c.getAttribute("Label"),d=c.getAttribute("Priority"),a=$("<table/>").addClass("content").css("width","100%");$(c).children().each(function(){switch(this.nodeName.toLowerCase()){case"group":a.append(F(this,b));break;case"tabgroup":a.append(D(this,b));break;case"control":a.append(E(this,b))}});return{label:e,content:a,priority:d||0}}function F(e,g){var a,f=e.getAttribute("Label"),i=$(e),d=$("<tr/>").addClass("group"),c=$("<td/>").attr("colSpan",2).appendTo(d),b=$("<table/>").addClass("content"),h=$("<tr/>").appendTo(b);if(f){a=$("<fieldset/>").css("width","100%");a.append($("<legend/>").text(f));c.append(a)}else a=c;i.children().each(function(){if(this.nodeName.toLowerCase()==="column")h.append(Yb(this,g));else throw new Error("Unexpected node "+this.nodeName+" under GROUP");});a.append(b);return d}function D(g,e){var f=$(g),d=$("<tr/>").addClass("tab-group"),b=$("<td/>").attr("colSpan",2),c=$("<ul/>").addClass("headers"),a=$("<div/>").addClass("tabs");a.append(c);f.children().each(function(){var b;if(this.nodeName.toLowerCase()==="tab"){b=cc(this,e);c.append(b.header);a.append(b.tab)}else throw new Error("Unexpected node "+this.nodeName+" under TABGROUP");});b.append(a);d.append(b);return d}function cc(f,b){var c=f.getAttribute("Label"),i=$(f),d=$("<div/>").addClass("tab-page").addClass("workitemcountingtab"),h="witc_tab_"+g.getId(),a=$("<table/>").addClass("content"),e;i.children().each(function(){switch(this.nodeName.toLowerCase()){case"group":a.append(F(this,b));break;case"tabgroup":a.append(D(this,b));break;case"control":a.append(E(this,b))}});d.append(a);d.attr("id",h).attr("rawTitle",c);e=$("<li/>").append($("<a/>").addClass("header").text(c||"").attr("href","#"+h).attr("rawTitle",c));return{header:e,tab:d}}function Yb(c,b){var d=c.getAttribute("PercentWidth"),g=c.getAttribute("FixedWidth"),h=d?d+"%":g+"px",f=$(c),e=$("<td/>").attr("vAlign","top").css("width",h).addClass("column"),a=$("<table/>").addClass("content");f.children().each(function(){switch(this.nodeName.toLowerCase()){case"group":a.append(F(this,b));break;case"tabgroup":a.append(D(this,b));break;case"control":a.append(E(this,b))}});e.append(a);return e}function E(b,k){var h,j,m,f,l,a,i=$("<tr/>").addClass("control"),e,c=$("<td/>").addClass("control-cell");a={};a.controlId="witc_"+g.getId();a.controlType=b.getAttribute("Type");a.instanceName=b.getAttribute("Name");if(k)a.fieldName=k(b.getAttribute("FieldName"));else a.fieldName=b.getAttribute("FieldName");a.label=l=b.getAttribute("Label");a.labelPosition=b.getAttribute("LabelPosition");a.dock=b.getAttribute("Dock");a.padding=b.getAttribute("Padding");a.margin=b.getAttribute("Margin");a.readOnly=b.getAttribute("ReadOnly");a.minimumSize=b.getAttribute("MinimumSize");a.numberFormat=b.getAttribute("NumberFormat");a.format=b.getAttribute("Format");a.customFormat=b.getAttribute("CustomFormat");a.maxLength=b.getAttribute("MaxLength");a.labelFontSize=b.getAttribute("LabelFontSize");a.controlFontSize=b.getAttribute("ControlFontSize");a.emptyText=b.getAttribute("EmptyText");a.refName=b.getAttribute("RefName");a.outputLayout=b.getAttribute("OutputLayout");a.limit=b.getAttribute("Limit");j=b.getAttribute("Height");if(j)a.height=j;d.readControlOptions(b,a);m=null;if(l||a.labelData){f=$("<div/>");f.addClass("workitemlabel");f.data("wit-options",a)}h=$("<div/>");h.addClass("workitemcontrol");h.data("wit-options",a);a.controlFontSize&&h.addClass("wit-font-size-"+a.controlFontSize);if(f)if(a.controlType.toLowerCase()==="labelcontrol"){e=$("<td/>").addClass("label-cell").css("white-space","pre-line");e.attr("colSpan",2);f.addClass("workitemcontrol");e.append(f);i.append(e)}else switch((a.labelPosition||"left").toLowerCase()){case"right":c.append(h);i.append(c);e=$("<td/>").addClass("label-cell right-label");e.append(f);i.append(e);break;case"top":c.attr("colSpan",2);c.append(f);c.append(h);i.append(c);break;case"bottom":c.attr("colSpan",2);c.append(h);c.append(f);i.append(c);break;default:e=$("<td/>").addClass("label-cell left-label");e.append(f);i.append(e);c.append(h);i.append(c)}else{c.attr("colSpan",2);c.append(h);i.append(c)}return i}function Nb(c,a){var b=c.childNodes;b&&b.length&&$.each(b,function(){switch(this.nodeName){case"LinksControlOptions":Ib(this,a);break;case"WebpageControlOptions":Fb(this,a);break;case"CustomControlOptions":Gb(this,a);break;case"Link":a.labelData=[];a.labelData.push({link:R(this,a)});break;case"LabelText":Kb(this,a)}})}d.readControlOptions=Nb;function Ib(g,d){var f=g.childNodes,b,a,c,e;f&&f.length&&$.each(f,function(){switch(this.nodeName){case"WorkItemLinkFilters":b={filterType:this.getAttribute("FilterType")};if(this.childNodes&&this.childNodes.length){b.filters=[];$.each(this.childNodes,function(){this.nodeName==="Filter"&&b.filters.push({linkType:$.trim(this.getAttribute("LinkType")),filterOn:this.getAttribute("FilterOn")})})}d.workItemLinkFilters=b;break;case"ExternalLinkFilters":a={filterType:this.getAttribute("FilterType")};if(this.childNodes&&this.childNodes.length){a.filters=[];$.each(this.childNodes,function(){this.nodeName==="Filter"&&a.filters.push({linkType:$.trim(this.getAttribute("LinkType"))})})}d.externalLinkFilters=a;break;case"WorkItemTypeFilters":c={filterType:this.getAttribute("FilterType"),scope:this.getAttribute("Scope")};if(this.childNodes&&this.childNodes.length){c.filters=[];$.each(this.childNodes,function(){this.nodeName==="Filter"&&c.filters.push({workItemType:$.trim(this.getAttribute("WorkItemType"))})})}d.workItemTypeFilters=c;break;case"LinkColumns":e=[];this.childNodes&&this.childNodes.length&&$.each(this.childNodes,function(){this.nodeName==="LinkColumn"&&e.push({linkAttribute:this.getAttribute("LinkAttribute"),refName:$.trim(this.getAttribute("RefName"))})});d.linkColumns=e}})}function Fb(b,a){var c=b.childNodes;a.allowScript=b.getAttribute("AllowScript")==="true";a.reloadOnParamChange=b.getAttribute("ReloadOnParamChange")!=="false";c&&c.length&&$.each(c,function(){switch(this.nodeName){case"Link":a.link=R(this,a);break;case"Content":a.content=this.text||this.textContent}})}function R(a){var b,c;c={urlRoot:a.getAttribute("UrlRoot"),urlPath:a.getAttribute("UrlPath")};if(a.childNodes&&a.childNodes.length){b=[];$.each(a.childNodes,function(){var a;if(this.nodeName==="Param"){a=parseInt(this.getAttribute("Index"),10);if(!isNaN(a))b[a]={value:this.getAttribute("Value"),original:this.getAttribute("Type")==="Original"}}});c.params=b}return c}function Vb(b,c){var a;a={};b.childNodes&&b.childNodes.length&&$.each(b.childNodes,function(){if(this.nodeName==="Link")a.link=R(this,c);else a.content=this.nodeValue});return a}function Kb(a,c){var b=[];a.childNodes&&a.childNodes.length&&$.each(a.childNodes,function(){b.push(Vb(this,c))});c.labelData=b}function Gb(a,b){b.customControlOptions=a.cloneNode(true)}function Pb(e){var c,b,a;b=$(tb.parseXml(e.form));a=b.find("Layout[Target='Web']").first();if(a.length===0)a=b.find("Layout").first();c=d.readLayout(a);a.remove();b.remove();return c}function Eb(d,c){var b,a;a={};b=$(tb.parseXml(d.form||""));b.find("Layout").each(function(){if(!this.getAttribute("Hidden")){var e=this.getAttribute("Target-Zone"),d=a[e],b=Lb(this,c);b.content.find(".tabs").tabs();if(!d)a[e]=[b];else d.push(b)}});b.remove();return a}d.parseWorkItemTypeExtension=Eb;function Ab(a){return a.path()}function C(a){return a.id}function db(a){return $.map(a,C).sort().join("-")}function Jb(a,c,b){a=a.toUpperCase();w[a]={controlType:c,requiredModule:b}}d.registerWorkItemControl=Jb;function Hb(a,c){var b=null;if(a){a=a.toUpperCase();if(w[a]){b=w[a].controlType;if(w[a].requiredModule){dc([w[a].requiredModule],function(a){if(a[b])c(a[b]);else c(b)});return}}}c(b)}(function(a){function c(f,e){var d,a,b,c;for(d in e)if(e.hasOwnProperty(d)){a=decodeURIComponent(d);b=null;if(a.charAt(0)==="["&&a.charAt(a.length-1)==="]")b=a.substring(1,a.length-1);else if(a.charAt(0)==="$")b=a.substr(1);if(b){c=f.getField(b);c&&c.isEditable()&&c.setValue(e[d]||"")}}}a.assignInitialValues=c;function b(b){var a;a={};a.parameters=b.workItemType.name;$.each(b.getTemplateFieldValues(),function(b,c){a["["+b+"]"]=c||""});return h.TfsContext.getDefault().getPublicActionUrl("create","workItems",a)}a.generateInitialValueUrl=b})(d.InitialValueHelper||(d.InitialValueHelper={}));var gb=d.InitialValueHelper,X=function(d){__extends(b,d);function b(a){d.call(this,a);this.workItemType=this._options.workItemType;this.extension=this._options.extension;this.form=this._options.form;this.controls=[]}b.prototype._dispose=function(){this.unbind();d.prototype._dispose.call(this)};b.prototype.getLayout=function(){return null};b.prototype.beginAttachLayout=function(a){var c=this,b=this.getLayout();if(this.attached){this.showElement();a&&a()}else{this._element.append(b);this._createLabels();this._createCountingTabs();this._beginCreateControls(function(){if(!b.tabified){c._element.find(".tabs").tabs();b.tabified=true}c.attached=true;a&&a()})}};b.prototype.detachLayout=function(){this.attached&&this.hideElement()};b.prototype.bind=function(a){this._workItem=a;$.each(this.controls,function(c,b){b.bind(a)})};b.prototype.unbind=function(){if(this._workItem){$.each(this.controls,function(b,a){a.unbind()});this._workItem=null}};b.prototype.suppressFieldUpdates=function(a){if(typeof a==="undefined")a=true;$.each(this.controls,function(c,b){b.suppressInvalidate=a})};b.prototype._createLabels=function(){var a=this;this.getLayout().find(".workitemlabel").each(function(){var d=$(this),c,b;b=d.data("wit-options")||{};c=new wb(d,b,a.workItemType);b.workItemLabel=c})};b.prototype._beginCreateControls=function(g){var b=this,f=this.getLayout().find(".workitemcontrol"),d=f.length;f.each(function(m,l){var j=b.workItemType,k=[b.extension],h=$(l),f=h.data("wit-options")||{},i=function(){h.text(c.StringUtils.format(a.ErrorCannotCreateWorkItemControl,f.controlType))};Hb(f.controlType,function(a){if(a)try{var c=new a(h,f,j,k,b);h.data("wit-control",c);b.controls.push(c)}catch(l){e.logError("The following WorkItemControl failed to load: "+f.controlType);i()}else i();d--;if(d===0)g&&g()})})};b.prototype._createCountingTabs=function(){this.getLayout().find(".workitemcountingtab").each(function(){var a=$(this),c,b;b=a.data("wit-options")||{};c=new q(a,b);a.data("wit-tab",c)})};return b}(g.BaseControl);d.WorkItemView=X;var lb=function(b){__extends(a,b);function a(){b.apply(this,arguments)}a.prototype.getLayout=function(){if(!this._layout){this.controls.push(new qb(this._element));var a=Pb(this.workItemType);this._layout=a}return this._layout};a.prototype.initializeOptions=function(a){b.prototype.initializeOptions.call(this,$.extend({coreCssClass:"work-item-view",readOnly:false},a))};a.prototype.bind=function(a){b.prototype.bind.call(this,a);$(this._element).keydown(function(b){if(v.KeyUtils.isExclusivelyCtrl(b)&&String.fromCharCode(b.keyCode).toLowerCase()==="s"){a.isDirty()&&!a.isSaving()&&a.beginSave(null,function(){});return false}})};a.prototype.unbind=function(){b.prototype.unbind.call(this);$(this._element).unbind("keydown")};return a}(X);d.WorkItemFormView=lb;var z=function(b){__extends(a,b);function a(a){b.call(this,a)}a.prototype._dispose=function(){this.unbind(true);this.cancelDelayedFunction("update");b.prototype._dispose.call(this)};a.prototype.bind=function(a){var b=this;this.unbind(true);if(a){a.addRef();if(!this.changedDelegate)this.changedDelegate=function(c,a){b.updateThrottle(a)};a.attachWorkItemChanged(this.changedDelegate);this.workItem=a;this.updateThrottle()}};a.prototype.unbind=function(a){if(this.workItem){this.workItem.release();this.changedDelegate&&this.workItem.detachWorkItemChanged(this.changedDelegate);this.workItem=null;!a&&this.updateThrottle()}};a.prototype.update=function(a){this.updateInternal(a)};a.prototype.updateThrottle=function(a){this.delayExecute("update",200,true,function(){this.updateInternal(a)})};a.prototype.updateInternal=function(a){if($.isFunction(this._options.update))return this._options.update.call(this,this,a)};return a}(g.BaseControl);d.WorkItemThrottleControl=z;i.initClassPrototype(z,{workItem:null,changedDelegate:null,previouslyModified:false});var y=function(e){__extends(d,e);function d(a){e.call(this,a)}d.getWindowTitle=function(e,d){var f,b;if(e){f=e.getCaption(true);b=e.getTitle();if(d>0&&b&&b.length>d)b=b.substr(0,d)+"...";return c.StringUtils.format(a.WorkItemEditorWindowTitle,f,b)}return""};d.prototype.initializeOptions=function(a){e.prototype.initializeOptions.call(this,$.extend({coreCssClass:"workitem-info-bar"},a))};d.prototype.initialize=function(){this._workItemsNavigator=this._options.workItemsNavigator;this._workItemsNavigator&&this._workItemsNavigator.attachEvent("navigate-index-changed",b(this,this._onNavigated))};d.prototype.updateInternal=function(){var d=this.workItem,b=this.getElement(),m,k,l,f,i;if(e.prototype.updateInternal.call(this)===false)return false;b.empty();if(d){i=$("<div>");i.addClass("info-text-wrapper");if(d.isSaving()){l=g.BaseControl.createIn(j.StatusIndicator,i);l.start()}if(this._workItemsNavigator){this._triageDetails=$("<span />").addClass("triage-details hub-title-right");this._updateTriageDetails();b.append(this._triageDetails)}if(d.isNew())f=$("<span>");else{m=h.TfsContext.getDefault().getActionUrl("edit","workitems",{project:d.project.name,team:null,parameters:[d.id]});f=$("<a>");f.attr("href",m)}f.addClass("caption");f.text(c.StringUtils.format(a.WorkItemInfoBarCaptionFormat,d.getCaption(true)));i.append(f);k=d.getInfoText();if(k.invalid)b.addClass("invalid");else b.removeClass("invalid");i.append($("<span />").addClass("info-text").text(k.text||""));b.attr("title",k.text);b.append(i)}else{b.attr("title","");b.removeClass("invalid")}};d.prototype._onNavigated=function(){this._updateTriageDetails()};d.prototype._updateTriageDetails=function(){this._triageDetails&&this._triageDetails.text(this._workItemsNavigator.getStatusText()||"")};return d}(z);d.WorkItemInfoBar=y;i.initClassPrototype(y,{_workItemsNavigator:null,_triageDetails:null});var S=function(f){__extends(d,f);function d(a){f.call(this,a)}d.prototype.initializeOptions=function(a){f.prototype.initializeOptions.call(this,$.extend({coreCssClass:"toolbar"},a))};d.prototype.initialize=function(){var a=this;this._workItemsNavigator=this._options.workItemsNavigator;this._element.addClass("workitem-tool-bar");this.toolbar=g.BaseControl.createIn(r.MenuBar,this._element,{items:this.getToolbarItems(),arguments:function(){return{workItem:a.workItem}},executeAction:b(this,this.onToolbarItemClick)});this._attachEvents()};d.prototype.getToolbarItems=function(){var b=[];if(this._options.inline){b.push({id:"save-work-item",text:a.SaveWorkItem,title:a.SaveWorkItem,showText:false,icon:"icon-save"});b.push({id:"discard-new-work-item",showText:false,text:a.DiscardWorkItem,title:a.DiscardWorkItemTooltip,icon:"icon-delete"})}b.push({id:"refresh-work-item",showText:false,title:a.RefreshTooltip,icon:"icon-refresh"});b.push({id:"revert-work-item",showText:false,title:a.RevertWorkItemTooltip,icon:"icon-undo"});h.TfsContext.getDefault().standardAccessMode===true&&b.push({id:"link-to-new-work-item",showText:false,title:a.NewLinkedWorkItemToolTip,icon:"icon-tfs-work-item-new-linked"});b.push({id:"copy-work-item",showText:false,text:a.CreateCopyOfWorkItem,title:a.CreateCopyOfWorkItemToolTip,icon:"icon-tfs-work-item-copy"});b.push({id:"copy-template-url",text:a.CopyTemplateURL,title:a.CopyTemplateURL,noIcon:true});if(this._workItemsNavigator){b.push({id:"next-work-item",showText:false,icon:"icon-down",cssClass:"right-align"});b.push({id:"prev-work-item",showText:false,icon:"icon-up",cssClass:"right-align"})}return b};d.prototype.updateInternal=function(){var a=0,b=false,c=0;if(this.workItem){a=this.workItem.getUniqueId();b=this.workItem.isDirty();c=this.workItem.isSaving()}this.toolbar.updateCommandStates([{id:"save-work-item",disabled:!b},{id:"discard-new-work-item",hidden:a>=0},{id:"refresh-work-item",disabled:a<=0},{id:"revert-work-item",disabled:a<=0||!b||c},{id:"link-to-new-work-item",disabled:a<=0},{id:"copy-work-item",disabled:a<=0},{id:"copy-template-url",hidden:a>=0}]);this._workItemsNavigator&&this._updateNextPrevious()};d.prototype.onToolbarItemClick=function(g){var f,c,b=this.workItem,d=this.getTypeName();if(b){f=g.get_commandName();switch(f){case"save-work-item":b.beginSave(function(){e.logTracePoint(d+".saveComplete")},function(){});return false;case"refresh-work-item":(!b.isDirty(true)||confirm(a.ConfirmWorkItemRefresh))&&b.beginRefresh(function(){e.logTracePoint(d+".refreshComplete")},function(a){alert(x(a))});return false;case"revert-work-item":if(confirm(a.ConfirmWorkItemRevert)){b.reset();e.logTracePoint(d+".refreshComplete")}return false;case"discard-new-work-item":u.performAction(t.ACTION_WORKITEM_DISCARD_IF_NEW,{workItem:b})&&this._navigatePreviousOrDefault();return false;case"link-to-new-work-item":p.newLinkedWorkItem(b,[b.id],{tfsContext:h.TfsContext.getDefault()});return false;case"copy-work-item":p.createCopyOfWorkItem(b,{tfsContext:h.TfsContext.getDefault()});return false;case"copy-template-url":c=gb.generateInitialValueUrl(b);try{if(window.clipboardData){window.clipboardData.setData("Text",c);alert(a.CreateWorkitemIVURLSuccess)}else prompt(a.CreateWorkitemIVURLPrompt,c)}catch(i){prompt(a.CreateWorkitemIVURLPrompt,c)}return false;case"next-work-item":this._workItemsNavigator&&this._workItemsNavigator.navigateNext();return false;case"prev-work-item":this._workItemsNavigator&&this._workItemsNavigator.navigatePrevious();return false}}};d.prototype.fire=function(b,c,a){return this._fireEvent(b,c,a)};d.prototype._fireEvent=function(d,e,f){var b,a;if(this._events){a=this._events._getEvent(d);if(!a||a.length===0)return undefined;a=c.ArrayUtils.clone(a);for(b=a.length-1;b>=0;b--)if(a[b](e||this,f)===false)return false}};d.prototype.attachEvent=function(a,b){if(!this._events)this._events=new Sys.EventHandlerList;this._events.addHandler(a,b)};d.prototype.detachEvent=function(a,b){this._events&&this._events.removeHandler(a,b)};d.prototype._attachEvents=function(){this._workItemsNavigator&&this._workItemsNavigator.attachEvent("navigate-index-changed",b(this,this._onNavigated))};d.prototype._updateNextPrevious=function(){var b=this._workItemsNavigator.getProvider(),d="";this.toolbar.updateCommandStates([{id:"next-work-item",hidden:!b,disabled:!this._workItemsNavigator.isNextAvailable()},{id:"prev-work-item",hidden:!b,disabled:!this._workItemsNavigator.isPreviousAvailable()}]);if(b){d=b.getTitle();this.toolbar.getItem("next-work-item").updateTitle(c.StringUtils.format(a.TriageNextWorkItemToolTip,d));this.toolbar.getItem("prev-work-item").updateTitle(c.StringUtils.format(a.TriagePreviousWorkItemToolTip,d))}};d.prototype._onNavigated=function(){this._updateNextPrevious()};d.prototype._navigatePreviousOrDefault=function(){if(document.referrer==="")h.history.addHistoryPoint("query",{path:a.AssignedToMeQuery,witd:null,id:null,project:null,triage:null});else window.history.go(-1)};return d}(z);i.initClassPrototype(S,{_workItemsNavigator:null,toolbar:null,_events:null});function xb(C,d){var p,w,v,m,z,t,B="wit-dialog-save"+g.getId(),A="wit-dialog-save-close"+g.getId(),u="wit-dialog-close"+g.getId(),h,q,b,i,r=false,l=false;e.assert($.isFunction(C),"A work item provider is expected.");m=d&&d.readOnly===true;w=d&&d.save;v=d&&d.close;z=d?typeof d.saveButton==="boolean"?d.saveButton:true:true;t=d?typeof d.saveCloseButton==="boolean"?d.saveCloseButton:true:true;p={};function k(c){var a=c;if(b)a=c&&b.isDirty()&&!b.isReadOnly()&&!m&&!b.isSaving();z&&$("#"+B).button("option","disabled",!a);t&&$("#"+A).button("option","disabled",!a);l&&$("#"+u).button("option","disabled",!c)}function D(l,j){var d,g,f=j&&j.closeOnSave===true;e.logTracePoint("WorkItemForm.saveHandler.start");k(false);d=b.getInvalidFields();if(d&&d.length){g=[];$.each(d,function(){g.push(this.fieldDefinition.name)});alert(c.StringUtils.format(a.InvalidFields,g.join(", ")));k(true)}else{r=true;f&&i.suppressFieldUpdates(true);b.beginSave(function(){try{w&&w(b)}finally{r=false}e.logTracePoint("WorkItemForm.saveHandler.saveComplete");if(f){h.setDialogResult("ok");h.close();e.logTracePoint("WorkItemForm.saveHandler.saveAndCloseComplete")}else k(true)},function(){r=false;f&&i.suppressFieldUpdates(false);k(true);i.infoBar.update()})}}if(!m){if(z)p.save={text:a.Save,id:B,disabled:"disabled",click:function(a){D(a,{sender:$(this),closeOnSave:false})}};if(t)p["save-close"]={text:a.SaveAndClose,id:A,disabled:"disabled",click:function(a){D(a,{sender:$(this),closeOnSave:true})}}}p.cancel={id:u,text:l?a.Cancel:a.DialogCloseButtonText,click:function(){h.close()}};function s(){h.cancelDelayedFunction("downloading")}function E(){h.cancelDelayedFunction("completeOpen")}h=j.Dialog.show(j.Dialog,{title:"Work Item Form",minWidth:640,minHeight:480,buttons:p,defaultButton:"save-close",dialogClass:"workitem-dialog",open:function(){var t=false,p=$(this),r;c.delay(this,0,function(){C(function(n){e.assert(n instanceof f.WorkItem,"workItem is expected to be an instance WorkItem object");function j(){h.setTitle(y.getWindowTitle(b,256))}function v(){j();k(true)}q=c.throttledDelegate(this,200,v);b=n;t=true;b.attachWorkItemChanged(q);l=!b.store.workItemManager.hasDirtyManager||b.isNew();l&&$("#"+u).button("option","label",a.Cancel);s();p.empty();r={readOnly:m,toolbar:{inline:false}};if(d&&$.isFunction(d.save))r.workItemChanged=function(a){a.change===f.WorkItemChangeType.Saved&&d.save(a.workItem)};i=g.BaseControl.createIn(o,p,r);i.bind(b);p.data("form",i);h.delayExecute("completeOpen",0,false,function(){j();$("input:visible:not([disabled]):first",i.getElement()).focus(200);!m&&k(true);e.logTracePoint("WorkItemForm.dialogHost.open.complete")})},function(a){s();p.empty();p.append($(n("div","error-work-item-download")).text(x(a)||"Unknown error happened while accessing work item."))});!t&&h.delayExecute("downloading",100,false,function(){var a=g.BaseControl.createIn(j.StatusIndicator,p,{center:true,throttleMinTime:0,imageClass:"big-status-progress",message:hb.Loading});a.start()})})},beforeClose:function(){return r?false:l&&b&&b.isDirty(true)?confirm(a.UnsavedWorkItemPrompt):true},close:function(a){s();E();q&&b.detachWorkItemChanged(q);i&&i.unbind();if(h.getDialogResult()!=="ok"||a.keyCode===27)if(l&&b){b.reset();b.discardIfNew()}v&&v(b)}})}var o=function(k){__extends(a,k);function a(a){k.call(this,a);this.views={};this.extensionLayouts={};this._onWorkItemStatusChangedDelegate=b(this,this._onWorkItemStatusChanged)}a.showWorkItem=function(a,b){xb(function(b){b(a)},b)};a.showWorkItemById=function(b,a,c){e.logTracePoint("WorkItemForm.showWorkItemById.start");e.assert(b>0,"id is expected to be a positive integer");xb(function(d,c){e.assert(a!==null&&typeof a!=="undefined","tfs context is expected.");var g=l.TfsTeamProjectCollection.getConnection(a).getService(f.WorkItemStore);g.workItemManager.beginGetWorkItem(b,d,c)},c)};a.prototype.initializeOptions=function(a){k.prototype.initializeOptions.call(this,$.extend({coreCssClass:"work-item-form",readOnly:false,infoBar:true,toolbar:{inline:true}},a))};a.prototype.initialize=function(){var b,a=this;if(this._options.infoBar)if(this._options.infoBar instanceof y){this.infoBar=this._options.infoBar;this._element.addClass("no-info-bar")}else{this.infoBar=g.BaseControl.createIn(y,this._element,this._options.infoBar.options);this._ownInfoBar=true;this._hideInfoBar()}else this._element.addClass("no-info-bar");if(this._options.toolbar)if(this._options.toolbar instanceof S){this.toolbar=this._options.toolbar;this._element.addClass("no-toolbar")}else{this.toolbar=g.BaseControl.createIn(S,this._element,this._options.toolbar);this._ownToolbar=true;this._hideToolbar()}else this._element.addClass("no-toolbar");j.Dialog._dialogActionInProgress=false;k.prototype.initialize.call(this);if(this._options)if(this._options.action==="edit")this.beginShowWorkItem(this._options.id);else if(this._options.action==="new"){if(!this._options.witd)throw Error.create(c.StringUtils.format(Qb.InvalidParameter,"witd"));b=l.TfsTeamProjectCollection.getConnection(this._options.tfsContext).getService(f.WorkItemStore);b.beginGetProject(this._options.tfsContext.navigation.project,function(b){b.beginGetWorkItemType(a._options.witd,function(c){var b;b=this.store.workItemManager.createWorkItem(c);if(a._options.id)b.tempId=-a._options.id;gb.assignInitialValues(b,a._options.initialValues);a.bind(b);a._setActiveDocument(b)},function(a){i.errorHandler.show(a)})})}};a.prototype._dispose=function(){this.unbind();k.prototype._dispose.call(this)};a.prototype.bind=function(a){var b=this;if(this._workItem!==a){this.unbind();if(!this._disposed){this._workItem=a;a.addRef(this);a.attachWorkItemChanged(this._onWorkItemStatusChangedDelegate);a.isSaving()&&this.showBusyOverlay();this._beginAttachView(a.workItemType,a.extensions,function(){b.currentView.bind(a);b._showInfoBar();b.infoBar&&b.infoBar.bind(a);b._showToolbar();b.toolbar&&b.toolbar.bind(a)})}}};a.prototype.unbind=function(){this.hideBusyOverlay();if(this._workItem){this._workItem.detachWorkItemChanged(this._onWorkItemStatusChangedDelegate);this.infoBar&&this.infoBar.unbind();this.toolbar&&this.toolbar.unbind();this.currentView&&this.currentView.unbind();this._workItem.release(this);this._workItem=null}};a.prototype.suppressFieldUpdates=function(a){if(typeof a==="undefined")a=true;this.currentView&&this.currentView.suppressFieldUpdates(a)};a.prototype.showWorkItem=function(a){if(this._cancelable){this._cancelable.cancel();this._cancelable=null}this.hideBusyOverlay();this._hideError();this._stopProgress();this.bind(a)};a.prototype.focus=function(){$("input:visible:not([disabled]):first",this._element).focus(200)};a.prototype.beginShowWorkItem=function(b,g,d,h){var a=this;function i(i){var h=0,b;e.logTracePoint("WorkItemForm.showWorkItem.start");a._cancelable&&a._cancelable.cancel();a._workItemIdBeingFetched=i;a.cancelDelayedFunction("bind");b=+new Date;if(b-a._lastShow<300)h=250;a._lastShow=b;a.delayExecute("bind",h,true,function(){var b;a._cancelable=new c.Cancelable(a);b=l.TfsTeamProjectCollection.getConnection(a._options.tfsContext).getService(f.WorkItemStore);a._startProgress(250);b.workItemManager.beginGetWorkItem(i,a._cancelable.wrap(function(b){a._cancelable=null;a._stopProgress();a.showWorkItem(b);$.isFunction(g)&&g.call(a,a,b);a._setActiveDocument(b);a._workItemIdBeingFetched=0;e.logTracePoint("WorkItemForm.showWorkItem.complete")}),a._cancelable.wrap(function(b){a._cancelable=null;a._stopProgress();a._workItemIdBeingFetched=0;if($.isFunction(d))d.call(a,b);else a.showError(b)}))})}((this._workItem&&this._workItem.id)!==b||this._workItemIdBeingFetched&&this._workItemIdBeingFetched!==b||h&&h.forceShow)&&i(b)};a.prototype.showError=function(a){this._clearCanvas();this._stopProgress();this.unbind();this._errorSection=$(n("div","error"));this._errorSection.text(x(a)||"Unknown error happened while accessing work item.");this._element.append(this._errorSection)};a.prototype.getWorkItemTypeExtensionLayout=function(b,e){var f=C(b),a=this.extensionLayouts[C(b)];if(!a){a=d.parseWorkItemTypeExtension(b,function(a){return a.match(/^\[.*\]$/)?("WEF_"+b.id.replace(/-/g,"")+"_"+a.substring(1,a.length-1)).toUpperCase():a.toUpperCase()});this.extensionLayouts[f]=a}if(e)return a[e]||[];var c=[];for(var g in a)c=c.concat(a[g]);return c};a.prototype._setActiveDocument=function(b){var a=h.hostServiceManager.getService(h.DocumentService),c=new f.WorkItemDocument(b);a._setActiveDocument(c)};a.prototype._beginAttachView=function(d,f,c){var e=this,b=Ab(d),a=this.views[b];if(!a){a=g.BaseControl.createIn(lb,this._element,{workItemType:d,form:this,readOnly:this._options.readOnly});this.views[b]=a}if(this.currentView)Ab(this.currentView.workItemType)!==b&&this.currentView.detachLayout();a.beginAttachLayout(function(){e.currentView=a;c&&c()},this)};a.prototype._onWorkItemStatusChanged=function(b,a){if(a.change===f.WorkItemChangeType.Saving)this.showBusyOverlay();else if(a.change===f.WorkItemChangeType.Saved||a.change===f.WorkItemChangeType.SaveCompleted)this.hideBusyOverlay();else if(a.change===f.WorkItemChangeType.Discarded)$.isFunction(this._options.close)&&this._options.close.call(this);$.isFunction(this._options.workItemChanged)&&this._options.workItemChanged.call(this,a);h.TfsContext.getDefault().isEmbedded()&&this.delayExecute("notify-modify",200,true,function(){var a=b.isDirty(true);if(a!==this._previouslyModified){this._previouslyModified=a;h.notificationService.fire("tfs-document-modified-change",b,{modified:a,moniker:l.LinkingUtilities.encodeUri({tool:ob.ToolNames.WorkItemTracking,type:ob.ArtifactTypeNames.WorkItem,id:b.id.toString()})})}})};a.prototype._hideToolbar=function(){this._ownToolbar&&this.toolbar.hideElement()};a.prototype._showToolbar=function(){this._ownToolbar&&this.toolbar.showElement()};a.prototype._hideInfoBar=function(){this._ownInfoBar&&this.infoBar.hideElement()};a.prototype._showInfoBar=function(){this._ownInfoBar&&this.infoBar.showElement()};a.prototype._hideCurrentView=function(){this.currentView&&this.currentView.detachLayout()};a.prototype._startProgress=function(b){var a=this;this._stopProgress();this.delayExecute("downloadProgress",b||0,true,function(){a._clearCanvas();a._statusControl=g.BaseControl.createIn(j.StatusIndicator,a._element,{center:true,throttleMinTime:0,imageClass:"big-status-progress",message:hb.Loading});a._statusControl.start()})};a.prototype._stopProgress=function(){this.cancelDelayedFunction("downloadProgress");if(this._statusControl){this._statusControl.dispose();this._statusControl=null}};a.prototype._hideError=function(){if(this._errorSection){this._errorSection.remove();this._errorSection=null}};a.prototype._clearCanvas=function(){this.hideBusyOverlay();this._hideCurrentView();this._hideError();this._hideInfoBar();this._hideToolbar()};a._typeName="tfs.WorkItemForm";return a}(g.BaseControl);d.WorkItemForm=o;i.initClassPrototype(o,{options:null,toolbar:null,_ownToolbar:false,infoBar:null,_ownInfoBar:false,views:null,currentView:null,_workItem:null,_onWorkItemStatusChangedDelegate:null,_cancelable:null,_lastShow:0,_statusControl:null,_errorSection:null,_previouslyModified:false,_workItemIdBeingFetched:0});i.classExtend(o,h.TfsContext.ControlExtensions);var ab=function(h){__extends(d,h);function d(a){h.call(this,a);e.assert(a.workItem instanceof f.WorkItem,"Need a WorkItem object to copy.")}d.prototype.initialize=function(){h.prototype.initialize.call(this);this.setTitle(a.CreateCopyOfWorkItemTitle);this._decorate();this._populateProjects()};d.prototype.getDialogResult=function(){return{project:this.$project.getText(),type:this.$wit.getText()}};d.prototype.onClose=function(a){this._options.workItem=null;h.prototype.onClose.call(this,a)};d.prototype._decorate=function(){var d=this._element,e=this._options.workItem;d.append($("<p />").text(c.StringUtils.format(a.CreateCopyOfWorkItemSourceFormat,e.workItemType.name,e.id,e.getTitle())));d.append("<p><label for='project'>"+a.CreateCopyOfWorkItemProject+"</label><input id='project' name='project' type='text' /></p>");this.$project=g.Enhancement.enhance(j.Combo,d.find("input[name='project']"),{allowEdit:false,indexChanged:b(this,this._onProjectChange)});d.append("<p><label for='wit'>"+a.CreateCopyOfWorkItemType+"</label><input id='wit' name='wit' type='text' /></p>");this.$wit=g.Enhancement.enhance(j.Combo,d.find("input[name='wit']"),{allowEdit:false})};d.prototype._populateProjects=function(){var a,d,f=this,c=this._options.workItem,b=this.$project;c.store.beginGetProjects(function(h){var j,g,i=[];h.sort(function(a,b){return a.name.localeCompare(b.name)});for(a=0,d=h.length;a<d;a++){j=h[a].name;i[i.length]=j;if(j===c.project.name)g=h[a]}g=g||h[0];b.setSource(i);b.setText(g.name);g.beginGetVisibleWorkItemTypeNames(function(a){f._populateWits(a)});e.logTracePoint("CreateCopyOfWorkItemDialog._populateProjects.complete")})};d.prototype._populateWits=function(e){var c,f,b,a,g=this._options.workItem,d=[];for(c=0,f=e.length;c<f;c++){b=e[c];d[d.length]=b;if(b===g.workItemType.name)a=b}a=a||e[0];this.$wit.setSource(d);this.$wit.setText(a);this.updateOkButton(true)};d.prototype._onProjectChange=function(b){var c=this,a=this._options.workItem.store.projects[b];a.beginGetVisibleWorkItemTypeNames(function(a){c._populateWits(a)})};d._typeName="CreateCopyDialog";return d}(j.ModalDialog);i.initClassPrototype(ab,{$project:null,$wit:null});var Z=function(){function a(a){this.store=a.store;this._getAvailableColumns=a.getAvailableColumns}a.prototype.beginGetColumns=function(i){var e,f,h=this,d=this.store,b=this.project,g=this.wit;function a(a){var b,d;a.sort(function(a,b){return c.StringUtils.localeIgnoreCaseComparer(a.name,b.name)});h.columns=a;i(a)}if(!this.columns)if($.isFunction(this._getAvailableColumns))this._getAvailableColumns(function(b){a(b)});else if(g)this.project.beginGetWorkItemType(g,function(b){a(b.fields)});else if(b)b.store.beginGetFields(function(){var g,c=[];for(e=0,f=b.fieldIds.length;e<f;e++){g=d.getFieldDefinition(b.fieldIds[e]);if(g)c[c.length]=g}a(c)});else d.beginGetFields(function(){var b={},c=[];d.beginGetProjects(function(e){$.each(e,function(e,a){$.each(a.fieldIds,function(e,a){if(!(a in b)){b[a]=true;c.push(d.getFieldDefinition(a))}})});a(c)})});else a(this.columns)};a.prototype.reset=function(a){this.columns=null;if(a.level===0){this.project=null;this.wit=null}else if(a.level===1){if(a.project)this.project=this.store.getProject(a.project);this.wit=null}else if(a.level===2)this.wit=a.wit};return a}();i.initClassPrototype(Z,{store:null,project:null,wit:null,_getAvailableColumns:null,columns:null,$project:null,$wit:null});function Q(a,b){return c.StringUtils.format("<option value='{0}'{1}>{2}</option>",a.id,b?" selected":"",a.text)}function J(a,b){return c.StringUtils.format("<option value='{0}'{1}>{2} [{3}]</option>",a.id,b?" selected":"",a.text,a.width)}function N(a,b){return c.StringUtils.format("<option value='{0}'{1}>{2} [{3}]</option>",a.id,b?" selected":"",a.text,a.asc?"Asc":"Desc")}var M=function(h){__extends(d,h);function d(a){h.call(this,a)}d.prototype.initialize=function(){h.prototype.initialize.call(this);this._current="display";this._simpleMode=this._options.simpleMode;this._columnContext={display:{isDisplay:true,columns:{},$button:null,$container:null,$available:null,$selected:null,populated:false},sort:{isSort:true,columns:{},$button:null,$container:null,$available:null,$selected:null,populated:false},reset:function(){this.display.populated=false;this.sort.populated=false}};this._filterContext=new Z({store:l.TfsTeamProjectCollection.getConnection(this._options.tfsContext).getService(f.WorkItemStore),getAvailableColumns:this._options.getAvailableColumns})};d.prototype.onLoadCompleted=function(b){h.prototype.onLoadCompleted.call(this,b);this._columnOptionsElement=$(".column-options",this._element);this.setTitle(a.ColumnOptionsTitle);this._decorate();this._attachEvents();this._populateSelectedColumns();if(!this._simpleMode)this._populateProjects();else this._populateAvailableColumns();this._updateButtons();e.logTracePoint("ColumnOptionsDialog.onLoadCompleted.complete")};d.prototype.getDialogResult=function(){var c=[],a=this._columnContext.display,d=[],b=this._columnContext.sort;a.$selected.children().each(function(){c.push(a.columns[this.value])});b.$selected.children().each(function(){d.push(b.columns[this.value])});return{display:c,sort:d,async:true}};d.prototype._getCurrentContext=function(a){return a===true?this._current==="display"?this._columnContext.sort:this._columnContext.display:this._columnContext[this._current]};d.prototype._decorate=function(){var a=this._element,c=this._filterContext,d=this._columnContext;this._options.allowSort===false&&this._columnOptionsElement.addClass("no-sort");c.$project=g.Enhancement.enhance(j.Combo,a.find("input[name='project']"),{indexChanged:b(this,this._onProjectChange),allowEdit:false});c.$wit=g.Enhancement.enhance(j.Combo,a.find("input[name='wit']"),{indexChanged:b(this,this._onWitChange),allowEdit:false});$.each(["display","sort"],function(e,c){var b=d[c];b.$button=a.find("a."+c);b.$container=a.find("div."+c);b.$available=b.$container.find(".available select");b.$selected=b.$container.find(".selected select")})};d.prototype._attachEvents=function(){var a=this._element,c=this._columnContext.display,d=this._columnContext.sort;c.$button.bind("click",b(this,this._onDisplayClick));c.$available.bind("change",b(this,this._onAvailableListChange)).bind("dblclick",b(this,this._onAvailableListDblClick));c.$selected.bind("change",b(this,this._onSelectedListChange)).bind("dblclick",b(this,this._onSelectedListDblClick));d.$button.bind("click",b(this,this._onSortClick));d.$available.bind("change",b(this,this._onAvailableListChange)).bind("dblclick",b(this,this._onAvailableListDblClick));d.$selected.bind("change",b(this,this._onSelectedListChange)).bind("dblclick",b(this,this._onSelectedListDblClick));a.find("button.add").bind("click",b(this,this._onAddColumnClick)).button();a.find("button.remove").bind("click",b(this,this._onRemoveColumnClick)).button();a.find("button.move-up").bind("click",b(this,this._onMoveColumnUpClick)).button();a.find("button.move-down").bind("click",b(this,this._onMoveColumnDownClick)).button();a.find("button.asc").bind("click",b(this,this._onSetColumnAscClick)).button();a.find("button.desc").bind("click",b(this,this._onSetColumnDescClick)).button();a.find("input.width").bind("blur",b(this,this._onWidthBlur));a.find("input.width").bind("keydown",b(this,this._onWidthKeyDown))};d.prototype._populateProjects=function(){var d,f,e=this,b=this._filterContext,g=this._options.tfsContext;b.store.beginGetProjects(function(h){var i,j=[a.ColumnOptionsAllProjects];e.projects=[];h.sort(function(a,b){return c.StringUtils.localeIgnoreCaseComparer(a.name,b.name)});for(d=0,f=h.length;d<f;d++){i=h[d].name;j[j.length]=i;e.projects.push(i);if(i===g.navigation.project)b.project=h[d]}b.project=b.project||h[0];b.$project.setSource(j);b.$project.setText(b.project.name);e._filterChanged({level:1})})};d.prototype._populateWits=function(){var c,f,b=this._filterContext,d=b.project,e=[a.ColumnOptionsAllWorkItemTypes];this.wits=[];if(d){for(c=0,f=d.workItemTypeNames.length;c<f;c++){e[e.length]=d.workItemTypeNames[c];this.wits.push(d.workItemTypeNames[c])}b.$wit.setEnabled(true)}else b.$wit.setEnabled(false);b.$wit.setSource(e);b.$wit.setText(a.ColumnOptionsAllWorkItemTypes)};d.prototype._populateSelectedColumns=function(){var b=this._filterContext,a=this._options,c=this._columnContext.display,d=this._columnContext.sort;$.each(a.displayColumns,function(d,a){var b={id:a.fieldId,text:a.text,name:a.name,width:a.width};c.columns[a.fieldId]=b;c.$selected.append(J(b,false))});a.allowSort&&b.store.beginGetFields(function(){$.each(a.sortColumns,function(f,e){var c,a=b.store.getFieldDefinition(e.name);if(a){c={id:a.id,text:a.name,name:e.name,asc:!e.descending};d.columns[a.id]=c;d.$selected.append(N(c,false))}});e.logTracePoint("ColumnOptionsDialog._populateSelectedColumns.complete")})};d.prototype._populateAvailableColumns=function(){var c,d,b,a=this._getCurrentContext(),f=this;this._filterContext.beginGetColumns(function(g){if(!a.populated){a.$available.empty();for(c=0,d=g.length;c<d;c++){b=g[c];!a.columns[b.id]&&(!a.isSort||b.canSortBy())&&a.$available.append(Q({id:b.id,text:b.name},false))}a.populated=true;f._updateButtons()}e.logTracePoint("ColumnOptionsDialog._populateAvailableColumns.complete")})};d.prototype.createColumnInfoForField=function(c){var a=this._filterContext.store.getFieldDefinition(c),b;if(a){b={id:a.id,text:a.name,name:a.referenceName};return b}return null};d.prototype._addColumns=function(){var e,g,f,d=[],i,a,c=[],b=this._getCurrentContext(),h=this._filterContext;b.$available.find("option:selected").each(function(){d[d.length]=this.value;$(this).remove()});for(e=0,g=d.length;e<g;e++){f=d[e];a=this.createColumnInfoForField(f);if(a){if(b.isDisplay)a.width=k.LinkColumnHelper.getFieldColumnWidth(f,h.store);else a.asc=true;c[c.length]=b.isDisplay?J(a,true):N(a,true);b.columns[a.id]=a}}c.length&&b.$selected.append(c.join());this._updateButtons();b.$selected.focus()};d.prototype._removeColumns=function(){var e,f,d,c=[],i,b,a=this._getCurrentContext(),g=this._filterContext;a.$selected.find("option:selected").each(function(){c[c.length]=this.value;$(this).remove()});function h(c,d){var a=false;c.children().each(function(){if(d.text<this.text){$(this).before(Q(b,true));a=true;return false}});!a&&c.append(Q(b,true))}for(e=0,f=c.length;e<f;e++){d=c[e];b=a.columns[d];if(b){i=g.store.getFieldDefinition(d);h(a.$available,b);delete a.columns[d]}}this._updateButtons();a.$available.focus()};d.prototype._moveColumnUp=function(){this._getCurrentContext().$selected.find("option:selected").each(function(){var a=$(this).prev();!a.attr("selected")&&$(this).insertBefore(a)})};d.prototype._moveColumnDown=function(){$.each(this._getCurrentContext().$selected.find("option:selected").toArray().reverse(),function(){var a=$(this).next();!a.attr("selected")&&$(this).insertAfter(a)})};d.prototype._setColumnSort=function(b){var a=this._getCurrentContext();a.$selected.find("option:selected").each(function(){var c=a.columns[this.value];if(c){c.asc=b;$(this).replaceWith(N(c,true))}})};d.prototype._setColumnWidth=function(b){var a=this._getCurrentContext();a.$selected.find("option:selected").each(function(){var c=a.columns[this.value];if(c){c.width=b;$(this).replaceWith(J(c,true))}})};d.prototype._updateButtons=function(){var a=this._getCurrentContext(),c=a.populated===true,d=a.$available.children(":selected").length===0||!c,b=a.$selected.children(":selected").length===0||!c;a.$available.closest("div.available").find("button.add").button("option","disabled",d);a.$available.closest("div.available").find("button.remove").button("option","disabled",b);a.$selected.closest("div.selected").find("button").button("option","disabled",b);this.updateOkButton(this._columnContext.display.$selected.children().length>0)};d.prototype._filterChanged=function(a){this._columnContext.reset();this._filterContext.reset(a);a.level<2&&this._populateWits();this._populateAvailableColumns()};d.prototype._tabChanged=function(c){var a,b;c=c||"display";if(this._current!==c){this._current=c;a=this._getCurrentContext();b=this._getCurrentContext(true);a.$button.addClass("selected");a.$button.parent().addClass("selected");a.$container.show();b.$button.removeClass("selected");b.$button.parent().removeClass("selected");b.$container.hide();this._populateAvailableColumns();this._updateButtons()}};d.prototype._onDisplayClick=function(){this._tabChanged("display");return false};d.prototype._onSortClick=function(){this._tabChanged("sort");return false};d.prototype._onProjectChange=function(a){if(a>0)this._filterChanged({level:1,project:this.projects[a-1]});else this._filterChanged({level:0})};d.prototype._onWitChange=function(a){if(a>0)this._filterChanged({level:2,wit:this.wits[a-1]});else this._filterChanged({level:1})};d.prototype._onAvailableListChange=function(){this._updateButtons()};d.prototype._onAvailableListDblClick=function(){this._addColumns();return false};d.prototype._onSelectedListChange=function(){var c,a,b=this._getCurrentContext();if(b.isDisplay){a=b.$selected.children(":selected");if(a.length>0){c=b.columns[a.first().val()];c&&this._element.find("input.width").val(c.width).removeAttr("disabled").removeClass("disabled")}else this._element.find("input.width").val("").attr("disabled",true).addClass("disabled")}this._updateButtons()};d.prototype._onSelectedListDblClick=function(){this._removeColumns();return false};d.prototype._onAddColumnClick=function(){this._addColumns();return false};d.prototype._onRemoveColumnClick=function(){this._removeColumns();return false};d.prototype._onMoveColumnUpClick=function(){this._moveColumnUp();return false};d.prototype._onMoveColumnDownClick=function(){this._moveColumnDown();return false};d.prototype._onSetColumnAscClick=function(){this._setColumnSort(true);return false};d.prototype._onSetColumnDescClick=function(){this._setColumnSort(false);return false};d.prototype._applyWidthChange=function(d){var e=false,c=$.trim(d.val()),b;function f(){alert(a.ColumnOptionsInvalidWidth);d.focus()}if(this._getCurrentContext().$selected.children(":selected").length>0){if(c.length&&!isNaN(Number(c))){b=parseInt(c,10);if(b>=0&&b<=65536){this._setColumnWidth(b);e=true}}if(!e){f();return false}}};d.prototype._onWidthBlur=function(a){return this._applyWidthChange($(a.currentTarget))};d.prototype._onWidthKeyDown=function(a){if(a.keyCode===13)return this._applyWidthChange($(a.currentTarget))};d._typeName="ColumnOptionsDialog";return d}(j.ModalDialog);d.ColumnOptionsDialog=M;i.initClassPrototype(M,{projects:null,wits:null,_current:null,_columnOptionsElement:null,_columnContext:null,_filterContext:null,_simpleMode:null});function eb(a){return $.extend({width:400,minHeight:300,height:"auto"},a)}function Mb(a){return $.extend({width:300,height:"auto"},a)}function ib(b,a){j.Dialog.show(j.Dialog,Mb($.extend({contentText:x(b),cssClass:"dialog-error"},a)))}function rb(a,h,c,g){var d,b=h.tfsContext;if(a instanceof f.WorkItem)c(a);else{e.assert(Boolean(b),"tfs context is expected.");d=l.TfsTeamProjectCollection.getConnection(b).getService(f.WorkItemStore);d.workItemManager.beginGetWorkItem(a,function(a){c(a)},function(a){g(a)})}}function K(b,d,a,c){a=eb(a);rb(d,a,function(d){a.workItem=d;a.okCallback=function(a){c.call(this,d,a)};j.Dialog.show(b,a)},function(a){ib(a,null)})}var p=function(){function a(){}a.columnOptions=function(a){var b=a.simpleMode;return j.Dialog.show(M,eb($.extend(a,{width:560,simpleMode:b,getAvailableColumns:a.getAvailableColumns,height:b?350:420,cssClass:"column-options-host"+(b?" simple":""),initialFocusSelector:"select",okCallback:a.okCallback,url:a.tfsContext.getActionUrl("columnOptions","wit",{area:"api",simpleMode:b||false,includeLanguage:true})})))};a.createCopyOfWorkItem=function(b,c,a){K(ab,b,c,function(c,b){c.store.beginGetProject(b.project,function(d){d.beginGetWorkItemType(b.type,function(d){var b=c.copy(d);if($.isFunction(a))if(a.call(b,b)===false)return;o.showWorkItem(b,{saveButton:true})})})})};a.useWorkItemAsATemplate=function(b,c,a){rb(b,c,function(c){var b=c.copy(c.workItemType,false,false,true,[1]);if($.isFunction(a))if(a.call(b,b)===false)return;o.showWorkItem(b,{saveButton:true})},function(a){ib(a,null)})};a.linkToExistingWorkItem=function(c,a,d){function b(c,a){var b=[];$.each(a.links,function(e,d){switch(a.linkType){case"WorkItemLink":b.push(f.WorkItemLink.create(c,a.linkTypeEnd.immutableName,d.id,a.comment||""));break;case"Hyperlink":b.push(f.Hyperlink.create(c,d.location,a.comment||""));break;case k.LinkingUtils.RegisteredLinkTypeChangeset:case k.LinkingUtils.RegisteredLinkTypeVersionedItem:case k.LinkingUtils.RegisteredLinkTypeCommit:case k.LinkingUtils.RegisteredLinkTypeStoryboard:b.push(f.ExternalLink.create(c,a.linkType,d.artifactUri,a.comment||""))}});c.addLinks(b)}K(k.LinkToExistingDialog,c,$.extend(d,{multipleTarget:a.length>1}),function(d,e){var c,f;function g(a){b(a,e)}if(!d.isNew())for(c=0,f=a.length;c<f;c++)d.store.workItemManager.beginGetWorkItem(a[c],g);else b(d,e)})};a.newLinkedWorkItem=function(c,a,d,b){K(k.NewLinkedWorkItemDialog,c,$.extend(d,{multipleTarget:a.length>1}),function(d,c){d.project.beginGetWorkItemType(c.workItemType,function(i){var g,k,e,j,h=[];e=i.store.workItemManager.createWorkItem(i);e.getField(1).setValue(c.title||"");if(a.length===1){e.setFieldValue(-2,d.getFieldValue(-2));e.setFieldValue(-104,d.getFieldValue(-104));e.setFieldValue(24,d.getFieldValue(24))}j=i.store.findLinkTypeEnd(c.linkTypeEnd).oppositeEnd;for(g=0,k=a.length;g<k;g++)h[h.length]=f.WorkItemLink.create(e,j,a[g],c.comment||"");e.addLinks(h);if($.isFunction(b))if(b.call(e,e)===false)return;o.showWorkItem(e,{saveButton:true})})})};return a}();d.WITDialogs=p;var m=function(){function a(d,g,e,f){var c;if(this.constructor===a)throw new Error("You cannot instantiate an abstract type.");this._container=d;this._controlContainer=d.parents(".control:first");this._options=$.extend({},g);this._workItemType=e;this._extensions=f||[];this._readOnly=this._options.readOnly==="True";this._fieldName=this._options.fieldName;this._instanceName=this._options.instanceName;c=d.parents(".witform-layout:first").data("wit-options");if(c)this._hideReadOnlyEmptyFields=c.hideReadOnlyEmptyFields;if(this._options.labelData)this._workItemLabel=this._options.workItemLabel;this._onFieldChangedDelegate=b(this,this._onFieldChanged);this._init()}a.prototype._getFieldType=function(){var a=null;if(this._fieldName&&this._workItemType){a=this._workItemType.getFieldDefinition(this._fieldName);if(a)return a.type}return 0};a.prototype.getFieldDefinition=function(c){for(var e=(""+c).toUpperCase(),a=this._workItemType.getFieldDefinition(c),b=0;b<this._extensions.length&&!a;b++){var d=this._extensions[b],f=d.id;$.each(d.fields,function(){if(this.field.referenceName.toUpperCase()==e){a=this;return false}})}return a};a.prototype._getField=function(){var a=null;if(this._fieldName&&this._workItem)a=this._workItem.getField(this._fieldName);return a};a.prototype._getFieldTextValue=function(a){a=a||this._getField();return a?a.getDisplayText():""};a.prototype.isReadOnly=function(){var a;if(this._readOnly)return true;if(!this._workItem||this._workItem.isReadOnly())return true;a=this._getField();return a&&a.isReadOnly()?true:false};a.prototype._init=function(){if(this._fieldName)this._fieldEvents=[this._fieldName];this._container.keydown(b(this,this._onKeyDownHandler))};a.prototype._onFieldChanged=function(){!this.suppressInvalidate&&this.invalidate(this._flushing)};a.prototype.bind=function(a){var b,c;this.cleanUp();this._workItemLabel&&this._workItemLabel.bind(a);a.addRef();this._workItem=a;if(this._fieldEvents)for(b=0,c=this._fieldEvents.length;b<c;b++)a.attachFieldChange(this._fieldEvents[b],this._onFieldChangedDelegate);this.invalidate(false)};a.prototype.unbind=function(){this._workItemLabel&&this._workItemLabel.unbind();this.cleanUp();this.clear()};a.prototype.cleanUp=function(){var a,b;if(this._workItem){if(this._fieldEvents)for(a=0,b=this._fieldEvents.length;a<b;a++)this._workItem.detachFieldChange(this._fieldEvents[a],this._onFieldChangedDelegate);this._workItem.release();this._workItem=null}};a.prototype.invalidate=function(){var b,a;if(this._hideReadOnlyEmptyFields){b=this._getField();if(b){a=b.getValue();if(b.isReadOnly()&&(a===undefined||a===null||a===""))this._controlContainer.hide();else this._controlContainer.show()}}this._workItemLabel&&this._workItemLabel.invalidate()};a.prototype.flush=function(){if(!this.isReadOnly()){var a=this._getField();if(a)try{this._flushing=true;a.setValue(this._getControlValue())}finally{this._flushing=false}}};a.prototype._getControlValue=function(){return null};a.prototype.clear=function(){};a.prototype._onKeyDownHandler=function(a){if(a.keyCode===8&&this.isReadOnly())return false};return a}();d.WorkItemControl=m;var I=function(b){__extends(a,b);function a(c,d,a){b.call(this,c,d,a)}a.prototype._smartFlush=function(c,b){if(!this.isReadOnly()){var a=this._getField();if(a)try{this._flushing=true;a.setValue(this._getControlValue(),b)}finally{this._flushing=false}}};return a}(m);d.UndoableWorkItemControl=I;var L=function(b){__extends(a,b);function a(a){b.call(this,a)}a.prototype._getControlValue=function(){};a.prototype._setControlValue=function(){};a.prototype._controlReady=function(){return true};a.prototype.getValue=function(){var a=this._getControlValue();return this._initialBrowserValue&&this._initialBrowserValue===a?this._initialSetValue:a};a.prototype.setValue=function(a){var b=this;this._setControlValue(a);if(!this._valueHasBeenSet)if(!this._controlReady())c.delay(b,0,function(){b.setValue(a)});else{this._valueHasBeenSet=true;this._initialBrowserValue=this._getControlValue();if(this._initialBrowserValue!==a)this._initialSetValue=a;else this._initialBrowserValue=null}};a.prototype.clear=function(){this.setValue("");this._valueHasBeenSet=false;this._initialBrowserValue=null;this._initialSetValue=null};a.prototype.setUploadAttachmentApiLoc=function(){};return a}(g.BaseControl);i.initClassPrototype(L,{_control:null,_initialBrowserValue:null,_initialSetValue:null,_valueHasBeenSet:false});var fb=function(b){__extends(a,b);function a(a){b.call(this,a)}a.prototype.initialize=function(){b.prototype.initialize.call(this);var a=$.extend({fireOnEveryChange:true,blankPageUrl:Bb.getThemedFile("Blank.htm"),height:250,change:this._options.change,id:this._options.controlId},this._options);this._control=g.BaseControl.createIn(j.RichEditor,this._element,a)};a.prototype._getControlValue=function(){return this._control.getValue()};a.prototype._setControlValue=function(a){this._control.setValue(a)};a.prototype.setValue=function(c){var d=this,a=b.prototype.setValue;this._control.ready(function(){a.call(d,c)})};a.prototype._controlReady=function(){return this._control._window.document.body};a.prototype.setEnabled=function(a){this._control.ready(function(){this.setEnabled(a)})};a.prototype.setUploadAttachmentApiLoc=function(a){this._control.ready(function(){this.setUploadAttachmentApiLoc(a)})};a.prototype.getFieldRequired=function(){return this._fieldRequired===true};a.prototype.setFieldRequired=function(a){this._fieldRequired=a;this._control.setFieldRequired(a)};return a}(L);i.initClassPrototype(fb,{_fieldRequired:null});var bb=function(c){__extends(a,c);function a(a){c.call(this,a);this._fieldRequired=false}a.prototype.initialize=function(){c.prototype.initialize.call(this);this._control=$("<textarea class='plaintextcontrol' />").appendTo(this._element);this._bind(this._control,"keyup",b(this,this._onChange));this._setFieldRequiredStyle()};a.prototype._getControlValue=function(){return this._control.val()};a.prototype._setControlValue=function(a){this._control.val(a)};a.prototype.setEnabled=function(a){if(a)this._control.removeAttr("disabled");else this._control.attr("disabled",true)};a.prototype.setFieldRequired=function(a){this._fieldRequired=a===true};a.prototype._onChange=function(){this._setFieldRequiredStyle();this._fireChange()};a.prototype._setFieldRequiredStyle=function(){this._control.toggleClass("invalid",this._fieldRequired&&this._control.val()==="")};return a}(L),P=function(d){__extends(a,d);function a(b,c,a){d.call(this,b,c,a)}a.prototype.invalidate=function(a){if(!a){d.prototype.invalidate.call(this,a);this._controlAdapter.setValue(this._getFieldTextValue());this._controlAdapter.setEnabled(!this.isReadOnly());this._controlAdapter.setFieldRequired(this.getFieldRequired());this._controlAdapter.setUploadAttachmentApiLoc(this._getUploadAttachmentBinaryApiLocation())}};a.prototype._init=function(){var a,c,e={controlId:this._options.controlId,change:b(this,this.flush),customCommandGroups:cb(this)};d.prototype._init.call(this);c=this._getFieldType();if(c===7||c===9)a=fb;else a=bb;this._controlAdapter=g.BaseControl.createIn(a,this._container,e)};a.prototype._getControlValue=function(){return this._controlAdapter.getValue()};a.prototype.clear=function(){this._controlAdapter.clear()};a.prototype.flush=function(b,a){if(this._controlAdapter instanceof bb){d.prototype.flush.call(this);return}else this._smartFlush(b,a)};a.prototype.getFieldRequired=function(){return this._getField&&this._getField().fieldDefinition&&this._getField().fieldDefinition.rules&&c.ArrayUtils.contains(this._getField().fieldDefinition.rules,"Required")?true:false};a.prototype._getUploadAttachmentBinaryApiLocation=function(){var b,a="";if(this._workItem){b=this._workItem.getField(-2).getValue();a=h.TfsContext.getDefault().getActionUrl("UploadAttachmentBinary","wit",{area:"api",areaId:b})}return a};return a}(I);d.HtmlFieldControl=P;i.initClassPrototype(P,{_controlAdapter:null});d.registerWorkItemControl("HtmlFieldControl",P);var A=function(){function a(a,e,d){var c;this._workItemControl=a;this._control=g.BaseControl.createIn(j.Combo,a._container,$.extend({mode:"text",change:b(this,function(){a.flush();return false}),id:a._options.controlId},d));a._options.emptyText&&$("input",this._control.getElement()).Watermark({watermarkText:a._options.emptyText});c=Math.min(a._options.maxLength||f.WorkItem.MAX_TITLE_LENGTH,f.WorkItem.MAX_TITLE_LENGTH);$("input",this._control.getElement()).attr("maxlength",c);this._options=$.extend({dropSourceGenerator:function(a){return a.hasList()?b(a,a.getAllowedValues):null}},e)}a.prototype.invalidate=function(g,b){var a=this._control,e=this._workItemControl,c,d,f;if(b)if(!g){c=e.isReadOnly();if(!c&&(d=this._options.dropSourceGenerator(b))){a.setMode("drop");a.setSource(d)}else a.setMode("text");f=e._getFieldTextValue(b);a.setText(f);a.setInvalid(!b.isValid());a.setEnabled(!c)}else a.setInvalid(!b.isValid());else{a.setMode("text");this.clear();a.setEnabled(false)}};a.prototype.getValue=function(){return this._control.getText()};a.prototype.clear=function(){this._control.setText("")};return a}();i.initClassPrototype(A,{_workItemControl:null,_options:null,_control:null});var nb=function(){function a(a){this._workItemControl=a;this._control=$("<input type='checkbox' />").appendTo(a._container).bind("change",b(this,this.onChanged));a._options.controlId&&this._control.attr("id",a._options.controlId+"_txt")}a.prototype.invalidate=function(b,a){if(this._workItemControl.isReadOnly())this._control.attr("disabled","disabled");else this._control.removeAttr("disabled");this._control.attr("checked",a.getValue())};a.prototype.getValue=function(){return this._control.attr("checked")?true:false};a.prototype.clear=function(){this._control.attr("checked",false)};a.prototype.onChanged=function(){this._workItemControl._getField().setValue(this.getValue())};return a}();i.initClassPrototype(nb,{_workItemControl:null,_control:null});var U=function(b){__extends(a,b);function a(d,e,a,c){b.call(this,d,e,a,c)}a.prototype._init=function(){b.prototype._init.call(this);if(this._fieldName&&this._workItemType&&this.getFieldDefinition(this._fieldName).type===12)this._control=new nb(this);else this._control=new A(this,{},{cssClass:this._options.comboCssClass})};a.prototype.invalidate=function(a){b.prototype.invalidate.call(this,a);this._control.invalidate(a,this._getField())};a.prototype._getControlValue=function(){return this._control.getValue()};a.prototype.clear=function(){this._control.clear()};return a}(m);d.FieldControl=U;i.initClassPrototype(U,{_control:null});d.registerWorkItemControl("FieldControl",U);var pb=function(b){__extends(a,b);function a(c,d,a){b.call(this,c,d,a)}a.prototype._init=function(){b.prototype._init.call(this);this._control=new A(this,{dropSourceGenerator:function(){return[]}},{type:"date-time"})};a.prototype.invalidate=function(a){b.prototype.invalidate.call(this,a);this._control.invalidate(a,this._getField())};a.prototype._getControlValue=function(){return this._control.getValue()};a.prototype.clear=function(){this._control.clear()};return a}(m);i.initClassPrototype(pb,{_control:null});d.registerWorkItemControl("DateTimeControl",pb);function Rb(b,a,c){var e,j,i=b.children,f,h;c=c||1;h=b.name?b.name:b.text;if(a){f=g.TreeNode.create(h);a.add(f);a=f}else a=g.TreeNode.create(h);a.expanded=c<2;if(i)for(e=0,j=i.length;e<j;e++){b=i[e];d.populateUINodes(b,a,c+1)}return a}d.populateUINodes=Rb;var G=function(c){__extends(a,c);function a(b,d,a){c.call(this,b,d,a)}a.prototype._init=function(){c.prototype._init.call(this);this._control=new A(this,{dropSourceGenerator:function(a){return b(a,function(){var c,b;if(a.fieldDefinition.id===-7)c=a.workItem.project.getAreaNode();else c=a.workItem.project.getIterationNode();b=d.populateUINodes(c,null,1);b.text=a.workItem.project.name;return[b]})}},{type:"tree",initialLevel:2,sepChar:"\\",cssClass:this._options.comboCssClass})};a.prototype.invalidate=function(a){c.prototype.invalidate.call(this,a);this._control.invalidate(a,this._getField())};a.prototype._getControlValue=function(){return this._control.getValue()};a.prototype.clear=function(){this._control.clear()};return a}(m);d.WorkItemClassificationControl=G;i.initClassPrototype(G,{_control:null});d.registerWorkItemControl("WorkItemClassificationControl",G);function Ub(a,b){var c;if(!a.fieldDefinition)return false;switch(a.fieldDefinition.id){case-3:case 54:case-4:case-5:case 9:case-1:case 3:case 7:case s.DalFields.PersonID:case 75:case-32:case-57:case-31:return false}if(a.workItem.isExtensionMarkerField(a.fieldDefinition))return false;if(b===0){c=a.workItem.getFieldValueByRevision(a.fieldDefinition.id,b);if(f.Field.isEmpty(c))return false}return true}function sb(b){var d=c.StringUtils.format("<b>{0}</b>",b.changedByName);return c.StringUtils.ignoreCaseComparer(b.authorizedAs,b.changedByName)!==0?c.StringUtils.format(a.WorkItemLogControlUserViaUser,d,b.authorizedAs):d}function T(a){$("a",a).each(function(){$(this).attr("target","_blank")});return a}var O=function(e){__extends(d,e);function d(b,c,a){e.call(this,b,c,a)}d.prototype._init=function(){var l=this,c,d,k=g.getId(),f,h,i;this._workItemLinkRegex=/^x-mvwit:workitem\/([0-9]+)$/;this._fieldName=this._fieldName||"System.History";e.prototype._init.call(this);this._container.addClass("workitemlogcontrol").closest("table").css("table-layout","fixed");i={fireOnEveryChange:true,blankPageUrl:Bb.getThemedFile("Blank.htm"),height:"150px",change:b(this,this._smartFlush),customCommandGroups:cb(this),id:this._options.controlId,linkClickHandler:b(this,this._workItemLinkClickHandler)};this._control=g.BaseControl.createIn(j.RichEditor,this._container,i);this._tabHost=c=$("<div/>");d=$("<ul/>").appendTo(c);this._stateGraph=g.BaseControl.createIn(H,this._container,null);f="discussion_"+k;h="details_"+k;$("<li/>").appendTo(d).append($("<a/>").attr("href","#"+f).text(a.WorkItemLogControlDiscussionTitle));$("<li/>").appendTo(d).append($("<a/>").attr("href","#"+h).text(a.WorkItemLogControlDetailsTitle));this._discussion=$(n("div","discussion-host")).attr("id",f).appendTo(c);this._details=$(n("div","details-host")).attr("id",h).appendTo(c);this._container.append(c);c.tabs({selected:0,activate:function(){l._loadTab(l._tabHost.tabs("option","active"))}});$("a[href^='x-mvwit']",this._container).live("click",b(this,this._workItemLinkClickHandler))};d.prototype._getControlValue=function(){return this._control.getValue()};d.prototype.invalidate=function(b){var c=this,a="";if(!b){a=this._getUploadAttachmentBinaryApiLocation();this._control.ready(function(){this.setValue(c._getFieldTextValue());this.setEnabled(!c.isReadOnly());this.setUploadAttachmentApiLoc(a)});this._reset();this._loadTab(this._tabHost.tabs("option","active"));this._stateGraph&&this._stateGraph.bindToWorkItem(this._workItem);e.prototype.invalidate.call(this,b)}};d.prototype.clear=function(){this._control.ready(function(){this.setValue("")})};d.prototype._workItemLinkClickHandler=function(b){var a=this._workItemLinkRegex.exec(b.currentTarget.href);if(a){r.menuManager.executeCommand(new Sys.CommandEventArgs("open-work-item",{id:a[1],tfsContext:h.TfsContext.getDefault()},null));return false}};d.prototype._reset=function(){this._discussion.empty();this._details.empty()};d.prototype._loadTab=function(a){if(!this._workItem)return;if(a===0)this._loadDiscussion();else a===1&&this._loadDetails()};d.prototype._loadDiscussion=function(){var g,k,d,i,h,f,e,j,b,m="",o="",l="";if(this._discussion.is(":empty")){i=this._workItem.getHistory().getMessageActions();k=i.length;if(k>0){h=$(n("ul","message-list"));for(g=0;g<k;g++){d=i[g];if(d&&d.message){f=$(n("li","message-row")).attr({vAlign:"top"});e=$(n("div","message-section"));b=d.changedByIdentity;if(b){m=b.email;o=b.uniqueName;l=c.StringUtils.format("{0} ({1})",b.displayName,b.uniqueName)}$(n("span","message-sendername person")).html(sb(d)).attr({"data-sip":m,title:l}).appendTo(e);$(n("span","message-date")).text(c.StringUtils.format(" ({0})",c.DateUtils.ago(d.getChangedDate()))).attr("title",c.DateUtils.localeFormat(d.getChangedDate(),"F")).appendTo(e);T($(n("div","message-content")).html(this._getNormalizedHtml(d.getRev()))).appendTo(e);f.append(e);j=$(n("span","message-sender"));j.append(Cb.identityImageElement(null,b&&b.id));f.append(j);h.append(f)}}this._discussion.append(h)}else this._discussion.text(a.NoEntriesWithComments)}};d.prototype._loadDetails=function(){var c,f,d,e;if(this._details.is(":empty")){e=this._workItem.getHistory().getActions();for(c=0,f=e.length;c<f;c++){d=e[c];d&&g.BaseControl.createIn(j.CollapsiblePanel,this._details,{hoverCss:"action-hover",expandCss:"action-expand",cssClass:"item"}).appendHeader(this._createRevisionSummary(d)).appendContent(b(this,this._createRevisionDetails,[c]))}f===0&&this._details.text(a.NoEntries)}};d.prototype._getNormalizedHtml=function(c){var b=this._workItem.getHistory(),a=b.findMessageActionSetByRev(c);return a&&a.getSafeHtmlMessage()||""};d.prototype._createRevisionSummary=function(b){var d=[],g=[],h=false,f=$("<span/>"),e,j="",k="",i="";if(b.fieldsChanged())if(b.getRev()===0)d.push({order:10,message:c.StringUtils.format(a.WorkItemLogControlCreatedWorkItem,this._workItemType.name)});else{b.stateChanges&&d.push({order:20,highlight:true,message:c.StringUtils.format(a.WorkItemLogControlStateChange,b.stateChanges[0],b.stateChanges[1])});h=true}b.attachmentAdded()&&d.push({order:50,message:a.WorkItemLogControlAttachmentAdded});b.attachmentDeleted()&&d.push({order:60,message:a.WorkItemLogControlAttachmentDeleted});b.linkAdded()&&d.push({order:70,message:a.WorkItemLogControlLinkAdded});b.linkDeleted()&&d.push({order:80,message:a.WorkItemLogControlLinkDeleted});b.message&&d.push({order:30,message:a.WorkItemLogControlAddedComment});d.sort(function(a,b){return a.order-b.order});g=d.slice(0,2);if(d.length>=2)g.push({message:a.WorkItemLogControlMadeOtherChanges});else h&&g.push({message:a.WorkItemLogControlMadeChanges});e=b.changedByIdentity;if(e){j=e.email;k=e.uniqueName;i=c.StringUtils.format("{0} ({1})",e.displayName,e.uniqueName)}f.append(Cb.identityImageElement(null,e&&e.id).attr("align","absMiddle"));$("<span/>").addClass("action-headerperson person").html(sb(b)).attr({"data-sip":j,title:i}).appendTo(f);$.each(g,function(c,a){var b=(c===0?"":", ")+a.message;$("<span/>").addClass(a.highlight?"action-headeritemhilite":"action-headeritem").text(b).appendTo(f)});$("<span/>").addClass("action-headerdate").text(c.StringUtils.format("({0})",c.DateUtils.ago(b.getChangedDate()))).attr("title",c.DateUtils.localeFormat(b.getChangedDate(),"F")).appendTo(f);return f};d.prototype._createRevisionDetails=function(e){var c=this._workItem.getHistory().getActions()[e],d=$("<div/>"),i=c.fieldsChanged(),k=c.linksChanged(),h=c.attachmentsChanged(),l,f=(i?1:0)+(k?1:0)+(h?1:0);if(c){c.message&&d.append(this._createDetailsMessageView(e));i&&g.BaseControl.createIn(j.CollapsiblePanel,d,{collapsed:f>1}).appendHeader(a.WorkItemLogControlFieldsHeader).appendContent(b(this,this._createDetailsFieldsView,[e]));k&&g.BaseControl.createIn(j.CollapsiblePanel,d,{collapsed:f>1}).appendHeader(a.WorkItemLogControlLinksHeader).appendContent(b(this,this._createDetailsLinksView,[e]));if(h)l=g.BaseControl.createIn(j.CollapsiblePanel,d,{collapsed:f>1}).appendHeader(a.WorkItemLogControlAttachmentsHeader).appendContent(b(this,this._createDetailsAttachmentsView,[e]))}return d};d.prototype._createDetailsMessageView=function(c){var a=this._workItem.getHistory().getActions()[c],b=$("<div/>").addClass("message");a&&a.message&&T(b.html(this._getNormalizedHtml(a.getRev())));return b};d.prototype._createDetailsFieldsView=function(r){var g,o,d,b,e,m,i,h=this._workItem.getHistory().getActions()[r],n,l;function j(b,e){var a=b.workItem.getFieldValueByRevision(b.fieldDefinition.id,e),d=b.fieldDefinition.type;if(f.Field.isEmpty(a))a="";else if(d===3)a=c.DateUtils.localeFormat(a,"F");else a=""+a;return a}function k(a,b,c){if(c===7)T(a.html(Tb.normalize(b)));else a.text(b)}function p(){var c=$("<tr/>");$("<td/>").text(a.WorkItemLogControlField).appendTo(c);$("<td/>").text(a.WorkItemLogControlNewValue).appendTo(c);b>0&&$("<td/>").text(a.WorkItemLogControlOldValue).appendTo(c);return c}function q(a){var c=$("<tr/>");$("<td/>").text(a.fieldDefinition.name).appendTo(c);k($("<td/>").appendTo(c),j(a,b),a.fieldDefinition.type);b>0&&k($("<td/>").appendTo(c),j(a,b-1),a.fieldDefinition.type);return c}if(h&&h.fieldAction){b=h.fieldAction.index;i=$("<div/>").addClass("container");m=$("<table/>").addClass("detail-list").appendTo(i).append(p());for(g=0,o=this._workItem.fields.length;g<o;g++){d=this._workItem.fields[g];if(Ub(d,b)){e=d.isChangedInRevision(b);if(!e&&typeof e!=="boolean"){n=d.workItem.getFieldValueByRevision(d.fieldDefinition.id,b);l=d.workItem.getFieldValueByRevision(d.fieldDefinition.id,b-1);e=n!==l}e&&m.append(q(d))}}}return i};d.prototype._createDetailsLinksView=function(p){var f,m,g,d,b,c,i,e,l,j,k=this._workItem.getHistory().getActions()[p];function n(){var b=$("<tr/>");$("<td/>").text(a.WorkItemLogControlLinkHeaderType).appendTo(b);$("<td/>").text(a.WorkItemLogControlLinkHeaderDescription).appendTo(b);$("<td/>").text(a.WorkItemLogControlLinkHeaderComment).appendTo(b);$("<td/>").text(a.WorkItemLogControlLinkHeaderChange).appendTo(b);return b}function o(a,d){var b=$("<tr/>"),c;$("<td/>").text(a.type).appendTo(b);c=$("<td/>").appendTo(b);switch(d){case"workitemlink":$("<a href='#' />").text(a.description).click(function(){r.menuManager.executeCommand(new Sys.CommandEventArgs("open-work-item",{id:a.description,tfsContext:h.TfsContext.getDefault()},null));return false}).appendTo(c);break;case"hyperlink":$("<a target='_blank' />").text(a.description).attr("href",a.description).appendTo(c);break;default:c.text(a.description)}$("<td/>").text(a.comment).appendTo(b);$("<td/>").text(a.change).appendTo(b);return b}if(k){j=$("<div/>").addClass("container");l=$("<table/>").addClass("detail-list").appendTo(j).append(n());g=k.getLinkChanges();for(f=0,m=g.length;f<m;f++){d=g[f];c=this._workItem.allLinks[d.index];b={type:c.baseLinkType,description:c.linkData.FilePath,comment:c.linkData.Comment,change:""};switch(d.type){case 4:case 5:e="hyperlink";b.change=d.type===4?a.WorkItemLogControlLinkChangeAdded:a.WorkItemLogControlLinkChangeDeleted;break;case 6:case 7:e="externallink";b.change=d.type===6?a.WorkItemLogControlLinkChangeAdded:a.WorkItemLogControlLinkChangeDeleted;break;case 8:case 9:e="workitemlink";i=this._workItem.store.findLinkTypeEnd(c.linkData.LinkType);b.change=d.type===8?a.WorkItemLogControlLinkChangeAdded:a.WorkItemLogControlLinkChangeDeleted;if(i)b.type=i.name;b.description=c.linkData.ID}o(b,e).appendTo(l)}}return j};d.prototype._createDetailsAttachmentsView=function(m){var d,j,e,g,b,c,i,f,h=this._workItem.getHistory().getActions()[m];function k(){var b=$("<tr/>");$("<td/>").text(a.WorkItemLogControlAttachmentName).appendTo(b);$("<td/>").text(a.WorkItemLogControlAttachmentSize).appendTo(b);$("<td/>").text(a.WorkItemLogControlAttachmentComment).appendTo(b);$("<td/>").text(a.WorkItemLogControlAttachmentChange).appendTo(b);return b}function l(b){var a=$("<tr/>");$("<td/>").addClass("action-attachments-name").text(b.name).appendTo(a);$("<td/>").addClass("action-attachments-size").text(b.size).appendTo(a);$("<td/>").addClass("action-attachments-comment").text(b.comment).appendTo(a);$("<td/>").addClass("action-attachments-change").text(b.change).appendTo(a);return a}if(h){f=$("<div/>").addClass("container");i=$("<table/>").addClass("detail-list").appendTo(f).append(k());e=h.getAttachmentChanges();for(d=0,j=e.length;d<j;d++){g=e[d];b={name:"",size:"",comment:"",change:""};c=this._workItem.allLinks[g.index];if(c){b.change=g.type===2?a.WorkItemLogControlAttachmentChangeAdded:a.WorkItemLogControlAttachmentChangeDeleted;b.name=c.linkData.OriginalName;b.size=c.linkData.Length;b.comment=c.linkData.Comment}l(b).appendTo(i)}}return f};d.prototype._getUploadAttachmentBinaryApiLocation=function(){var b,a="";if(this._workItem){b=this._workItem.getField(-2).getValue();a=h.TfsContext.getDefault().getActionUrl("UploadAttachmentBinary","wit",{area:"api",areaId:b})}return a};return d}(I);d.WorkItemLogControl=O;i.initClassPrototype(O,{_control:null,_tabHost:null,_discussion:null,_details:null,_stateGraph:null,_workItemLinkRegex:null});d.registerWorkItemControl("WorkItemLogControl",O);var H=function(g){__extends(d,g);function d(a){g.call(this,a)}d.prototype.initializeOptions=function(a){g.prototype.initializeOptions.call(this,$.extend({workItem:null},a))};d.prototype.initialize=function(){var a=this.getElement();g.prototype.initialize.call(this);a.addClass("wit-state-transition-graph");this._contentElement=$("<div/>").addClass("state-transition-graph-spacer").appendTo(a);this._offScreenHost=$("<div/>").addClass("state-transition-graph-unused-host").appendTo(a);this._options&&this._options.workItem&&this.bindToWorkItem(this._options.workItem);this._attachEvents()};d.prototype.showAll=function(){this._transitionGraphCollapsed=false;this._decorateGraph();this._contentElement.focus();return false};d.prototype.bindToWorkItem=function(a){this.unbindFromWorkItem();!this._tabsShowHandlersAttached&&this._attachHandlerToTabsShowEvent();if(a){e.assert(a instanceof f.WorkItem,"workItem is expected to be an instance WorkItem object");this._workItem=a;this._transitions=this._generateTransitions(this._workItem);this._transitionElements=this._createTransitionElements(this._transitions);this._decorateGraph()}};d.prototype.unbindFromWorkItem=function(){if(this._workItem){this._workItem=null;this._transitions=null;this._transitionElements=null;this._showMoreElement=null;this._transitionGraphCollapsed=true;this._contentElement.empty();this._offScreenHost.empty();this._contentElement.width(0)}};d.prototype.emptyGraph=function(){var a=this;$.each($(".transition-and-state-container",a._contentElement),function(c,b){$(b).addClass("off-screen");a._offScreenHost.append(b)})};d.prototype._attachEvents=function(){var c,a=this.getElement();a.click(function(){a.focus()});c=this;a.keydown(function(b){var a=c._calcScrollDeltaFromKeyPressed(b);if(a){c._scrollGraph(a);return false}});v.attachResize(this._element,b(this,this._onWindowResize))};d.prototype._calcScrollDeltaFromKeyPressed=function(a){var b=v.KeyCode;return a.altKey||a.ctrlKey||a.shiftKey?void 0:a.keyCode===37?-50:a.keyCode===39?50:a.keyCode===36?-this._contentElement.width():a.keyCode===35?this._contentElement.width():void 0};d.prototype._onWindowResize=function(){this._workItem&&this._decorateGraph()};d.prototype._attachHandlerToTabsShowEvent=function(){var b,a,d=this;function c(b,a){return function(d,c){if(c.newPanel.attr("id")===a){b._decorateGraph();return false}}}b=this.getElement().parents(".ui-tabs-panel");b.each(function(e,b){b=$(b);a=b.attr("id");b.closest(".ui-tabs").bind("tabsactivate",c(d,a))});this._tabsShowHandlersAttached=true};d.prototype._scrollGraph=function(c){var a,b;e.assertParamIsNumber(c,"delta");a=this.getElement();b=a.scrollLeft();a.scrollLeft(b+c)};d.prototype._generateTransitions=function(c){var b,d,a,g,h=[];e.assertParamIsObject(c,"workItem");e.assert(c instanceof f.WorkItem,"workItem is expected to be an instance WorkItem object");g=c.getHistory().getActions();for(b=0,d=g.length;b<d;b++){a=g[b];if(a&&(a.stateChanged()||b===d-1)){b===d-1&&e.assert(a.getRev()===0,"Unexpected history action.  Expected rev 0, found rev "+a.getRev());h.push(this._generateTransition(c,a))}}return h.sort(function(a,b){return a.revision-b.revision})};d.prototype._generateTransition=function(f,a){var d=a.getRev(),b;e.assert(a.stateChanged()||a.getRev()===0,"ActionSet provided does not represent a change in state.");b={revision:d,owner:a.changedByName,date:c.DateUtils.localeFormat(a.getChangedDate(),"d"),reason:f.getFieldValueByRevision(22,d),resultingState:null};if(d===0)b.resultingState=f.getFieldValueByRevision(2,0);else{e.assert(a.stateChanged());b.resultingState=a.stateChanges[1]}return b};d.prototype._createTransitionElements=function(a){var c=this,b=[];e.assertParamIsArray(a,"transitions");$.each(a,function(e,d){var a=c._createGraphTransitionElement(d);c._offScreenHost.append(a);b.push(a)});return b};d.prototype._createGraphTransitionElement=function(a){var d,g,f,b,c,h;e.assertParamIsObject(a,"transition");e.assertParamIsNumber(a.revision,"transition.revision");e.assertParamIsString(a.owner,"transition.owner");e.assertParamIsString(a.date,"transition.date");e.assertParamIsString(a.reason,"transition.reason");e.assertParamIsString(a.resultingState,"transition.resultingState");d=$("<div/>").addClass("transition-and-state-container");g=$("<div/>").addClass("transition-container");b=$("<div/>").addClass("transition-arrow");b.append($("<div/>").addClass("arrow-tail"));b.append($("<div/>").addClass("arrow-head"));b.append($("<div/>").addClass("transition-reason").text(a.reason));f=$("<div/>").addClass("transition-change-info");f.append($("<div/>").text(a.owner));f.append($("<div/>").text(a.date));b.append(f);g.append(b);if(a.onClickTransition){e.assertParamIsFunction(a.onClickTransition,"transition.onClickTransition");g.bind("click",a.onClickTransition)}d.append(g);h=$("<div/>").addClass("state-container");c=$("<div/>").addClass("state");if(a.onClickState){e.assertParamIsFunction(a.onClickState,"transition.onClickState");c.append($("<a/>").text(a.resultingState).attr("href","#").bind("click",a.onClickState));c.bind("click",a.onClickState)}else c.text(a.resultingState);a.stateTooltip&&c.attr("title",a.stateTooltip);h.append(c);d.append(h);d.addClass("off-screen");return d};d.prototype._createShowMoreElement=function(){var c=this._createGraphTransitionElement({revision:-1,owner:"",date:"",reason:"",resultingState:a.StateTransitionGraphViewAllChangesText,onClickState:b(this,this.showAll),stateTooltip:a.StateTransitionGraphViewAllChangesTitle});c.addClass("show-more");return c};d.prototype._decorateGraph=function(){this.emptyGraph();if(this._transitionElements.length===0)this.getElement().hide();else{this.getElement().show();if(!this._transitionGraphCollapsed||this._transitionElements.length<3)this._decorateGraphWith(this._transitionElements);else this._decorateGraphWith(this._transitionsThatFitInContainer())}};d.prototype._decorateGraphWith=function(c){var a,b=0;a=this;$.each(c,function(d,c){b+=a._widthOfTransitionAndState(c);c.removeClass("off-screen");a._contentElement.append(c)});this._contentElement.width(b+5)};d.prototype._transitionsThatFitInContainer=function(){if(!this._showMoreElement){this._showMoreElement=this._createShowMoreElement();this._offScreenHost.append(this._showMoreElement)}return this._fitTransitionsIntoWidth(this.getElement().width(),this._transitionElements,this._showMoreElement)};d.prototype._fitTransitionsIntoWidth=function(c,b,j){var k,f,h,e,a=[],d,g,i;k=this._widthOfTransitionAndState(j);g=b[0];i=b[b.length-1];c-=this._widthOfTransitionAndState(g);a.unshift(i);c-=this._widthOfTransitionAndState(i);h=false;for(d=b.length-2;d>0;d--){f=b[d];a.unshift(f);c-=this._widthOfTransitionAndState(f);if(c<k&&!e)e=a.slice(1);if(c<0){a=e;h=true;break}}h&&a.unshift(j);a.unshift(g);return a};d.prototype._widthOfTransitionAndState=function(b){var a=0;e.assertParamIsJQueryObject(b,"element");b.children().each(function(c,b){a+=$(b).outerWidth(true)});return a};d.prototype._dispose=function(){g.prototype._dispose.call(this);v.detachResize(this._element)};d._typeName="tfs.wit.statetransitiongraph";return d}(g.BaseControl);d.StateTransitionGraphControl=H;i.initClassPrototype(H,{_workItem:null,_transitions:null,_transitionElements:null,_contentElement:null,_offScreenHost:null,_showMoreElement:null,_transitionGraphCollapsed:true,_tabsShowHandlersAttached:false});function V(f,e,d){var c,i,b,a,h=[],g={};d=d||{};for(c=0,i=f.length;c<i;c++){b=f[c];a=$.isFunction(b[e])?b[e]():b;if(a&&!(a in d)&&!(a in g)){g[a]=true;h.push(a)}}return h}function Sb(b){var a=["System.Id","System.Title","System.WorkItemType","System.TeamProject"];return c.ArrayUtils.union(a,b)}var W=function(i){__extends(d,i);function d(b,c,a){i.call(this,b,c,a)}d.prototype._init=function(){var c=[],e,d,f;i.prototype._init.call(this);this._controlId=g.getId();this._registerAsTabChild();this._resetCache();this._filterHelper=new k.LinkFilterHelper(this._options);this._columnHelper=new k.LinkColumnHelper(this._options);this._fieldEvents=[s.DalFields.RelatedLinks,s.DalFields.BISURI,s.DalFields.LinkedFiles];d=false;if(this._options.externalLinkFilters&&this._options.externalLinkFilters.filterType==="include"){f=this._options.externalLinkFilters.filters;$.each(f,function(a){if(f[a].linkType===k.LinkingUtils.RegisteredLinkTypeStoryboard){d=true;return false}})}d&&c.push({id:"start-storyboarding",text:a.StartStoryboarding,title:a.StartStoryboardingToolTip,noIcon:true,action:b(this,this._onStartStoryboarding)});if(this._options.workItemLinkFilters&&this._options.workItemLinkFilters.filterType==="excludeAll")e=false;else e=true;e&&h.TfsContext.getDefault().standardAccessMode===true&&c.push({id:"links-control-link-to-new",showText:false,text:a.LinksControlNewLinkedItem,title:a.LinksControlNewLinkedItemTooltip,icon:"icon-tfs-work-item-new-linked",action:b(this,this._onLinkToNew)});c.push({id:"links-control-link-to-existing",showText:false,text:a.LinksControlLinkToExisting,title:a.LinksControlLinkToExistingTooltip,icon:"icon-tfs-link-add",action:b(this,this._onLinkToExisting)});c.push({separator:true});c.push({id:"open-linked",text:a.LinksControlOpenLinkedItem,title:a.LinksControlOpenLinkedItem,icon:"icon-open",showText:false,action:b(this,this._onOpenLinks)});c.push({id:"delete-linked",text:a.LinksControlDeleteLinkedItem,title:a.LinksControlDeleteLinkedItem,showText:false,icon:"icon-tfs-link-delete",action:b(this,this._onDeleteLinks)});this._menuBar=g.BaseControl.createIn(r.MenuBar,this._container,{items:c});this._columns=this._columnHelper.getDisplayColumns(this._workItemType.store);this._sortColumns=this._columnHelper.getSortColumns();this._grid=g.BaseControl.createIn(ac,this._container,$.extend({linkDetailProvider:b(this,this._fetchOnDemand),linkValueProvider:b(this,this._getLinkValueById),gutter:false,width:"100%",height:"300px"},this._options,{columns:this._columns}));this._container.bind("selectedLinksChanged",b(this,this._onSelectedLinksChanged)).bind("sortChanged",b(this,this._onSortChanged)).bind("openRowDetail",b(this,this._onOpenLinks)).bind("deletekey",b(this,this._onDeleteLinks));this._updateToolbarCommandStates([])};d.prototype.clear=function(){this._grid.updateSource([]);this._updateToolbarCommandStates([])};d.prototype.bind=function(b){var a=this;i.prototype.bind.call(this,b);this._onWorkItemChanged=function(c,b){if(b.change===f.WorkItemChangeType.Saved)a._menuBar.updateCommandStates([{id:"start-storyboarding",disabled:b.workItem.id<=0},{id:"links-control-link-to-new",disabled:b.workItem.id<=0}]);else if(b.change===f.WorkItemChangeType.Refresh||b.change===f.WorkItemChangeType.Reset){a._resetCache();a.invalidate(false)}};b.attachWorkItemChanged(this._onWorkItemChanged)};d.prototype.unbind=function(){if(this._onWorkItemChanged){this._workItem.detachWorkItemChanged(this._onWorkItemChanged);delete this._onWorkItemChanged}i.prototype.unbind.call(this)};d.prototype.invalidate=function(b){var a=this;if(this.isReadOnly())this._container.attr("disabled","disabled");else this._container.removeAttr("disabled");if(this._workItem){this._menuBar.updateCommandStates([{id:"start-storyboarding",disabled:this._workItem.id<=0},{id:"links-control-link-to-new",disabled:this._workItem.id<=0}]);this._ensureLinkTypes(function(){if(a._filterHelper.witFilterExists()||a._columnHelper.sortColumnExists())a._workItem&&a._fetchAllWorkItems(function(){a._workItem&&a._invalidateGridSource()});else a._workItem&&a._invalidateGridSource()},function(a){alert(a)});i.prototype.invalidate.call(this,b)}};d.prototype.countElements=function(){var b=0,d,c,a,e;try{c=this._workItem.getLinks();for(a=0,e=c.length;a<e;a++){d=c[a];if(!this._isLinkSkipped(d))b++}}catch(f){b=null}return b};d.prototype._resetCache=function(){delete this._workItemCache;this._workItemCache={};delete this._artifactCache;this._artifactCache={}};d.prototype._invalidateGridSource=function(){var a;a=this._prepareSource(this._sortOrder);this._grid.updateSource(a.source,a.expandStates,this._sortOrder);this._updateParentCount();e.logTracePoint("LinksControl._invalidateGridSource.complete")};d.prototype._prepareSource=function(g){var d,e,h,a,f,c=[],b=[];f=this._groupLinks(this._workItem.getLinks());for(d=0,h=f.length;d<h;d++){a=f[d];c[c.length]=a.id;b[b.length]=a.links.length;g&&this._sortLinks(a.links,g);for(e=0;e<a.links.length;e++){c[c.length]=a.links[e].id;b[b.length]=0}}return{source:c,expandStates:b}};d.prototype._updateParentCount=function(){q.updateChildCount(this._container,this._controlId,this.countElements())};d.prototype._registerAsTabChild=function(){q.updateChildCount(this._container,this._controlId,null)};d.prototype._isLinkSkipped=function(b){var a=this._filterHelper,d=a.witFilterExists(),c=a.linkTypeFilterExists(this._workItem.store);if(b instanceof f.Attachment)return true;if(d&&b instanceof f.WorkItemLink)if(a.isWitFilteredOut(this._getFieldValue(b,"System.WorkItemType")))return true;if(c)if(a.isLinkFilteredOut(b,this._workItem.store))return true;return false};d.prototype._sortLinks=function(c,a){var b=this;a&&a.length>0&&c.sort(function(h,i){var f,e,g,c,d;for(e=0,g=a.length;e<g;e++){f=a[e].order;c=b._getLinkValue(h,a[e].index,null);if(!c)return f==="asc"?-1:1;d=b._getLinkValue(i,a[e].index,null);if(!d)return f==="asc"?1:-1;if(typeof c==="string")c=c.toLocaleUpperCase();if(typeof d==="string")d=d.toLocaleUpperCase();if(c>d)return f==="asc"?1:-1;else if(c<d)return f==="asc"?-1:1}return-1})};d.prototype._ensureLinkTypes=function(c,b){var a=this;if(this._linkTypeFetchStatus==="notstarted")this._workItem.store.beginGetLinkTypes(function(){a._linkTypeFetchStatus="succeeded";c()},function(c){a._linkTypeFetchStatus="failed";a._fetchError=c.message;b(c.message)});else if(this._linkTypeFetchStatus==="succeeded")c();else if(this._linkTypeFetchStatus==="failed")this._fetchError&&b(this._fetchError)};d.prototype._groupLinks=function(j){var g,l,a,m=0,e,c,b,d=[],i={},h=this._links={};for(g=0,l=j.length;g<l;g++){a=j[g];if(this._isLinkSkipped(a))continue;e=k.LinkingUtils.getLinkTypeRefName(a);b=i[e];if(!b){b={isGroup:true,id:++m,order:this._filterHelper._getGroupOrder(a),name:k.LinkingUtils.getLinkTypeName(a),refName:e,links:[]};i[e]=b;d[d.length]=b;h[b.id]=b}c={id:++m,link:a};if(a instanceof f.WorkItemLink)c.workItemId=a.getTargetId();else if(a instanceof f.ExternalLink)c.artifactUri=a.getLinkedArtifactUri();b.links[b.links.length]=c;h[c.id]=c}d.sort(function(a,b){return a.order-b.order});return d};d.prototype._fetchAllWorkItems=function(g){var a,e,c,b=[],d=this._workItem.getLinks();for(a=0,e=d.length;a<e;a++){c=d[a];if(c instanceof f.WorkItemLink)b[b.length]=c}this._fetch(V(b,"getTargetId",this._workItemCache),[],g)};d.prototype._fetchOnDemand=function(g,i){var d,h,a,c=[],e=[],b=[];function f(b,a){return!(b in a)}for(d=0,h=g.length;d<h;d++){a=this._links[g[d]];if(a)if(a.workItemId&&f(a.workItemId,this._workItemCache)&&c.length<this._grid._options.payloadSize)c[c.length]=a.link;else if(a.artifactUri&&f(a.artifactUri,this._artifactCache))b[b.length]=a.artifactUri}if(c.length)e=V(c,"getTargetId",this._workItemCache);if(b.length)b=V(b,null,this._artifactCache);(e.length||b.length)&&this._fetch(e,b,i)};d.prototype._fetch=function(b,c,j){var o=this,a,g,n=this._workItem.store,q=Sb(this._columnHelper.getWitColumns(n)),e=f.WorkItemManager.PAGE_SIZE,d=0,p=Math.ceil(b.length/e),m;for(a=0,g=b.length;a<g;a++)this._workItemCache[b[a]]={fetching:true};for(a=0,g=c.length;a<g;a++)this._artifactCache[c[a]]={fetching:true};function k(){$.isFunction(j)&&j()}function h(){if(c.length>0){var a=l.TfsTeamProjectCollection.getDefaultConnection().getService(l.ClientLinking);a.beginResolveArtifacts(c,null,function(a){o._buildArtifactCache(a);k()})}else k()}function i(){if(b.length>0){m=b.slice(d*e,d*e+e);n.beginPageWorkItems(m,q,function(a){o._buildWorkItemCache(a);d+=1;if(d<p)i();else h()})}else h()}i()};d.prototype._buildWorkItemCache=function(a){var b,e,c,d=this._workItemCache,f=$.inArray("System.Id",a.columns);for(b=0,e=a.rows.length;b<e;b++){c=a.rows[b];d[c[f]]=c}d.columns=a.columns};d.prototype._buildArtifactCache=function(c){var a,d,b,e=this._artifactCache;for(a=0,d=c.length;a<d;a++){b=c[a];e[b.getUri()]=b}};d.prototype._getLinkValueById=function(c,a,b){return this._getLinkValue(this._links[c],a,b)};d.prototype._getLinkValue=function(b,g,h){var d="",e=this._columns[g].name;if(b)if(b.isGroup){if(h===0)d=c.StringUtils.format(a.LinksControlGroupText,b.name,b.links.length)}else{b=b.link;if(k.LinkColumnHelper.isCommentColumn(e))d=b.getComment();else if(k.LinkColumnHelper.isLinkTypeColumn(e))d=k.LinkingUtils.getLinkTypeName(b);else if(b instanceof f.ExternalLink)d=this._getExternalLinkValue(b,e);else if(b instanceof f.Hyperlink)d=this._getHyperlinkValue(b,e);else if(b instanceof f.WorkItemLink)d=this._getFieldValue(b,e)}return d};d.prototype._getExternalLinkValue=function(e,f){var d="",b;if(k.LinkColumnHelper.isDescriptionColumn(f)){b=this._artifactCache[e.getLinkedArtifactUri()];if(b&&!b.fetching)d=b.getTitle();else d=c.StringUtils.format(a.LinksControlResolvingArtifact,e.getLinkedArtifactUri())}return d};d.prototype._getHyperlinkValue=function(c,b){var a="";if(k.LinkColumnHelper.isDescriptionColumn(b))a=c.getLocation();return a};d.prototype._getFieldValue=function(g,e){var f=g.getTargetId(),d=this._workItemCache[f],b="";if(k.LinkColumnHelper.isIdColumn(e))b=f;else if(k.LinkColumnHelper.isDescriptionColumn(e))if(d&&!d.fetching)b=this._getPageValue(d,"System.Title");else b=c.StringUtils.format(a.LinksControlFetchingWorkItem,f);else b=this._getPageValue(d,e);return b};d.prototype._getPageValue=function(c,d){var a,b="";if(c){a=$.inArray(d,this._workItemCache.columns||[]);if(a>=0)b=c[a]}return b};d.prototype._updateToolbarCommandStates=function(i){var c,k,a,d=true,b=[],e=0,g=0,j=0;for(c=0,k=i.length;c<k;c++){a=this._links[i[c]];if(a&&!a.isGroup&&a.link){e+=1;g+=a.link.getIsLocked()?0:1;j+=a.link instanceof f.Hyperlink?0:1;if(e>1&&g>0)break}}b.push({id:"open-linked",disabled:e!==1});b.push({id:"delete-linked",disabled:g<1||j>0&&h.TfsContext.getDefault().standardAccessMode===false});if(this._workItem){d=this._workItem.isNew();if(this._options.workItemLinkFilters&&this._options.workItemLinkFilters.filterType==="excludeAll")d=true}b.push({id:"links-control-link-to-new",disabled:d});this._menuBar.updateCommandStates(b)};d.prototype._onLinkToNew=function(){var a={tfsContext:h.TfsContext.getDefault(),workItemLinkFilters:this._options.workItemLinkFilters,externalLinkFilters:this._options.externalLinkFilters,workItemTypeFilters:this._options.workItemTypeFilters};p.newLinkedWorkItem(this._workItem,[this._workItem.id],a)};d.prototype._onStartStoryboarding=function(){l.AlmUriBuilder.beginBuildCreateStoryboardUri([this._workItem.id],function(a){l.AlmUriManager.launchUri(a)},Wb)};d.prototype._onLinkToExisting=function(){var a={tfsContext:h.TfsContext.getDefault(),workItemLinkFilters:this._options.workItemLinkFilters,externalLinkFilters:this._options.externalLinkFilters,workItemTypeFilters:this._options.workItemTypeFilters};p.linkToExistingWorkItem(this._workItem,[this._workItem.id],a)};d.prototype._onOpenLinks=function(){var c,d,a,b=this._grid.getSelectedLinkIds();a=b.length>0?this._links[b[0]]:null;if(b.length===1&&a&&a.isGroup)this._grid.toggleSelectedNode();else for(c=0,d=b.length;c<d;c++){a=this._links[b[c]];a&&!a.isGroup&&a.link&&this._executeLink(a.link)}};d.prototype._executeLink=function(b){var d,c;if(b instanceof f.Hyperlink){c=b.getLocation();if(h.urlHelper.isSafeProtocol(c))h.ActionManager.performAction(h.CommonActions.ACTION_WINDOW_OPEN,{url:c,target:"_blank"});else alert(a.LinksUnsafeProtocolNotOpened)}else if(b instanceof f.WorkItemLink)r.menuManager.executeCommand(new Sys.CommandEventArgs("open-work-item",{id:b.getTargetId(),tfsContext:h.TfsContext.getDefault()},null));else if(b instanceof f.ExternalLink){d=this._artifactCache[b.getLinkedArtifactUri()];d.execute(h.TfsContext.getDefault())}else alert(a.LinksControlUnknownLinkTypeText)};d.prototype._onEditLinks=function(){};d.prototype._onDeleteLinks=function(){var c,f,b,g=this._links,e=this._grid.getSelectedLinkIds(),d=[];for(c=0,f=e.length;c<f;c++){b=g[e[c]];b&&!b.isGroup&&b.link&&!b.link.getIsLocked()&&d.push(b.link)}d.length&&confirm(a.LinksControlConfirmDelete)&&this._workItem.removeLinks(d)};d.prototype._onSelectedLinksChanged=function(b,a){this._updateToolbarCommandStates(a.links)};d.prototype._onSortChanged=function(c,b){var a=b.sortOrder;if(a){this._sortOrder=a;this.invalidate(false)}};return d}(m);d.LinksControl=W;i.initClassPrototype(W,{_grid:null,_menuBar:null,_links:null,_workItemCache:null,_artifactCache:null,_linkTypeFetchStatus:"notstarted",_filterHelper:null,_columnHelper:null,_columns:null,_sortColumns:null,_controlId:null,_onWorkItemChanged:null,_fetchError:null,_sortOrder:null});d.registerWorkItemControl("LinksControl",W);var ac=function(b){__extends(a,b);function a(a){b.call(this,a)}a.prototype.initializeOptions=function(a){b.prototype.initializeOptions.call(this,$.extend({pageSize:f.WorkItemManager.PAGE_SIZE},a))};a.prototype.updateSource=function(d,b,c){var a=this._options;a.source=d;a.expandStates=b;a.columns=this._columns;a.sortOrder=c;this.initializeDataSource()};a.prototype.getSelectedLinkIds=function(){var b=[],a;for(a in this._selectedRows)this._selectedRows.hasOwnProperty(a)&&b.push(this._dataSource[this._selectedRows[a]]);return b};a.prototype.toggleSelectedNode=function(){var a=this._getDataIndex(this._selectedIndex),b=this._getExpandState(a);this.tryToggle(b<0,false)};a.prototype.selectedIndexChanged=function(c,a){b.prototype.selectedIndexChanged.call(this,c,a);this._fire("selectedLinksChanged",[{links:this.getSelectedLinkIds()}])};a.prototype.selectionChanged=function(c,a,d){b.prototype.selectionChanged.call(this,c,a,d);this._fire("selectedLinksChanged",[{links:this.getSelectedLinkIds()}])};a.prototype.cacheRows=function(f,e,g){var a,c,i=f.length,d=g.length,b=[],j=this._dataSource,h=[],k=this;c=Math.max(i,d);for(a=0;a<c;a++){if(a<i)b[b.length]=f[a][1];if(a<d)b[b.length]=g[d-a-1][1]}c=e.length;for(a=0;a<c;a++)b[b.length]=e[a][1];c=b.length;for(a=0;a<c;a++)h.push(j[b[a]]);this._options.linkDetailProvider(h,function(){k.redraw()})};a.prototype.getColumnValue=function(c,a,b){var d=this._dataSource[c];return this._options.linkValueProvider(d,a,b)};a.prototype.onSort=function(b,a){this._fire("sortChanged",[{sortOrder:b,sortColumns:a}])};a.prototype._drawCell=function(h,g,e,c,i,f,a){var d;if(c<2){if(a===0){d=b.prototype._drawCell.call(this,h,g,e,c,i,f,a);d.css("width","100%");return d}}else return b.prototype._drawCell.call(this,h,g,e,c,i,f,a)};a._typeName="tfs.wit.linksgrid";return a}(Db.Grid),mb=function(d){__extends(b,d);function b(a){d.call(this,a)}b.prototype.initialize=function(){this._options.source=[];this._options.columns=[{text:a.AttachmentsGridNameColumn,width:300},{text:a.AttachmentsGridSizeColumn,width:80},{text:a.AttachmentsGridDateAttachedColumn,width:120},{text:a.AttachmentsGridCommentsColumn,width:300}];d.prototype.initialize.call(this)};b.prototype.getColumnValue=function(e,d){var a=this._dataSource[e],b;switch(d){case 0:return a.getName();case 1:b=+a.getLength();return c.StringUtils.format("{0}K",Math.ceil(b/1024));case 2:if(!a.isNew())return c.DateUtils.localeFormat(a.getAddedDate(),"F");else return"";break;case 3:return a.getComment()||"";default:return""}};b.prototype.selectedIndexChanged=function(c,a){var b;d.prototype.selectedIndexChanged.call(this,c,a);b=this._dataSource[a];this._fire("selectedAttachmentChanged",[b])};b.prototype.updateSource=function(d,b,c){var a=this._options;a.source=d;a.expandStates=b;a.columns=this._columns;a.sortOrder=c;this.initializeDataSource()};b.prototype.invalidate=function(i){var e,b,h,g,a=[],d;e=i.getLinks();for(b=0,h=e.length;b<h;b++){g=e[b];if(g instanceof f.Attachment)a[a.length]=g}if(this._sortOrder){d=this._sortOrder;a.sort(function(e,f){var g,i,h,b,a=0;for(g=0,i=d.length;g<i;g++){h=d[g];b=h.order==="asc"?1:-1;switch(h.index){case 0:a=b*c.StringUtils.localeIgnoreCaseComparer(e.getName(),f.getName());break;case 1:a=b*(e.getLength()-f.getLength());break;case 2:a=b*c.DateUtils.compare(e.getAddedDate(),f.getAddedDate());break;case 3:a=b*c.StringUtils.localeIgnoreCaseComparer(e.getComment(),f.getComment())}if(a!==0)return a}return 0})}this.updateSource(a,null,this._sortOrder)};b.prototype.clear=function(){this.updateSource([],null,null)};b.prototype.getSelectedAttachments=function(){var b=[],a;for(a in this._selectedRows)this._selectedRows.hasOwnProperty(a)&&b.push(this._dataSource[this._selectedRows[a]]);return b};b.prototype.onSort=function(b,a){this._fire("sortChanged",[{sortOrder:b,sortColumns:a}])};b.prototype.sort=function(b,a){if(a&&a.length){this._sortOrder=a;this.invalidate(b)}};return b}(Db.Grid);d.AttachmentsGrid=mb;var B=function(e){__extends(d,e);function d(b,c,a){e.call(this,b,c,a)}d.addAttachment=function(n,b){var o,l,r,h,d,u,m,k,z,v,e,w,q,p,s,t,y;if(!n&&!(b&&b.uploadOnly&&$.isFunction(b.formActionDelegate)))return false;d="FileUpload"+g.getId();m="tgt"+d;k="cb"+m;y=b&&b.title?b.title:a.AddAttachmentDialogTitle;v=b&&b.attachmentLabel?b.attachmentLabel:a.AddAttachmentDialogFieldAttachment;e={callback:function(c){var g,e,h;c=c||{};if(s){s.remove();s=null}if(p){i.globalProgressIndicator.actionCompleted(p);p=null}window[k]=undefined;try{delete window[k]}catch(j){}if(!t&&c.success){e=c.attachments[0];if(b&&!b.uploadOnly||!b){h=f.Attachment.create(n,e.Name,e.Id,u?u.val():"",e.Size);n.addLink(h)}r.close();b&&$.isFunction(b.successCallback)&&b.successCallback(false,e)}else{jQuery("#"+d+"_OK").button("option","disabled",false);if(t||c.canceled)t=true;else{if(c.clientError)g=c.clientError;else if(c.error)g=Error.serverError(c.error);else g=Error.create(a.AddAttachmentUnknownError);alert(x(g))}}}};r=j.Dialog.show(j.ModalDialog,{title:y,cssClass:"attachment-dialog",open:function(){h=$("<div />").addClass("attachment-dialog");$("<label />").text(v).attr("for",d).addClass("label").appendTo(h);o=$("<form />").attr("method","POST").attr("enctype","multipart/form-data").attr("encoding","multipart/form-data").appendTo(h);l=$("<input />").attr("type","file").attr("id",d).attr("name","attachment").attr("contentEditable",false).addClass("file textbox").appendTo(o).keydown(function(a){if(a.keyCode===13&&$.browser.msie)return false});c.setAntiForgeryToken(o);b&&b.fileType&&l.attr("accept",b.fileType);w=b&&b.showComments||!b;if(w){$("<label />").text(a.AddAttachmentDialogFieldComment).attr("for","comment"+d).addClass("label").appendTo(h);u=$("<input />").attr("type","text").attr("id","comment"+d).addClass("comment textbox").appendTo(h)}$(this).append(h);l.focus()},close:function(){e.callback({success:false,canceled:true})},defaultButton:"OK",buttons:{OK:{text:a.OK,id:d+"_OK",click:function(){var f,h=l.val();if(h){if(b&&b.validator&&$.isFunction(b.validator.validate)){q=b.validator.validate($(l).val(),b);!q&&e.callback({success:false,clientError:{message:b.validator.errorString}})}else q=true;if(q){s=$("<iframe />",{name:m,id:m}).hide().bind("error",function(a){alert(a)}).appendTo(document.body);e.isCallback=true;window[k]=e;if(b&&$.isFunction(b.formActionDelegate))f=b.formActionDelegate(k);else f=n.project.getApiLocation("UploadAttachment",{callback:k,areaId:n.getField(-2).getValue()});o.attr("target",m).attr("action",f);c.delay(this,0,function(){try{p=i.globalProgressIndicator.actionStarted("add-attachment-attempt"+g.getId());jQuery("#"+d+"_OK").button("option","disabled",true);o.submit();r.setTitle(z)}catch(a){e.callback({success:false,clientError:a})}})}}else e.callback({success:false,clientError:{message:c.StringUtils.format(a.AddAttachmentFileNotFoundError,h)}})}},Cancel:{text:a.Cancel,click:function(){e.callback({success:false,canceled:true});r.close()}}},width:b&&b.width?b.width:"30em",height:"auto",dynamicSize:false,resizable:false})};d.prototype._init=function(){this._fieldName=this._fieldName||s.DalFields.AttachedFiles.toString();e.prototype._init.call(this);this._menuBar=g.BaseControl.createIn(r.MenuBar,this._container,{items:[{id:"open-attachments",text:a.OpenAttachment,title:a.OpenAttachment,showText:false,icon:"icon-open",action:b(this,this._openAttachments)},{id:"add-attachment",text:a.AddAttachmentButtonText,title:a.AddAttachmentButtonTitle,icon:"icon-add",showText:false,action:b(this,this._addAttachment)},{id:"save-attachments",text:a.SaveAttachmentButtonText,title:a.SaveAttachmentButtonTitle,icon:"icon-save",showText:false,hasAction:true,action:b(this,this._saveAttachments)},{id:"delete-attachments",text:a.DeleteAttachment,title:a.DeleteAttachment,showText:false,icon:"icon-delete",action:b(this,this._deleteAttachments)}]});this._registerAsTabChild();this._grid=g.BaseControl.createIn(mb,this._container,{gutter:false,width:"100%",height:"300px"});$(this._container).bind("selectedAttachmentChanged",b(this,this._onSelectedAttachmentChanged));$(this._container).bind("openRowDetail",b(this,this._openAttachments));$(this._container).bind("deletekey",b(this,this._deleteAttachments));$(this._container).bind("sortChanged",b(this,this._sortAttachments))};d.prototype.invalidate=function(a){if(this.isReadOnly())this._container.attr("disabled","disabled");else this._container.removeAttr("disabled");this._menuBar.updateCommandStates([{id:"open-attachments",disabled:true},{id:"save-attachments",disabled:true},{id:"delete-attachments",disabled:true}]);this._grid.invalidate(this._workItem);this._updateParentCount();e.prototype.invalidate.call(this,a)};d.prototype.clear=function(){this._grid.clear()};d.prototype.countElements=function(){try{return this._grid._options.source.length}catch(a){return null}};d.prototype._addAttachment=function(){this._workItem&&d.addAttachment(this._workItem)};d.prototype._deleteAttachments=function(){var b=this._grid.getSelectedAttachments();if(b&&b.length>0)confirm(a.RemoveAttachmentsConfirm)&&$.each(b,function(){this.remove()})};d.prototype._openAttachments=function(){var a=this._grid.getSelectedAttachments(),c,b;a&&a.length>0&&$.each(a,function(){c=this.getName().toLowerCase();b=c.match("[^\\.]*?$");if(b.length>0&&b[0].search("htm")===0)this.save();else this.open()})};d.prototype._saveAttachments=function(){var a=this._grid.getSelectedAttachments();a&&a.length>0&&$.each(a,function(){this.save()})};d.prototype._sortAttachments=function(b,a){this._grid.sort(this._workItem,a.sortOrder)};d.prototype._onSelectedAttachmentChanged=function(c,b){var a=!(b&&b.uploaded);this._menuBar.updateCommandStates([{id:"open-attachments",disabled:a},{id:"save-attachments",disabled:a},{id:"delete-attachments",disabled:a}])};d.prototype._updateParentCount=function(){q.updateChildCount(this._container,this._options.controlId,this.countElements())};d.prototype._registerAsTabChild=function(){q.updateChildCount(this._container,this._options.controlId,null)};return d}(m);d.AttachmentsControl=B;i.initClassPrototype(B,{_attachFileContainer:null,_menuBar:null,_grid:null});d.registerWorkItemControl("AttachmentsControl",B);var Y=function(){function a(a){this._options=a}a.prototype.getUrl=function(d,c){var b,a;this._notConfigured=null;b=this._getRootUrl(c);a=this._getUrlPath(d);if(this._notConfigured){b=h.TfsContext.getDefault().getActionUrl("notConfigured","workItems");a="?type="+this._notConfigured}return this._ensureUrlEndsWithSlash(b)+a};a.prototype._getRootUrl=function(c){var e=this,d=this._options.link,b=null;$.each(a.macros,function(){if(d.urlRoot==="@"+this){if(c[this])b=c[this];else e._notConfigured=this;return false}});if(!b)b=d.urlRoot;return b};a.prototype._getUrlPath=function(e){var f=this,b,a,d=this._options.link;b=d.urlPath||"";if($.isArray(d.params)){a=[b];$.each(d.params,function(d,c){var b;if(c){b=e.getField(c.value);if(b)a[a.length]=b.getValue(c.original);else a[a.length]=""}});try{b=c.StringUtils.format.apply(String,a)}catch(g){f._notConfigured="InvalidParameterFormat"}}return b};a.prototype._ensureUrlEndsWithSlash=function(a){if(a&&a.length&&a.charAt(a.length-1)!=="/")a+="/";return a};a.macros=["PortalPage","ProcessGuidance","ReportManagerUrl","ReportServiceSiteUrl"];return a}();i.initClassPrototype(Y,{_options:null,_notConfigured:null});var ub=function(d){__extends(a,d);function a(b,c,a){d.call(this,b,c,a)}a.prototype._init=function(){var b,e,c,a=this._options.link;d.prototype._init.call(this);this._linkSetting=new Y(this._options);this._iframeHost=$("<div class='webpagecontrol'>").appendTo(this._container);this._options.height&&this._iframeHost.height(this._options.height);if(a&&$.isArray(a.params)&&a.params.length){this._params={};for(b=0,e=a.params.length;b<e;b++){c=a.params[b];this._params[c.value]=c}}};a.prototype.bind=function(b){var e=this,a=this._params,c=this._options.reloadOnParamChange;if(a){this._workItemChangedDelegate=function(g,d){var b=false;if(d.change===f.WorkItemChangeType.Saved)b=true;else c&&d.change===f.WorkItemChangeType.FieldChange&&$.each(d.changedFields,function(e,c){if(c){var d=a[c.fieldDefinition.name]||a[c.fieldDefinition.referenceName];if(d&&!d.original){b=true;return false}}});b&&e.invalidate(false)};b.attachWorkItemChanged(this._workItemChangedDelegate)}d.prototype.bind.call(this,b)};a.prototype.unbind=function(){var a=this._workItem;if(this._workItemChangedDelegate){a.detachWorkItemChanged(this._workItemChangedDelegate);delete this._workItemChangedDelegate}d.prototype.unbind.call(this)};a.prototype.invalidate=function(a){d.prototype.invalidate.call(this,a);if(!this._pageHost)this._pageHost=$("<iframe frameborder='0'/>").appendTo(this._iframeHost);if(this._workItem)if(this._options.link)this._pageHost.attr("src",this._linkSetting.getUrl(this._workItem,this._workItem.project.extras.resourceLocations));else this._options.content&&$(this._pageHost[0].contentWindow.document).ready(b(this,this.onDocumentReady))};a.prototype.onDocumentReady=function(){this.setBodyContent()};a.prototype.setBodyContent=function(){var a=this._pageHost[0].contentWindow.document;if(a.body)a.body.innerHTML=this._options.content;else c.delay(this,100,this.setBodyContent)};a.prototype.clear=function(){if(this._pageHost){this._pageHost.remove();delete this._pageHost}};return a}(m);i.initClassPrototype(ub,{_iframeHost:null,_pageHost:null,_linkSetting:null,_params:null,_workItemChangedDelegate:null});d.registerWorkItemControl("WebpageControl",ub);var yb=function(b){__extends(a,b);function a(c,d,a){b.call(this,c,d,a)}return a}(m);d.LabelControl=yb;d.registerWorkItemControl("LabelControl",yb);var qb=function(e){__extends(d,e);function d(c,f,d){var i=this;e.call(this,c,f,d);this._$container=$(c);this._tagControl=g.BaseControl.createIn(Xb.TagControl,c,{tagLabel:a.TagsLabelText,readOnly:false,selectable:true,useDeleteExperience:true,beginGetSuggestedValues:function(c){var b=l.TfsTeamProjectCollection.getConnection(h.TfsContext.getDefault()).getService(l.TagService),a=i._workItem.project.guid;b.beginQueryTagDefinitions([l.TagService.WORK_ITEM_ARTIFACT_KIND],a,c,function(){})}});this._onChangedDelegate=b(this,this._onChanged);this._onKeydownDelegate=b(this,this._onKeydown);this._onWorkItemChangedDelegate=b(this,this._onWorkItemChanged);this._onWorkItemTagsChangedDelegate=b(this,this._onWorkItemTagsChanged)}d.prototype.bind=function(a){this._workItem&&this.unbind();this._workItem=a;this._tagControl.setItems(a.getTagNames());this._tagControl._bind("change",this._onChangedDelegate);this._$container.bind("keydown",this._onKeydownDelegate);this._workItem.store.workItemManager.attachWorkItemChanged(this._onWorkItemChangedDelegate);this._workItem.attachFieldChange(s.DalFields.Tags,this._onWorkItemTagsChangedDelegate)};d.prototype.unbind=function(){this._tagControl.clearItems();this._tagControl._unbind("change",this._onChangedDelegate);this._$container.unbind("keydown",this._onKeydownDelegate);if(this._workItem){this._workItem.store.workItemManager.detachWorkItemChanged(this._onWorkItemChangedDelegate);this._workItem.detachFieldChange(s.DalFields.Tags,this._onWorkItemTagsChangedDelegate);this._workItem=null}};d.prototype._findTagIndex=function(d,b){for(var a=0,e=b.length;a<e;a++)if(c.StringUtils.ignoreCaseComparer(b[a],d)===0)return a;return-1};d.prototype._onChanged=function(e,c){var a=this._workItem.getTagNames(),d=c.name,b=this._findTagIndex(d,a);if(c.type===0)b<0&&a.push(d);else if(c.type===1)b>=0&&a.splice(b,1);this._ignoreTagChangeEvent=true;this._workItem.setFieldValue(80,a.join("; "));this._ignoreTagChangeEvent=false};d.prototype._onKeydown=function(a){v.KeyUtils.isExclusivelyCtrl(a)&&String.fromCharCode(a.keyCode).toLowerCase()==="s"&&this._tagControl.flush()};d.prototype._onWorkItemChanged=function(b,a){if(!this._workItem||!a.workItem||this._workItem.id!==a.workItem.id)return;a.change===f.WorkItemChangeType.PreSave&&this._tagControl.flush();a.change===f.WorkItemChangeType.Saved&&this._tagControl.resetSuggestedValues()};d.prototype._onWorkItemTagsChanged=function(b){var a;if(this._workItem===b&&!this._ignoreTagChangeEvent){this._tagControl.setItems(b.getTagNames());a=l.TfsTeamProjectCollection.getConnection(h.TfsContext.getDefault()).getService(l.TagService);a.invalidateCacheForArtifactKinds([l.TagService.WORK_ITEM_ARTIFACT_KIND],this._workItem.project.guid)}};d._typeName="tfs.wit.tagFieldControl";return d}(m);d.TagFieldControl=qb;var Ob=function(b){__extends(a,b);function a(a){b.call(this,a);this._label=this._options.label;this._content=this._options.content;this._extensionLayout=this._options.extensionLayout;this.detachLayout()}a.prototype.getLayout=function(){if(!this._layout)this._layout=this._extensionLayout.content.clone(true);return this._layout};a.prototype.detachLayout=function(){this._label&&this._label.hide();this._content&&this._content.hide();b.prototype.detachLayout.call(this)};a.prototype.beginAttachLayout=function(){this._label&&this._label.show();this._content&&this._content.show();b.prototype.beginAttachLayout.call(this)};a.prototype.getPriority=function(){return this._extensionLayout.priority};a.prototype.getContent=function(){return this._content};a.prototype.getLabel=function(){return this._label};return a}(X),vb=function(b){__extends(a,b);function a(e,f,c,a,d){b.call(this,e,f,c,a);this._workItemView=d;this._refName=this._options.refName;this._outputLayout=this._options.outputLayout||"vertical";this._limit=this._options.limit||40;this._container.addClass("extensionzone");this._extensionViews={};this._currentExtensions=[];this._currentViews=[];this._createViewLocations()}a.prototype._createViewLocations=function(){if(this._outputLayout=="tabular"){var b=$("<div/>").addClass("tab-group"),d=$("<div/>").attr("colSpan",2),f=$("<ul/>").addClass("headers"),c=$("<div/>").addClass("tabs");b.addClass("tabular");c.append(f);d.append(c);b.append(d);$(this._container).append(b);this._contentLocation=c;this._labelLocation=f}else if(this._outputLayout=="vertical"){var a=$("<table/>").addClass("content");a.css("width","100%");this._contentLocation=a;a.addClass("vertical");$(this._container).append(a)}else if(this._outputLayout=="horizontal"){var e=$("<tr/>").addClass("content"),a=$("<table/>").append(e);a.css("width","100%");this._contentLocation=e;a.addClass("horizontal");$(this._container).append(a)}};a.prototype.currentExtensions=function(){return this._workItem.extensions||[]};a.prototype.bind=function(a){b.prototype.bind.call(this,a);if(db(a.extensions)!==db(this._currentExtensions)){this._preBindOperations();this._attachViews(a.extensions);this._orderViews();this._postBindOperations()}for(var c=0;c<this._currentViews.length;c++)this._currentViews[c].bind(a)};a.prototype.unbind=function(){b.prototype.unbind.call(this);for(var a=0;a<this._currentViews.length;a++)this._currentViews[a].unbind()};a.prototype._attachViews=function(c){this._detachExtensions();for(var a=[],b=0;b<c.length;b++)a=a.concat(this._getExtensionViews(c[b]));a.sort(function(a,b){return a.getPriority()-b.getPriority()});for(var b=0;b<Math.min(this._limit,a.length);b++)a[b].beginAttachLayout();this._currentViews=a;this._currentExtensions=c};a.prototype._orderViews=function(){if(this._contentLocation)for(var a=0;a<this._currentViews.length;a++)this._currentViews[a].getContent().appendTo(this._contentLocation);if(this._labelLocation)for(var a=0;a<this._currentViews.length;a++)this._currentViews[a].getLabel().appendTo(this._labelLocation)};a.prototype._detachExtensions=function(){for(var a=0;a<this._currentViews.length;a++)this._currentViews[a].detachLayout();this._currentViews=[]};a.prototype._getExtensionViews=function(c){var d=C(c),a=this,b=this._extensionViews[d];if(!b){b=$.map(this._workItemView.form.getWorkItemTypeExtensionLayout(c,this._refName),function(d){var b=a._createExtensionLocation(d.label),e=b.content,f=b.label,h=g.BaseControl.createIn(Ob,a._getViewParent(e),{workItemType:a._workItemType,extension:c,form:a._workItemView.form,readOnly:a._options.readOnly,extensionLayout:d,content:e,label:f});return h});this._extensionViews[d]=b}return b};a.prototype._getViewParent=function(a){return this._outputLayout=="vertical"?a.find(".content"):this._outputLayout=="tabular"?a:this._outputLayout=="horizontal"?a:void 0};a.prototype._createExtensionLocation=function(b){if(this._outputLayout=="tabular"){var c=$("<div/>").addClass("tab-page").addClass("workitemcountingtab"),l="witc_tab_"+g.getId(),b=b||"",f;c.attr("id",l).attr("rawTitle",b);f=$("<li/>").append($("<a/>").addClass("header").text(b).attr("href","#"+l).attr("rawTitle",b));c.appendTo(this._contentLocation);f.appendTo(this._labelLocation);var d=c,j,h;h=d.data("wit-options")||{};j=new q(d,h);d.data("wit-tab",j);return{label:f,content:c}}else if(this._outputLayout=="vertical"){var a,k=$("<tr/>").addClass("group").appendTo(this._contentLocation),i=$("<td/>").attr("colSpan",2).appendTo(k);if(b){a=$("<fieldset/>").css("width","100%");a.append($("<legend/>").text(b));i.append(a)}else a=i;a.addClass("content");return{label:null,content:k}}else if(this._outputLayout=="horizontal"){var a,e=$("<td/>").attr("colSpan",2).appendTo(this._contentLocation);if(b){a=$("<fieldset/>").css("width","100%");a.append($("<legend/>").text(b));e.append(a)}else a=e;return{label:null,content:e}}};a.prototype._preBindOperations=function(){this._outputLayout=="tabular"&&this._contentLocation.removeData("ui-tabs")};a.prototype._postBindOperations=function(){this._outputLayout=="tabular"&&this._contentLocation.tabs()};return a}(m);d.ExtensionZone=vb;d.registerWorkItemControl("ExtensionZone",vb);var jb=function(b){__extends(a,b);function a(a){b.call(this,a)}a.prototype._updateFieldValues=function(a,c,b){e.assertParamIsObject(a,"valueControl");e.assertParamIsNumber(c,"fieldType");e.assertParamIsArray(b,"values");if(c===8){a.setType("tree");a.setMode("drop");a.setSource(function(){function a(c,b){var d,h,f=c.children,e;if(b){e=g.TreeNode.create(c.name);b.add(e);b=e}else b=g.TreeNode.create(c.name);if(f)for(d=0,h=f.length;d<h;d++){c=f[d];a(c,b)}return b}return $.map(b,function(b){return a(b,null)})})}else if(b&&b.length>0){a.setType("list");a.setMode("drop");a.setSource(b)}else{a.setType("list");a.setMode("text");a.setSource([])}};a._typeName="tfs.wit.fieldsFilterBase";return a}(j.FilterControl);d.FieldsFilterBase=jb;i.classExtend(jb,h.TfsContext.ControlExtensions);u.registerActionWorker(t.ACTION_WORKITEM_OPEN,function(a){var b;e.assertParamIsObject(a,"actionArgs");e.assertParamIsNotNull(a.id,"actionArgs.id");b=a.tfsContext||h.TfsContext.getDefault();o.showWorkItemById(a.id,b,a.options)});u.registerActionWorker(t.ACTION_WORKITEM_NEW,function(a){var d,b,c;e.assertParamIsObject(a,"actionArgs");e.assertParamIsNotNull(a.workItemTypeName,"actionArgs.workItemTypeName");d=a.tfsContext||h.TfsContext.getDefault();if(!a.project){c=a.projectName||d.navigation.project;e.assertParamIsNotNull(c,"actionArgs.projectName")}b=l.TfsTeamProjectCollection.getConnection(d).getService(f.WorkItemStore);b.beginGetProjects(function(){var d=a.project||b.getProject(c);d.beginGetWorkItemType(a.workItemTypeName,function(d){var a=b.workItemManager.createWorkItem(d),c=function(){o.showWorkItem(a,{saveButton:true})};f.WorkItemTeamUtil.beginTrySetWorkItemTeamDefaults(a,function(){a.resetManualFieldChanges();c()},function(){c()})})})});u.registerActionWorker(t.ACTION_WORKITEM_DISCARD_IF_NEW,function(c){e.assertParamIsObject(c,"actionArgs");e.assertParamIsNotNull(c.workItem,"actionArgs.workItem");var b=c.workItem;if(b&&b.isNew()){if(b.isDirty(true))if(!confirm(a.ConfirmWorkItemDiscardNew))return false;b.discardIfNew()}return true});r.menuManager.attachExecuteCommand(function(d,c){var a,b;a=c.get_commandArgument();if(!a)return;b=a.tfsContext||h.TfsContext.getDefault();switch(c.get_commandName()){case"open-work-item":u.performAction(t.ACTION_WORKITEM_OPEN,a);return false;case"new-work-item":u.performAction(t.ACTION_WORKITEM_NEW,a);return false;case"link-to-new":p.newLinkedWorkItem(a.baseId,a.selectedIds,{tfsContext:b});return false;case"link-to-existing":p.linkToExistingWorkItem(a.baseId,a.selectedIds,{tfsContext:b});return false;case"create-copy":p.createCopyOfWorkItem(a.workItemId,{tfsContext:b});return false;case"use-as-a-template":p.useWorkItemAsATemplate(a.workItemId,{tfsContext:b});return false}});d.registerWorkItemControl("TestStepsControl","TestStepsControl","TestManagement/Scripts/TFS.TestManagement.Controls");d.registerWorkItemControl("AssociatedAutomationControl","AssociatedAutomationControl","TestManagement/Scripts/TFS.TestManagement.Controls");d.registerWorkItemControl("StageControl","StageControl","ReleasePipeline/Scripts/TFS.ReleasePipeline.Controls");d.registerWorkItemControl("StageBuildControl","StageBuildControl","ReleasePipeline/Scripts/TFS.ReleasePipeline.Controls");d.registerWorkItemControl("ReleaseBuildControl","ReleaseBuildControl","ReleasePipeline/Scripts/TFS.ReleasePipeline.Controls");d.registerWorkItemControl("AcceptanceCriteriaControl","AcceptanceCriteriaControl","ReleasePipeline/Scripts/TFS.ReleasePipeline.Controls");g.Enhancement.registerEnhancement(o,".work-item-form");i.tfsModuleLoaded("TFS.WorkItemTracking.Controls",d)});
// SIG // Begin signature block
// SIG // MIIaxQYJKoZIhvcNAQcCoIIatjCCGrICAQExCzAJBgUr
// SIG // DgMCGgUAMGcGCisGAQQBgjcCAQSgWTBXMDIGCisGAQQB
// SIG // gjcCAR4wJAIBAQQQEODJBs441BGiowAQS9NQkAIBAAIB
// SIG // AAIBAAIBAAIBADAhMAkGBSsOAwIaBQAEFG2mmzMsg9NK
// SIG // fo8YsJwYCE3P9apvoIIVejCCBLswggOjoAMCAQICEzMA
// SIG // AABZ1nPNUY7wIsUAAAAAAFkwDQYJKoZIhvcNAQEFBQAw
// SIG // dzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCldhc2hpbmd0
// SIG // b24xEDAOBgNVBAcTB1JlZG1vbmQxHjAcBgNVBAoTFU1p
// SIG // Y3Jvc29mdCBDb3Jwb3JhdGlvbjEhMB8GA1UEAxMYTWlj
// SIG // cm9zb2Z0IFRpbWUtU3RhbXAgUENBMB4XDTE0MDUyMzE3
// SIG // MTMxNVoXDTE1MDgyMzE3MTMxNVowgasxCzAJBgNVBAYT
// SIG // AlVTMQswCQYDVQQIEwJXQTEQMA4GA1UEBxMHUmVkbW9u
// SIG // ZDEeMBwGA1UEChMVTWljcm9zb2Z0IENvcnBvcmF0aW9u
// SIG // MQ0wCwYDVQQLEwRNT1BSMScwJQYDVQQLEx5uQ2lwaGVy
// SIG // IERTRSBFU046RjUyOC0zNzc3LThBNzYxJTAjBgNVBAMT
// SIG // HE1pY3Jvc29mdCBUaW1lLVN0YW1wIFNlcnZpY2UwggEi
// SIG // MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDGbE7P
// SIG // aFP974De6IvEsfB+B84ePOwMjDWHTOlROry2sJZ3Qvr/
// SIG // PM/h2uKJ+m5CAJlbFt0JZDjiUvvfjvqToz27h49uuIfJ
// SIG // 0GBPz5yCkW2RG3IQs9hDfFlKYF3GsFXQJ9vy9r3yIMYi
// SIG // LJ5riy1s6ngEyUvBcAnnth2vmowGP3hw+nbu0iQUdrKu
// SIG // ICiDHKnwSJI/ooX3g8rFUdCVIAN50le8E7VOuLRsVh9T
// SIG // HhW7zzA//TsBzV9yaPfK85lmM6hdIo8dbsraZdIrHCSs
// SIG // n3ypEIqF4m0uXEr9Sbl7QLFTxt9HubMjTiJHHNPBuUl2
// SIG // QnLOkIYOJPXCPLkJNj+oU1xW/l9hAgMBAAGjggEJMIIB
// SIG // BTAdBgNVHQ4EFgQUWygas811DWM9/Zn1mxUCSBrLpqww
// SIG // HwYDVR0jBBgwFoAUIzT42VJGcArtQPt2+7MrsMM1sw8w
// SIG // VAYDVR0fBE0wSzBJoEegRYZDaHR0cDovL2NybC5taWNy
// SIG // b3NvZnQuY29tL3BraS9jcmwvcHJvZHVjdHMvTWljcm9z
// SIG // b2Z0VGltZVN0YW1wUENBLmNybDBYBggrBgEFBQcBAQRM
// SIG // MEowSAYIKwYBBQUHMAKGPGh0dHA6Ly93d3cubWljcm9z
// SIG // b2Z0LmNvbS9wa2kvY2VydHMvTWljcm9zb2Z0VGltZVN0
// SIG // YW1wUENBLmNydDATBgNVHSUEDDAKBggrBgEFBQcDCDAN
// SIG // BgkqhkiG9w0BAQUFAAOCAQEAevAN9EVsNJYOd/DiwEIF
// SIG // YfeI03r9iNWn9fd/8gj21f3LynR82wmp39YVB5m/0D6H
// SIG // hGJ7wgaOyoto4j3fnlrFjLKpXP5ZYib11/l4tm60CpBl
// SIG // ZulRCPF8yaO3BDdGxeeCPihc709xpOexJVrlQ1QzCH+k
// SIG // sFUt0YJwSBEgDSaBDu8GJXSrhcPDjOIUX+gFVI+6homq
// SIG // lq6UYiX5r2mICgyxUcQJ77iAfFOQebvpj9BI8GLImfFl
// SIG // NDv3zrX7Zpi5olmZXT6VnxS/NbT7mHIkKQzzugR6gjn7
// SIG // Rs3x4LIWvH0g+Jw5FSWhJi3Wi4G9xr2wnVT+RwtfLU4q
// SIG // 9IfqtQ+1t+2SKTCCBOwwggPUoAMCAQICEzMAAADKbNUy
// SIG // EjXE4VUAAQAAAMowDQYJKoZIhvcNAQEFBQAweTELMAkG
// SIG // A1UEBhMCVVMxEzARBgNVBAgTCldhc2hpbmd0b24xEDAO
// SIG // BgNVBAcTB1JlZG1vbmQxHjAcBgNVBAoTFU1pY3Jvc29m
// SIG // dCBDb3Jwb3JhdGlvbjEjMCEGA1UEAxMaTWljcm9zb2Z0
// SIG // IENvZGUgU2lnbmluZyBQQ0EwHhcNMTQwNDIyMTczOTAw
// SIG // WhcNMTUwNzIyMTczOTAwWjCBgzELMAkGA1UEBhMCVVMx
// SIG // EzARBgNVBAgTCldhc2hpbmd0b24xEDAOBgNVBAcTB1Jl
// SIG // ZG1vbmQxHjAcBgNVBAoTFU1pY3Jvc29mdCBDb3Jwb3Jh
// SIG // dGlvbjENMAsGA1UECxMETU9QUjEeMBwGA1UEAxMVTWlj
// SIG // cm9zb2Z0IENvcnBvcmF0aW9uMIIBIjANBgkqhkiG9w0B
// SIG // AQEFAAOCAQ8AMIIBCgKCAQEAlnFd7QZG+oTLnVu3Rsew
// SIG // 4bQROQOtsRVzYJzrp7ZuGjw//2XjNPGmpSFeVplsWOSS
// SIG // oQpcwtPcUi8MZZogYUBTMZxsjyF9uvn+E1BSYJU6W7lY
// SIG // pXRhQamU4K0mTkyhl3BJJ158Z8pPHnGERrwdS7biD8XG
// SIG // J8kH5noKpRcAGUxwRTgtgbRQqsVn0fp5vMXMoXKb9CU0
// SIG // mPhU3xI5OBIvpGulmn7HYtHcz+09NPi53zUwuux5Mqnh
// SIG // qaxVTUx/TFbDEwt28Qf5zEes+4jVUqUeKPo9Lc/PhJiG
// SIG // cWURz4XJCUSG4W/nsfysQESlqYsjP4JJndWWWVATWRhz
// SIG // /0MMrSvUfzBAZwIDAQABo4IBYDCCAVwwEwYDVR0lBAww
// SIG // CgYIKwYBBQUHAwMwHQYDVR0OBBYEFB9e4l1QjVaGvko8
// SIG // zwTop4e1y7+DMFEGA1UdEQRKMEikRjBEMQ0wCwYDVQQL
// SIG // EwRNT1BSMTMwMQYDVQQFEyozMTU5NStiNDIxOGYxMy02
// SIG // ZmNhLTQ5MGYtOWM0Ny0zZmM1NTdkZmM0NDAwHwYDVR0j
// SIG // BBgwFoAUyxHoytK0FlgByTcuMxYWuUyaCh8wVgYDVR0f
// SIG // BE8wTTBLoEmgR4ZFaHR0cDovL2NybC5taWNyb3NvZnQu
// SIG // Y29tL3BraS9jcmwvcHJvZHVjdHMvTWljQ29kU2lnUENB
// SIG // XzA4LTMxLTIwMTAuY3JsMFoGCCsGAQUFBwEBBE4wTDBK
// SIG // BggrBgEFBQcwAoY+aHR0cDovL3d3dy5taWNyb3NvZnQu
// SIG // Y29tL3BraS9jZXJ0cy9NaWNDb2RTaWdQQ0FfMDgtMzEt
// SIG // MjAxMC5jcnQwDQYJKoZIhvcNAQEFBQADggEBAHdc69eR
// SIG // Pc29e4PZhamwQ51zfBfJD+0228e1LBte+1QFOoNxQIEJ
// SIG // ordxJl7WfbZsO8mqX10DGCodJ34H6cVlH7XPDbdUxyg4
// SIG // Wojne8EZtlYyuuLMy5Pbr24PXUT11LDvG9VOwa8O7yCb
// SIG // 8uH+J13oxf9h9hnSKAoind/NcIKeGHLYI8x6LEPu/+rA
// SIG // 4OYdqp6XMwBSbwe404hs3qQGNafCU4ZlEXcJjzVZudiG
// SIG // qAD++DF9LPSMBZ3AwdV3cmzpTVkmg/HCsohXkzUAfFAr
// SIG // vFn8/hwpOILT3lKXRSkYTpZbnbpfG6PxJ1DqB5XobTQN
// SIG // OFfcNyg1lTo4nNTtaoVdDiIRXnswggW8MIIDpKADAgEC
// SIG // AgphMyYaAAAAAAAxMA0GCSqGSIb3DQEBBQUAMF8xEzAR
// SIG // BgoJkiaJk/IsZAEZFgNjb20xGTAXBgoJkiaJk/IsZAEZ
// SIG // FgltaWNyb3NvZnQxLTArBgNVBAMTJE1pY3Jvc29mdCBS
// SIG // b290IENlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0xMDA4
// SIG // MzEyMjE5MzJaFw0yMDA4MzEyMjI5MzJaMHkxCzAJBgNV
// SIG // BAYTAlVTMRMwEQYDVQQIEwpXYXNoaW5ndG9uMRAwDgYD
// SIG // VQQHEwdSZWRtb25kMR4wHAYDVQQKExVNaWNyb3NvZnQg
// SIG // Q29ycG9yYXRpb24xIzAhBgNVBAMTGk1pY3Jvc29mdCBD
// SIG // b2RlIFNpZ25pbmcgUENBMIIBIjANBgkqhkiG9w0BAQEF
// SIG // AAOCAQ8AMIIBCgKCAQEAsnJZXBkwZL8dmmAgIEKZdlNs
// SIG // PhvWb8zL8epr/pcWEODfOnSDGrcvoDLs/97CQk4j1XIA
// SIG // 2zVXConKriBJ9PBorE1LjaW9eUtxm0cH2v0l3511iM+q
// SIG // c0R/14Hb873yNqTJXEXcr6094CholxqnpXJzVvEXlOT9
// SIG // NZRyoNZ2Xx53RYOFOBbQc1sFumdSjaWyaS/aGQv+knQp
// SIG // 4nYvVN0UMFn40o1i/cvJX0YxULknE+RAMM9yKRAoIsc3
// SIG // Tj2gMj2QzaE4BoVcTlaCKCoFMrdL109j59ItYvFFPees
// SIG // CAD2RqGe0VuMJlPoeqpK8kbPNzw4nrR3XKUXno3LEY9W
// SIG // PMGsCV8D0wIDAQABo4IBXjCCAVowDwYDVR0TAQH/BAUw
// SIG // AwEB/zAdBgNVHQ4EFgQUyxHoytK0FlgByTcuMxYWuUya
// SIG // Ch8wCwYDVR0PBAQDAgGGMBIGCSsGAQQBgjcVAQQFAgMB
// SIG // AAEwIwYJKwYBBAGCNxUCBBYEFP3RMU7TJoqV4ZhgO6gx
// SIG // b6Y8vNgtMBkGCSsGAQQBgjcUAgQMHgoAUwB1AGIAQwBB
// SIG // MB8GA1UdIwQYMBaAFA6sgmBAVieX5SUT/CrhClOVWeSk
// SIG // MFAGA1UdHwRJMEcwRaBDoEGGP2h0dHA6Ly9jcmwubWlj
// SIG // cm9zb2Z0LmNvbS9wa2kvY3JsL3Byb2R1Y3RzL21pY3Jv
// SIG // c29mdHJvb3RjZXJ0LmNybDBUBggrBgEFBQcBAQRIMEYw
// SIG // RAYIKwYBBQUHMAKGOGh0dHA6Ly93d3cubWljcm9zb2Z0
// SIG // LmNvbS9wa2kvY2VydHMvTWljcm9zb2Z0Um9vdENlcnQu
// SIG // Y3J0MA0GCSqGSIb3DQEBBQUAA4ICAQBZOT5/Jkav629A
// SIG // sTK1ausOL26oSffrX3XtTDst10OtC/7L6S0xoyPMfFCY
// SIG // gCFdrD0vTLqiqFac43C7uLT4ebVJcvc+6kF/yuEMF2nL
// SIG // pZwgLfoLUMRWzS3jStK8cOeoDaIDpVbguIpLV/KVQpzx
// SIG // 8+/u44YfNDy4VprwUyOFKqSCHJPilAcd8uJO+IyhyugT
// SIG // pZFOyBvSj3KVKnFtmxr4HPBT1mfMIv9cHc2ijL0nsnlj
// SIG // VkSiUc356aNYVt2bAkVEL1/02q7UgjJu/KSVE+Traeep
// SIG // oiy+yCsQDmWOmdv1ovoSJgllOJTxeh9Ku9HhVujQeJYY
// SIG // XMk1Fl/dkx1Jji2+rTREHO4QFRoAXd01WyHOmMcJ7oUO
// SIG // jE9tDhNOPXwpSJxy0fNsysHscKNXkld9lI2gG0gDWvfP
// SIG // o2cKdKU27S0vF8jmcjcS9G+xPGeC+VKyjTMWZR4Oit0Q
// SIG // 3mT0b85G1NMX6XnEBLTT+yzfH4qerAr7EydAreT54al/
// SIG // RrsHYEdlYEBOsELsTu2zdnnYCjQJbRyAMR/iDlTd5aH7
// SIG // 5UcQrWSY/1AWLny/BSF64pVBJ2nDk4+VyY3YmyGuDVyc
// SIG // 8KKuhmiDDGotu3ZrAB2WrfIWe/YWgyS5iM9qqEcxL5rc
// SIG // 43E91wB+YkfRzojJuBj6DnKNwaM9rwJAav9pm5biEKgQ
// SIG // tDdQCNbDPTCCBgcwggPvoAMCAQICCmEWaDQAAAAAABww
// SIG // DQYJKoZIhvcNAQEFBQAwXzETMBEGCgmSJomT8ixkARkW
// SIG // A2NvbTEZMBcGCgmSJomT8ixkARkWCW1pY3Jvc29mdDEt
// SIG // MCsGA1UEAxMkTWljcm9zb2Z0IFJvb3QgQ2VydGlmaWNh
// SIG // dGUgQXV0aG9yaXR5MB4XDTA3MDQwMzEyNTMwOVoXDTIx
// SIG // MDQwMzEzMDMwOVowdzELMAkGA1UEBhMCVVMxEzARBgNV
// SIG // BAgTCldhc2hpbmd0b24xEDAOBgNVBAcTB1JlZG1vbmQx
// SIG // HjAcBgNVBAoTFU1pY3Jvc29mdCBDb3Jwb3JhdGlvbjEh
// SIG // MB8GA1UEAxMYTWljcm9zb2Z0IFRpbWUtU3RhbXAgUENB
// SIG // MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
// SIG // n6Fssd/bSJIqfGsuGeG94uPFmVEjUK3O3RhOJA/u0afR
// SIG // TK10MCAR6wfVVJUVSZQbQpKumFwwJtoAa+h7veyJBw/3
// SIG // DgSY8InMH8szJIed8vRnHCz8e+eIHernTqOhwSNTyo36
// SIG // Rc8J0F6v0LBCBKL5pmyTZ9co3EZTsIbQ5ShGLieshk9V
// SIG // UgzkAyz7apCQMG6H81kwnfp+1pez6CGXfvjSE/MIt1Nt
// SIG // UrRFkJ9IAEpHZhEnKWaol+TTBoFKovmEpxFHFAmCn4Tt
// SIG // VXj+AZodUAiFABAwRu233iNGu8QtVJ+vHnhBMXfMm987
// SIG // g5OhYQK1HQ2x/PebsgHOIktU//kFw8IgCwIDAQABo4IB
// SIG // qzCCAacwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQU
// SIG // IzT42VJGcArtQPt2+7MrsMM1sw8wCwYDVR0PBAQDAgGG
// SIG // MBAGCSsGAQQBgjcVAQQDAgEAMIGYBgNVHSMEgZAwgY2A
// SIG // FA6sgmBAVieX5SUT/CrhClOVWeSkoWOkYTBfMRMwEQYK
// SIG // CZImiZPyLGQBGRYDY29tMRkwFwYKCZImiZPyLGQBGRYJ
// SIG // bWljcm9zb2Z0MS0wKwYDVQQDEyRNaWNyb3NvZnQgUm9v
// SIG // dCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHmCEHmtFqFKoKWt
// SIG // THNY9AcTLmUwUAYDVR0fBEkwRzBFoEOgQYY/aHR0cDov
// SIG // L2NybC5taWNyb3NvZnQuY29tL3BraS9jcmwvcHJvZHVj
// SIG // dHMvbWljcm9zb2Z0cm9vdGNlcnQuY3JsMFQGCCsGAQUF
// SIG // BwEBBEgwRjBEBggrBgEFBQcwAoY4aHR0cDovL3d3dy5t
// SIG // aWNyb3NvZnQuY29tL3BraS9jZXJ0cy9NaWNyb3NvZnRS
// SIG // b290Q2VydC5jcnQwEwYDVR0lBAwwCgYIKwYBBQUHAwgw
// SIG // DQYJKoZIhvcNAQEFBQADggIBABCXisNcA0Q23em0rXfb
// SIG // znlRTQGxLnRxW20ME6vOvnuPuC7UEqKMbWK4VwLLTiAT
// SIG // UJndekDiV7uvWJoc4R0Bhqy7ePKL0Ow7Ae7ivo8KBciN
// SIG // SOLwUxXdT6uS5OeNatWAweaU8gYvhQPpkSokInD79vzk
// SIG // eJkuDfcH4nC8GE6djmsKcpW4oTmcZy3FUQ7qYlw/FpiL
// SIG // ID/iBxoy+cwxSnYxPStyC8jqcD3/hQoT38IKYY7w17gX
// SIG // 606Lf8U1K16jv+u8fQtCe9RTciHuMMq7eGVcWwEXChQO
// SIG // 0toUmPU8uWZYsy0v5/mFhsxRVuidcJRsrDlM1PZ5v6oY
// SIG // emIp76KbKTQGdxpiyT0ebR+C8AvHLLvPQ7Pl+ex9teOk
// SIG // qHQ1uE7FcSMSJnYLPFKMcVpGQxS8s7OwTWfIn0L/gHkh
// SIG // gJ4VMGboQhJeGsieIiHQQ+kr6bv0SMws1NgygEwmKkgk
// SIG // X1rqVu+m3pmdyjpvvYEndAYR7nYhv5uCwSdUtrFqPYmh
// SIG // dmG0bqETpr+qR/ASb/2KMmyy/t9RyIwjyWa9nR2HEmQC
// SIG // PS2vWY+45CHltbDKY7R4VAXUQS5QrJSwpXirs6CWdRrZ
// SIG // kocTdSIvMqgIbqBbjCW/oO+EyiHW6x5PyZruSeD3AWVv
// SIG // iQt9yGnI5m7qp5fOMSn/DsVbXNhNG6HY+i+ePy5VFmvJ
// SIG // E6P9MYIEtzCCBLMCAQEwgZAweTELMAkGA1UEBhMCVVMx
// SIG // EzARBgNVBAgTCldhc2hpbmd0b24xEDAOBgNVBAcTB1Jl
// SIG // ZG1vbmQxHjAcBgNVBAoTFU1pY3Jvc29mdCBDb3Jwb3Jh
// SIG // dGlvbjEjMCEGA1UEAxMaTWljcm9zb2Z0IENvZGUgU2ln
// SIG // bmluZyBQQ0ECEzMAAADKbNUyEjXE4VUAAQAAAMowCQYF
// SIG // Kw4DAhoFAKCB0DAZBgkqhkiG9w0BCQMxDAYKKwYBBAGC
// SIG // NwIBBDAcBgorBgEEAYI3AgELMQ4wDAYKKwYBBAGCNwIB
// SIG // FTAjBgkqhkiG9w0BCQQxFgQU7tRkbav3zN8nLoO+X4Mk
// SIG // /VTLZ5MwcAYKKwYBBAGCNwIBDDFiMGCgRoBEAFQARgBT
// SIG // AC4AVwBvAHIAawBJAHQAZQBtAFQAcgBhAGMAawBpAG4A
// SIG // ZwAuAEMAbwBuAHQAcgBvAGwAcwBfADIALgBqAHOhFoAU
// SIG // aHR0cDovL21pY3Jvc29mdC5jb20wDQYJKoZIhvcNAQEB
// SIG // BQAEggEADbm5Uo6ByyOwfuf+ZXvFPT6xMQ+hlOQUip6t
// SIG // F5/OfSLYPpkXw9Xputqd09m8AmnlHPDIkW5vi5ofhGvR
// SIG // XAi6jjowSiT7+mREOldrkTG3dhsuUOmkwqlv6IxvFDoa
// SIG // FAMiIPtTBelC3QdnGUPnC5DKPULzBIwOdPVAO/MtzUcF
// SIG // QixKZICST0JAQLU+DFdi9bnUuEfXdM/CojTwX0/x3vJU
// SIG // dgHDnZ4+VLba4+Fj3RoGLGFez0fKrlAhv8lWFA2+5Ox1
// SIG // eXAnsNB9TxBMu4EDnm7S6hbDkFcSnDU4eGpG/yNXxS1I
// SIG // WJzn6OOzLY9ezHbGgEr8F1gfSVyHaVH2WyR2RCB9G6GC
// SIG // AigwggIkBgkqhkiG9w0BCQYxggIVMIICEQIBATCBjjB3
// SIG // MQswCQYDVQQGEwJVUzETMBEGA1UECBMKV2FzaGluZ3Rv
// SIG // bjEQMA4GA1UEBxMHUmVkbW9uZDEeMBwGA1UEChMVTWlj
// SIG // cm9zb2Z0IENvcnBvcmF0aW9uMSEwHwYDVQQDExhNaWNy
// SIG // b3NvZnQgVGltZS1TdGFtcCBQQ0ECEzMAAABZ1nPNUY7w
// SIG // IsUAAAAAAFkwCQYFKw4DAhoFAKBdMBgGCSqGSIb3DQEJ
// SIG // AzELBgkqhkiG9w0BBwEwHAYJKoZIhvcNAQkFMQ8XDTE0
// SIG // MDcyMzA5MTAyMVowIwYJKoZIhvcNAQkEMRYEFJ4OxYaK
// SIG // 4Zm0Sy+qhw7kDFlPGHrtMA0GCSqGSIb3DQEBBQUABIIB
// SIG // AHbUrBWnGwqse3qhW6NhuYSWQPithuXyJHEFJLiZv2d0
// SIG // HTSDbL9/Il9pZ5nwhKvob+5fllyYmyo/e9k1FchBivC/
// SIG // cpWFrhpLm0c/iqGK+9uEQeg6HcprwXISyQZlBGxcP4db
// SIG // 1tkqSDG1/tA4MHXsNAcdVJqMFVBB7LUF3a5zX3Fv3jsc
// SIG // VJnZEQaUjvfug2o2vsFbjlrqVCOZbmaEpzuTWGGyRAhO
// SIG // g2G/Fsjqu2keoZhFBzsHU3WP0La0C9w2K5sIn4+3jr2t
// SIG // Y8c6yInpvz5yx4VvcGlNDSqL49rvHo8d0yoXYPwNSyYs
// SIG // 9MJCyLsqoGt3dlugrblu4VtSlqgymrf6b1k=
// SIG // End signature block
